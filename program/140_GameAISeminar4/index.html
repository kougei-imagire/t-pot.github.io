<head>
	<title>t-pot『Halo2 におけるHFSM(階層型有限状態マシン)』</title>
	<link rel="stylesheet" type="text/css" href="../if.css">
</head>
<meta http-equiv=Content-Type content="text/html; charset=shift_jis">
<body>


<div class="contents">
<center>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<h1>Halo2 におけるHFSM(階層型有限状態マシン)</h1><br>
<h3>〜 「ゲームAI連続セミナー第4回」メモ 〜</h3>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<!--<image src = "title.png">-->
<br>
<hr>
</center>
<div>


<h2>■はじめに</h2>


<p>
<a href="http://www6.plala.or.jp/mnagaku/">長久さん</a>や<a href="http://www.igda.jp/modules/xeblog/?user_id=910">三宅さん</a>がやっている<a href="
http://www.igda.jp/modules/eguide/event.php?eid=42">「ゲームAI連続セミナー」 の第４回</a>に行ってみました。
今回のテーマは、有限状態マシンです。<br>
今回も三宅さんとグループワークの２部構成です。
</p>

<p>
基本的にセミナー中にメモったものを起こし直したので、
聞き漏らしたり、勘違いしているところがあると思います。すいません。
</p>

<hr>

<h2>■最初</h2>

<p>
最初に、定番のゲームAIセミナーの概要紹介。<br>

<p>
ゲームAIセミナーの目的紹介<br>
　1.紹介、発表の場<br>
　2.討論<br>
　3.ゲーム業界で本当に必要なセミナーの形は？
</p>

<p>
ゲームAIの特徴：ゲームとAIが相互進化<br>
繰り返して、良いセミナーを模索する
</p>
<p>
今回の改善点<br>
　設定を限定的に<br>
　事前公開が良かったので、みんな原論文も読んでね<br>
　ボランティア随時募集中
</p>

<hr>

<h2>■講義</h2>

<h3>目的</h3>

<p>
ゲームAI現在の構造を理解<br>
　FSMの話が多いがそれだけではない。
</p>
<p>
ゲームの進化に対応して、ゲームAIは進化してる？<br>
　Halo(2)は、ゲーム世界の複雑さに向き合ってAIを製作した
</p>

<hr>

<h3>FSM</h3>

<p>
　有限個の状態が遷移条件で結ばれている<br>
　　今回は、状態によって出力が変化するムーア型を扱う<br>
　　（入力が直接出力に関与することがない）<br>
　ゲームAIでは、意思決定に状態を使用する。<br>
　　イベントによって内部状態が変化<br>
　例<br>
　　パックマンの敵AIでは、「追う」、「逃げる」、「死ぬ」、「復活」の状態を遷移<br>
　　　（実際にこう実装されているというわけではない）<br>
　　Quake<br>
　　　ミサイルについて、発射状態、移動、爆発、死などの状態が使われている<br>
　　トレジャーハンター<br>
　　　宝箱を追う状態の中に別のFSMがある（階層型）
</p>
<p>
階層型FDM(HFSM)<br>
　同じ状態の遷移が実はまとめられる場合がある<br>
　　講演の例ではないが：ゲームのセーブでは、常にメモリカードが抜かれる可能性がある
</p>
<p>
DAG形式のHFSM<br>
　一方向に再送かされて、ツリーの形式になっている。<br>
　例：Quake の敵<br>
　　攻撃状態になったら、前進攻撃やミサイル攻撃などの複数の細かな状態を取る<br>
　Halo2 も同様に階層化されている。
</p>
<p>
FSMの注意点<br>
　パターン化しやすい->ランダム化<br>
　状態遷移の振動がおきやすい->条件を変えたりファジーなFSM(FuSM)
</p>

<hr>

<h3>Halo AI</h3>
<p>
世界はAIにとって十分複雑<br>
　常識的（基本的）なことが分からない<br>
　　空は青い、地球は丸い…<br>
　たくさん覚えさせれば良いがデータベースが巨大になる<br>
　でも、本当に使えない？<br>
　　ゲームAIに必要な常識は少ない<br>
　　行動レベルに関して、常識に基づく思考をゲームAIに与える<br>
　　どうやって？<br>
　　　1)コードを書く(Halo)<br>
　　　2)全キャラクター共通の柔軟なシステムを作る(Halo2)<br>
　　ただ、Halo と Halo2 の違いは分かりにくい<br>
　　　Halo2 では、世界を「解釈」するように見せている
</p>
<p>
特徴<br>
　敵は、大中小のクリーチャー（自分は人間）<br>
　知性を持つ<br>
　　敵はプレイヤーができることはできる。<br>
　　意思を明確にする<br>
　　種族ごとの特徴あり<br>
　　グループの戦略的な目的を持つ<br>
　いいリアクションを返す<br>
　　良いレスポンス<br>
　　驚きなどの感情<br>
　　チートっぽく見えない馬鹿っぽさ<br>
　　意外な行動を起こす<br>
　　　窮鼠猫を噛む<br>
　予測不可能性を持つ<br>
　　毎回やるごとに違うことを行う<br>
　　ただし、ランダム性は使わない<br>
　　　プレイヤーの動きに反射的に答える<br>
　　　プレイヤーの動きをアナログで所得
</p>
<p>
知的なAI<br>
　プレイヤーから分からない状態は無くす<br>
　プレイヤーに意思を伝える<br>
　　驚きの声などの演出<br>
　　こそこそとした動き<br>
　AIの意識を視線などから分かるようにする<br>
　プレイヤーに対する対話
</p>
<p>
インタラクティブ性<br>
　固体ごとに記憶を保持<br>
　　情報量が多くなりすぎるので、基本情報だけ保持<br>
　　オブジェクトに関しては周辺のものだけ
</p>
<p>
予測可能性<br>
　面白い行動が自然に出てくるように<br>
　　最初はファジー制御だったが断念<br>
　　次にイベントに反射して行動<br>
　　結局キャラクタが世界を認識して動かす<br>
　　　チーム制御は必要なかった
</p>
<p>
アーキテクチャ<br>
　状態を所得して、それらを解析してイベント生成<br>
　イベントを意思決定してアクションを起こす
</p>
<p>
意思決定<br>
　イベントからの状態と敵の行動に伴うFSMからアクションを選択<br>
　アクション選択ロジックは、敵ごとに簡単なコードで実装<br>
　　アクション選択ロジックで、キャラごとのカスタマイズ
</p>
<p>
全体<br>
　ある程度全体的な行動<br>
　レベルデザイナーが戦闘の全体的な流れを制御<br>
　　チームごとに使ってほしい場所をグループ分け<br>
　　メンバーと出撃エリアも決定<br>
　　敵の単純な制御はロジックで、複雑な制御はスクリプト
</p>
<p>
位置取り<br>
　人間の射線がなるべく通っていないところに移動<br>
　レイキャストの負荷が60%(残りはパス検索と意思決定)
</p>
<p>
演出<br>
　見方や敵からの会話<br>
　　イベントに関係があったり、近くのキャラと会話
</p>
<p>
まとめ<br>
　コンセプトが考え抜かれている<br>
　試しながら改善<br>
　プログラマが仕組みを作って、デザイナに制御を任せる
</p>

<hr>

<h3>Halo2</h3>
<p>
コンセプト<br>
　柔軟な拡張性を持たせる<br>
　　行動の種類<br>
　　　飛ぶ、隠れる<br>
　　キャラクタの種類<br>
　　演出<br>
　　　ストーリーに絡んだ行動
</p>
<p>
思考<br>
　単純なゲームならFSMでOKだが、複雑になると遷移条件などが難しい<br>
　HFSM の振る舞いツリーによる意思決定<br>
　　直感的、モジュールに分解可、スケーラブル<br>
　　ただし、単純ではなく、デバッグが難しい。また、メモリも取る<br>
　ノード選択<br>
　　子ノードが競い合ってノードを選択（親が与えるわけではない）<br>
　　バイナリテスト（今、行動が取れるかどうか）と選択アルゴリズム<br>
　　選択アルゴリズムは沢山ある<br>
　　　振る舞いの順序を規定できる（常識を決められる）<br>
　　優先度の制御には、状態でトリガーをもたせる仕組みを採用<br>
　　上位のレベルを遷移させる制御もあり<br>
　　振る舞いの実行可能性をビットのテーブルにして高速化<br>
　　キャラクタごとの制御には、最初に沢山の状態を追加するのではなく、キャラクタごとに遷移状態を追加する<br>
　　めったに起きないイベントの判定は割り込みができるシステムで対処<br>
　　黒板による協調動作（あまり重要ではない…）
</p>
<p>
記憶<br>
　ツリーが大きくなるとメモリが圧迫される<br>
　　ツリー自身は静的なツリーにして、キャラクタごとにツリーに状態を追加して利用<br>
　　問題点としては、行動の履歴を残すのは難しいので、専用のメモリプールを用意<br>
　　　永久記憶、短期記憶、ターゲットの認識、ターゲットの振る舞いを保存
</p>
<p>
移動<br>
　AI に何をさせたいかによって適切なデータ構造を用意する必要がある<br>
　ナビゲーションメッシュ<br>
　　いろいろなノウハウがある。<br>
　　　あまり鋭い三角形は良くない<br>
　ポジション<br>
　　戦略的位置をプレイグラウンドとしてグループ化<br>
　　　その間は（処理の重い）パス検索しなくても移動できないようにする。<br>
　まずプレイグラウンドで移動して、それ以外に行くときはパス検索
</p>
<p>
デザイナーコントロール<br>
　静的なキャラクタ定義<br>
　　継承構造によるパラメータ定義<br>
　　　効率よく沢山のキャラクタを作成<br>
　　ツールによる振る舞いのマスク（スタイル）<br>
　動的なスクリプト制御<br>
　　メンバーとエリアを分離してグループのエリア間移動を実装<br>
　　　"Order"という概念を入れて移動の制御（前進、突撃）<br>
　　スタイルと組み合わせる（特徴的）<br>
　　　その場でできる行動を選択されたスタイルをエリアごと容易
</p>
<p>
Q. スタイルがエリアごとあるとデータが増えたりデザインが大変になる気がするけど（今給黎）<br>
A. 確かに、テンプレートを用意しているのかも。キャラのスタイルの制限もあるので、下手すると何もできないキャラが出てくる（腕の見せ所といえば見せ所）
</p>


<hr>

<h3>FSM からゲームAIを作る</h3>

<p>
AI の内面の描写<br>
振る舞いによって、個性付けられる。<br>
世界の複雑さがあり、その解決で賢くなる<br>
FSM は、世界をAIの関係性を表現するグラフ<br>
<br>
作り方<br>
　シチュエーションから、まず、FSM を洗い出してみる。<br>
　分けられるものを分けて階層化していく
</p>

<hr>
<h2>■グループワーク</h2>

<h3>テーマ</h3>
<p>
状態遷移リストを作る<br>
　出てきたリストをつなげてFSMにする<br>
　「スムーズに進められるところまで落とし込んだ例を考えた」
</p>
<p>
シチュエーション：MGS2 A脚ポンプ室<br>
　カロリーメイトが２つある（どこか分からない）<br>
　カロリーメイトを探すかスネークを倒す
</p>
<p>
基本構造<br>
　索敵、追跡、警戒、リセット
</p>

<hr>

<h3>グループ４(私のいたグループ)</h3>
<p>
１０人：学生一人、あと各社（確か企画が２人）。<br>
<br>
特徴あるAIを追加<br>
　居眠りをする（居眠りを見つけたら起こす）<br>
　臆病<br>
　小銭を拾う<br>
　うそをつく
</p>

<h3>グループ３</h3>
<p>
最初から物を考えたので時間が無かった<br>
さくさく進んでいた（三宅）<br>
綺麗（字も綺麗）（長久）
</p>

<h3>グループ？</h3>
<p>
索敵に遊びを入れて、警戒になったら本気<br>
巡回中にどうサボるかを考えた（そのとき仲間にみつかったら殺される）<br>
死体を見つけたら警戒態勢に入るとかあったと思う<br>
1vs1だと負けるので、なるべく仲間と一緒に攻撃しましょう。<br>
反撃の時は仲間を呼ぶ<br>
警戒中は出入り口を閉める必要が歩けど、４人だと倒されるので、６人ぐらい？
</p>

<h3>グループ長久</h3>
<p>
上司と部下（仲が悪い）<br>
　部下はサボりたいけど、手柄はほしい<br>
　上司はまじめ<br>
上司は巡回。部下がサボろうとしたら説教。<br>
部下は巡回よりもさぼりが重要<br>
サボりでも、ある程度大丈夫になったら仲間を呼んで一緒にサボる<br>
上司が階段を転げ落ちたイベントでは、介護する
</p>

<h3>グループ７</h3>
<p>
長久さんのグループと似たような感じ
</p>

<hr>

<h2>■まとめ（長久さん）</h2>

<p>
FSMでうれしいこと<br>
　仕様書が箇条書きだと<br>
　　->膨大な箇条書きになる<br>
　　->不整合があっても分からない<br>
　　->だいたい作ってから問題発見<br>
　　->あいつの仕様書つかえねえなー<br>
　仕様書がフローチャートっぽくなると<br>
　　->表現力が足りない(例外処理は難しい)<br>
　　->表現しきれていない部分に不具合ができやすい<br>
　　->だいたい作ってから問題発見<br>
　　->...<br>
　仕様書が UML (のステートチャートによるFSM) だと<br>
　　->キャラの挙動がすべて連結されている<br>
　　->網羅的に書きやすい。追加しやすい。<br>
　　　　十分な表現能力で細かいところまで書ける<br>
　　　　悪いところがあると図にならない<br>
　　　　そもまま実装できる<br>
　　->GJ
</p>

<p>
日本語（企画）とコンピュータ（プログラマ）の思考に差がある<br>
それが UML 化されると<br>
　論理的思考のサポートと見える化ができる<br>
　実装しやすく、レビューもしやすい<br>
　技術者は家に帰ったり寝ることができる<br>
　のではなくて<br>
　重要な作業に時間を割くことができる<br>
　みんな幸せ<br>
もっと嬉しい未来の話<br>
　モデル検査にかけられる<br>
　　コンピュータサイエンスの形式手法の１つ（ツールもあるCSKとか）<br>
　　FSM で特定の条件の時に状態を取るかチェックできる<br>
　　デッドロックが起きているか調べられる<br>
　　ゲーム全体だと難しいが、AIなららんとかなるんじゃない<br>
　定理証明にかけられる<br>
　　数式で書くとちゃんと動くことが分かる
</p>

<hr>

<h2>■さいごに</h2>

<p>
今回は、参加者のノリが悪かったように感じました。<br>
と、いうのは、ゲーム開発者ってFSMは、タスクシステムとして頻繁に使って慣れてるんですよねぇ…
</p>
<p>
グループワークの方は、みんなのネタが発散して、うまくまとまりませんでした。<br>
これは、反省点が多いなぁ…
</p>

</div>
<br CLEAR=ALL>
<br CLEAR=ALL>
<br CLEAR=ALL>
<center>
<hr>
<p><a href="../index.html">もどる</a></p>
<p><a href="mailto:imagire@gmail.com">imagire@gmail.com</a></p>
</center>

</body>
</html>
