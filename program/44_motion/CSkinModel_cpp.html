<HTML>
<HEAD>
<TITLE>CSkinModel.cpp</TITLE>
<meta name="GENERATOR" content="cpp2html 2.1 by Niisaka">
<meta http-equiv="Content-Type" content="text/html">
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFFF">
<PRE><FONT COLOR="#40F628">0001:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0002:</FONT> <FONT COLOR="#008000">//</FONT>
<FONT COLOR="#40F628">0003:</FONT> <FONT COLOR="#008000">// CSkinModel.cpp - スキンメッシュ管理クラス</FONT>
<FONT COLOR="#40F628">0004:</FONT> <FONT COLOR="#008000">// </FONT>
<FONT COLOR="#40F628">0005:</FONT> <FONT COLOR="#008000">// Copyright (c) 2002 imagire (imagire@gmail.com)</FONT>
<FONT COLOR="#40F628">0006:</FONT> <FONT COLOR="#008000">// All Rights Reserved.</FONT>
<FONT COLOR="#40F628">0007:</FONT> <FONT COLOR="#008000">//</FONT>
<FONT COLOR="#40F628">0008:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0009:</FONT> <FONT COLOR="#0000FF">#define</FONT> STRICT
<FONT COLOR="#40F628">0010:</FONT> 
<FONT COLOR="#40F628">0011:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;windows.h&gt;
<FONT COLOR="#40F628">0012:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;mmsystem.h&gt;
<FONT COLOR="#40F628">0013:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;objbase.h&gt;
<FONT COLOR="#40F628">0014:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;malloc.h&gt;
<FONT COLOR="#40F628">0015:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;stdio.h&gt;
<FONT COLOR="#40F628">0016:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;d3d8.h&gt;
<FONT COLOR="#40F628">0017:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;d3dx8.h&gt;
<FONT COLOR="#40F628">0018:</FONT> <FONT COLOR="#0000FF">#include</FONT> "<FONT COLOR="#600000">rmxfguid.h</FONT>"
<FONT COLOR="#40F628">0019:</FONT> <FONT COLOR="#0000FF">#include</FONT> "<FONT COLOR="#600000">rmxftmpl.h</FONT>"
<FONT COLOR="#40F628">0020:</FONT> 
<FONT COLOR="#40F628">0021:</FONT> 
<FONT COLOR="#40F628">0022:</FONT> <FONT COLOR="#0000FF">#include</FONT> &lt;d3dx8.h&gt;
<FONT COLOR="#40F628">0023:</FONT> <FONT COLOR="#0000FF">#include</FONT> "<FONT COLOR="#600000">CSkinModel.h</FONT>"
<FONT COLOR="#40F628">0024:</FONT> 
<FONT COLOR="#40F628">0025:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0026:</FONT> <FONT COLOR="#008000">// 簡易マクロ</FONT>
<FONT COLOR="#40F628">0027:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0028:</FONT> <FONT COLOR="#0000FF">#define</FONT> RELEASE(o)  <FONT COLOR="#0000FF">if</FONT> (o){(o)-&gt;Release();(o)=NULL;}
<FONT COLOR="#40F628">0029:</FONT> <FONT COLOR="#0000FF">#define</FONT> DELETES(o)  <FONT COLOR="#0000FF">if</FONT> (o){<FONT COLOR="#0000FF">delete</FONT>[]   (o);(o)=NULL;}
<FONT COLOR="#40F628">0030:</FONT> 
<FONT COLOR="#40F628">0031:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0032:</FONT> <FONT COLOR="#008000">// シェーダー</FONT>
<FONT COLOR="#40F628">0033:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0034:</FONT> <FONT COLOR="#008000">// v0 = 頂点の位置</FONT>
<FONT COLOR="#40F628">0035:</FONT> <FONT COLOR="#008000">// v1 = 重み</FONT>
<FONT COLOR="#40F628">0036:</FONT> <FONT COLOR="#008000">// v2 = 重みのインデックス</FONT>
<FONT COLOR="#40F628">0037:</FONT> <FONT COLOR="#008000">// v3 = 法線</FONT>
<FONT COLOR="#40F628">0038:</FONT> <FONT COLOR="#008000">// v4 = テクスチャー座標</FONT>
<FONT COLOR="#40F628">0039:</FONT> <FONT COLOR="#008000">//------------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0040:</FONT> <FONT COLOR="#008000">// r0.w = Last blend weight</FONT>
<FONT COLOR="#40F628">0041:</FONT> <FONT COLOR="#008000">// r1 = 重みのインデックス</FONT>
<FONT COLOR="#40F628">0042:</FONT> <FONT COLOR="#008000">// r2 = 一時的な座標</FONT>
<FONT COLOR="#40F628">0043:</FONT> <FONT COLOR="#008000">// r3 = 一時的な法線</FONT>
<FONT COLOR="#40F628">0044:</FONT> <FONT COLOR="#008000">// r4 = カメラ空間での座標</FONT>
<FONT COLOR="#40F628">0045:</FONT> <FONT COLOR="#008000">// r5 = カメラ空間での法線</FONT>
<FONT COLOR="#40F628">0046:</FONT> <FONT COLOR="#008000">//------------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0047:</FONT> <FONT COLOR="#008000">// c9-c95 = 行列パレット</FONT>
<FONT COLOR="#40F628">0048:</FONT> <FONT COLOR="#008000">// c8     = 平行光源</FONT>
<FONT COLOR="#40F628">0049:</FONT> <FONT COLOR="#008000">// c7     = 環境光</FONT>
<FONT COLOR="#40F628">0050:</FONT> <FONT COLOR="#008000">// c2-c5  = 射影行列</FONT>
<FONT COLOR="#40F628">0051:</FONT> <FONT COLOR="#008000">// c1     = 光源方向</FONT>
<FONT COLOR="#40F628">0052:</FONT> <FONT COLOR="#008000">// c0     = {1, ライトのべき乗, 0, 1020.01};</FONT>
<FONT COLOR="#40F628">0053:</FONT> <FONT COLOR="#008000">//------------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0054:</FONT> <FONT COLOR="#008000">// oPos   = 位置</FONT>
<FONT COLOR="#40F628">0055:</FONT> <FONT COLOR="#008000">// oD0    = 平行光</FONT>
<FONT COLOR="#40F628">0056:</FONT> <FONT COLOR="#008000">// oD1    = すぺきゅらー</FONT>
<FONT COLOR="#40F628">0057:</FONT> <FONT COLOR="#008000">// oT0    = テクスチャー座標</FONT>
<FONT COLOR="#40F628">0058:</FONT> <FONT COLOR="#008000">//------------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0059:</FONT> 
<FONT COLOR="#40F628">0060:</FONT> <FONT COLOR="#0000FF">const</FONT> <FONT COLOR="#0000FF">char</FONT> VertexShader0[] = {
<FONT COLOR="#40F628">0061:</FONT> "<FONT COLOR="#600000">vs.1.1                            // シェーダ バージョン 1.1           \n</FONT>"\
<FONT COLOR="#40F628">0062:</FONT> "<FONT COLOR="#600000">mul r1,v2.zyxw,c0.wwww            // Geforce3 で UBYTE4 がないのを補う \n</FONT>"\
<FONT COLOR="#40F628">0063:</FONT> 
<FONT COLOR="#40F628">0064:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.x                     // 1 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0065:</FONT> "<FONT COLOR="#600000">m4x3 r4,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0066:</FONT> "<FONT COLOR="#600000">m3x3 r5,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0067:</FONT> 
<FONT COLOR="#40F628">0068:</FONT> "<FONT COLOR="#600000">mov r4.w,c0.x                     // 座標変換                          \n</FONT>"\
<FONT COLOR="#40F628">0069:</FONT> "<FONT COLOR="#600000">m4x4 oPos,r4,c2                                                        \n</FONT>"\
<FONT COLOR="#40F628">0070:</FONT> 
<FONT COLOR="#40F628">0071:</FONT> "<FONT COLOR="#600000">dp3 r5.w, r5, r5                  // 法線の規格化                      \n</FONT>"\
<FONT COLOR="#40F628">0072:</FONT> "<FONT COLOR="#600000">rsq r5.w, r5.w                                                         \n</FONT>"\
<FONT COLOR="#40F628">0073:</FONT> "<FONT COLOR="#600000">mul r5, r5, r5.w                                                       \n</FONT>"\
<FONT COLOR="#40F628">0074:</FONT> 
<FONT COLOR="#40F628">0075:</FONT> "<FONT COLOR="#600000">dp3 r1.x, r5, c1                  // ライティング                      \n</FONT>"\
<FONT COLOR="#40F628">0076:</FONT> "<FONT COLOR="#600000">lit r1, r1                        //                                   \n</FONT>"\
<FONT COLOR="#40F628">0077:</FONT> "<FONT COLOR="#600000">mul r0, r1.y, c8                  // 平行光源                          \n</FONT>"\
<FONT COLOR="#40F628">0078:</FONT> "<FONT COLOR="#600000">add r0, r0, c7                    //  +環境光                          \n</FONT>"\
<FONT COLOR="#40F628">0079:</FONT> "<FONT COLOR="#600000">min oD0, r0, c0.x                 // 1以下にクランプ                   \n</FONT>"\
<FONT COLOR="#40F628">0080:</FONT> "<FONT COLOR="#600000">mov oD1, c0.zzzz                  // すぺきゅらーの設定                \n</FONT>"\
<FONT COLOR="#40F628">0081:</FONT> 
<FONT COLOR="#40F628">0082:</FONT> "<FONT COLOR="#600000">mov oT0, v4                       // テクスチャー座標のコピー          </FONT>"
<FONT COLOR="#40F628">0083:</FONT> };
<FONT COLOR="#40F628">0084:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0085:</FONT> <FONT COLOR="#0000FF">const</FONT> <FONT COLOR="#0000FF">char</FONT> VertexShader1[] = {
<FONT COLOR="#40F628">0086:</FONT> "<FONT COLOR="#600000">vs.1.1                            // シェーダ バージョン 1.1           \n</FONT>"\
<FONT COLOR="#40F628">0087:</FONT> "<FONT COLOR="#600000">mul r1,v2.zyxw,c0.wwww            // Geforce3 で UBYTE4 がないのを補う \n</FONT>"\
<FONT COLOR="#40F628">0088:</FONT> 
<FONT COLOR="#40F628">0089:</FONT> "<FONT COLOR="#600000">dp3 r0.w,v1.xyz,c0.xzz            // 最後の係数はウェイトの合計が1から算出 \n</FONT>"\
<FONT COLOR="#40F628">0090:</FONT> "<FONT COLOR="#600000">add r0.w,-r0.w,c0.x                                                    \n</FONT>"\
<FONT COLOR="#40F628">0091:</FONT> 
<FONT COLOR="#40F628">0092:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.x                     // 1 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0093:</FONT> "<FONT COLOR="#600000">m4x3 r4,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0094:</FONT> "<FONT COLOR="#600000">m3x3 r5,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0095:</FONT> "<FONT COLOR="#600000">mul r4,r4,v1.xxxx                 // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0096:</FONT> "<FONT COLOR="#600000">mul r5,r5,v1.xxxx                                                      \n</FONT>"\
<FONT COLOR="#40F628">0097:</FONT> 
<FONT COLOR="#40F628">0098:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.y                     // 2 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0099:</FONT> "<FONT COLOR="#600000">m4x3 r2,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0100:</FONT> "<FONT COLOR="#600000">m3x3 r3,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0101:</FONT> "<FONT COLOR="#600000">mad r4,r2,r0.wwww,r4              // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0102:</FONT> "<FONT COLOR="#600000">mad r5,r3,r0.wwww,r5                                                   \n</FONT>"\
<FONT COLOR="#40F628">0103:</FONT> 
<FONT COLOR="#40F628">0104:</FONT> "<FONT COLOR="#600000">mov r4.w,c0.x                     // 座標変換                          \n</FONT>"\
<FONT COLOR="#40F628">0105:</FONT> "<FONT COLOR="#600000">m4x4 oPos,r4,c2                                                        \n</FONT>"\
<FONT COLOR="#40F628">0106:</FONT> 
<FONT COLOR="#40F628">0107:</FONT> "<FONT COLOR="#600000">dp3 r5.w, r5, r5                  // 法線の規格化                      \n</FONT>"\
<FONT COLOR="#40F628">0108:</FONT> "<FONT COLOR="#600000">rsq r5.w, r5.w                                                         \n</FONT>"\
<FONT COLOR="#40F628">0109:</FONT> "<FONT COLOR="#600000">mul r5, r5, r5.w                                                       \n</FONT>"\
<FONT COLOR="#40F628">0110:</FONT> 
<FONT COLOR="#40F628">0111:</FONT> "<FONT COLOR="#600000">dp3 r1.x, r5, c1                  // ライティング                      \n</FONT>"\
<FONT COLOR="#40F628">0112:</FONT> "<FONT COLOR="#600000">lit r1, r1                        //                                   \n</FONT>"\
<FONT COLOR="#40F628">0113:</FONT> "<FONT COLOR="#600000">mul r0, r1.y, c8                  // 平行光源                          \n</FONT>"\
<FONT COLOR="#40F628">0114:</FONT> "<FONT COLOR="#600000">add r0, r0, c7                    //  +環境光                          \n</FONT>"\
<FONT COLOR="#40F628">0115:</FONT> "<FONT COLOR="#600000">min oD0, r0, c0.x                 // 1以下にクランプ                   \n</FONT>"\
<FONT COLOR="#40F628">0116:</FONT> "<FONT COLOR="#600000">mov oD1, c0.zzzz                  // すぺきゅらーの設定                \n</FONT>"\
<FONT COLOR="#40F628">0117:</FONT> 
<FONT COLOR="#40F628">0118:</FONT> "<FONT COLOR="#600000">mov oT0, v4                       // テクスチャー座標のコピー          </FONT>"
<FONT COLOR="#40F628">0119:</FONT> };
<FONT COLOR="#40F628">0120:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0121:</FONT> <FONT COLOR="#0000FF">const</FONT> <FONT COLOR="#0000FF">char</FONT> VertexShader2[] = {
<FONT COLOR="#40F628">0122:</FONT> "<FONT COLOR="#600000">vs.1.1                            // シェーダ バージョン 1.1           \n</FONT>"\
<FONT COLOR="#40F628">0123:</FONT> "<FONT COLOR="#600000">mul r1,v2.zyxw,c0.wwww            // Geforce3 で UBYTE4 がないのを補う \n</FONT>"\
<FONT COLOR="#40F628">0124:</FONT> 
<FONT COLOR="#40F628">0125:</FONT> "<FONT COLOR="#600000">dp3 r0.w,v1.xyz,c0.xxz            // 最後の係数はウェイトの合計が1から算出 \n</FONT>"\
<FONT COLOR="#40F628">0126:</FONT> "<FONT COLOR="#600000">add r0.w,-r0.w,c0.x                                                    \n</FONT>"\
<FONT COLOR="#40F628">0127:</FONT> 
<FONT COLOR="#40F628">0128:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.x                     // 1 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0129:</FONT> "<FONT COLOR="#600000">m4x3 r4,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0130:</FONT> "<FONT COLOR="#600000">m3x3 r5,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0131:</FONT> "<FONT COLOR="#600000">mul r4,r4,v1.xxxx                 // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0132:</FONT> "<FONT COLOR="#600000">mul r5,r5,v1.xxxx                                                      \n</FONT>"\
<FONT COLOR="#40F628">0133:</FONT> 
<FONT COLOR="#40F628">0134:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.y                     // 2 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0135:</FONT> "<FONT COLOR="#600000">m4x3 r2,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0136:</FONT> "<FONT COLOR="#600000">m3x3 r3,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0137:</FONT> "<FONT COLOR="#600000">mad r4,r2,v1.yyyy,r4              // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0138:</FONT> "<FONT COLOR="#600000">mad r5,r3,v1.yyyy,r5                                                   \n</FONT>"\
<FONT COLOR="#40F628">0139:</FONT> 
<FONT COLOR="#40F628">0140:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.z                     // 3 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0141:</FONT> "<FONT COLOR="#600000">m4x3 r2,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0142:</FONT> "<FONT COLOR="#600000">m3x3 r3,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0143:</FONT> "<FONT COLOR="#600000">mad r4,r2,r0.wwww,r4              // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0144:</FONT> "<FONT COLOR="#600000">mad r5,r3,r0.wwww,r5                                                   \n</FONT>"\
<FONT COLOR="#40F628">0145:</FONT> 
<FONT COLOR="#40F628">0146:</FONT> "<FONT COLOR="#600000">mov r4.w,c0.x                     // 座標変換                          \n</FONT>"\
<FONT COLOR="#40F628">0147:</FONT> "<FONT COLOR="#600000">m4x4 oPos,r4,c2                                                        \n</FONT>"\
<FONT COLOR="#40F628">0148:</FONT> 
<FONT COLOR="#40F628">0149:</FONT> "<FONT COLOR="#600000">dp3 r5.w, r5, r5                  // 法線の規格化                      \n</FONT>"\
<FONT COLOR="#40F628">0150:</FONT> "<FONT COLOR="#600000">rsq r5.w, r5.w                                                         \n</FONT>"\
<FONT COLOR="#40F628">0151:</FONT> "<FONT COLOR="#600000">mul r5, r5, r5.w                                                       \n</FONT>"\
<FONT COLOR="#40F628">0152:</FONT> 
<FONT COLOR="#40F628">0153:</FONT> "<FONT COLOR="#600000">dp3 r1.x, r5, c1                  // ライティング                      \n</FONT>"\
<FONT COLOR="#40F628">0154:</FONT> "<FONT COLOR="#600000">lit r1, r1                        //                                   \n</FONT>"\
<FONT COLOR="#40F628">0155:</FONT> "<FONT COLOR="#600000">mul r0, r1.y, c8                  // 平行光源                          \n</FONT>"\
<FONT COLOR="#40F628">0156:</FONT> "<FONT COLOR="#600000">add r0, r0, c7                    //  +環境光                          \n</FONT>"\
<FONT COLOR="#40F628">0157:</FONT> "<FONT COLOR="#600000">min oD0, r0, c0.x                 // 1以下にクランプ                   \n</FONT>"\
<FONT COLOR="#40F628">0158:</FONT> "<FONT COLOR="#600000">mov oD1, c0.zzzz                  // すぺきゅらーの設定                \n</FONT>"\
<FONT COLOR="#40F628">0159:</FONT> 
<FONT COLOR="#40F628">0160:</FONT> "<FONT COLOR="#600000">mov oT0, v4                       // テクスチャー座標のコピー          </FONT>"
<FONT COLOR="#40F628">0161:</FONT> };
<FONT COLOR="#40F628">0162:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0163:</FONT> <FONT COLOR="#0000FF">const</FONT> <FONT COLOR="#0000FF">char</FONT> VertexShader3[] = {
<FONT COLOR="#40F628">0164:</FONT> "<FONT COLOR="#600000">vs.1.1                            // シェーダ バージョン 1.1           \n</FONT>"\
<FONT COLOR="#40F628">0165:</FONT> "<FONT COLOR="#600000">mul r1,v2.zyxw,c0.wwww            // Geforce3 で UBYTE4 がないのを補う \n</FONT>"\
<FONT COLOR="#40F628">0166:</FONT> 
<FONT COLOR="#40F628">0167:</FONT> "<FONT COLOR="#600000">dp3 r0.w,v1.xyz,c0.xxx            // 最後の係数はウェイトの合計が1から算出 \n</FONT>"\
<FONT COLOR="#40F628">0168:</FONT> "<FONT COLOR="#600000">add r0.w,-r0.w,c0.x                                                    \n</FONT>"\
<FONT COLOR="#40F628">0169:</FONT> 
<FONT COLOR="#40F628">0170:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.x                     // 1 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0171:</FONT> "<FONT COLOR="#600000">m4x3 r4,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0172:</FONT> "<FONT COLOR="#600000">m3x3 r5,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0173:</FONT> "<FONT COLOR="#600000">mul r4,r4,v1.xxxx                 // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0174:</FONT> "<FONT COLOR="#600000">mul r5,r5,v1.xxxx                                                      \n</FONT>"\
<FONT COLOR="#40F628">0175:</FONT> 
<FONT COLOR="#40F628">0176:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.y                     // 2 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0177:</FONT> "<FONT COLOR="#600000">m4x3 r2,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0178:</FONT> "<FONT COLOR="#600000">m3x3 r3,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0179:</FONT> "<FONT COLOR="#600000">mad r4,r2,v1.yyyy,r4              // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0180:</FONT> "<FONT COLOR="#600000">mad r5,r3,v1.yyyy,r5                                                   \n</FONT>"\
<FONT COLOR="#40F628">0181:</FONT> 
<FONT COLOR="#40F628">0182:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.z                     // 3 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0183:</FONT> "<FONT COLOR="#600000">m4x3 r2,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0184:</FONT> "<FONT COLOR="#600000">m3x3 r3,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0185:</FONT> "<FONT COLOR="#600000">mad r4,r2,v1.zzzz,r4              // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0186:</FONT> "<FONT COLOR="#600000">mad r5,r3,v1.zzzz,r5                                                   \n</FONT>"\
<FONT COLOR="#40F628">0187:</FONT> 
<FONT COLOR="#40F628">0188:</FONT> "<FONT COLOR="#600000">mov a0.x,r1.w                     // 4 つめの行列を設定                \n</FONT>"\
<FONT COLOR="#40F628">0189:</FONT> "<FONT COLOR="#600000">m4x3 r2,v0,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0190:</FONT> "<FONT COLOR="#600000">m3x3 r3,v3,c[a0.x + 9]                                                 \n</FONT>"\
<FONT COLOR="#40F628">0191:</FONT> "<FONT COLOR="#600000">mad r4,r2,r0.wwww,r4              // 係数をかけて合成する              \n</FONT>"\
<FONT COLOR="#40F628">0192:</FONT> "<FONT COLOR="#600000">mad r5,r3,r0.wwww,r5                                                   \n</FONT>"\
<FONT COLOR="#40F628">0193:</FONT> 
<FONT COLOR="#40F628">0194:</FONT> "<FONT COLOR="#600000">mov r4.w,c0.x                     // 座標変換                          \n</FONT>"\
<FONT COLOR="#40F628">0195:</FONT> "<FONT COLOR="#600000">m4x4 oPos,r4,c2                                                        \n</FONT>"\
<FONT COLOR="#40F628">0196:</FONT> 
<FONT COLOR="#40F628">0197:</FONT> "<FONT COLOR="#600000">dp3 r5.w, r5, r5                  // 法線の規格化                      \n</FONT>"\
<FONT COLOR="#40F628">0198:</FONT> "<FONT COLOR="#600000">rsq r5.w, r5.w                                                         \n</FONT>"\
<FONT COLOR="#40F628">0199:</FONT> "<FONT COLOR="#600000">mul r5, r5, r5.w                                                       \n</FONT>"\
<FONT COLOR="#40F628">0200:</FONT> 
<FONT COLOR="#40F628">0201:</FONT> "<FONT COLOR="#600000">dp3 r1.x, r5, c1                  // ライティング                      \n</FONT>"\
<FONT COLOR="#40F628">0202:</FONT> "<FONT COLOR="#600000">lit r1, r1                        //                                   \n</FONT>"\
<FONT COLOR="#40F628">0203:</FONT> "<FONT COLOR="#600000">mul r0, r1.y, c8                  // 平行光源                          \n</FONT>"\
<FONT COLOR="#40F628">0204:</FONT> "<FONT COLOR="#600000">add r0, r0, c7                    //  +環境光                          \n</FONT>"\
<FONT COLOR="#40F628">0205:</FONT> "<FONT COLOR="#600000">min oD0, r0, c0.x                 // 1以下にクランプ                   \n</FONT>"\
<FONT COLOR="#40F628">0206:</FONT> "<FONT COLOR="#600000">mov oD1, c0.zzzz                  // すぺきゅらーの設定                \n</FONT>"\
<FONT COLOR="#40F628">0207:</FONT> 
<FONT COLOR="#40F628">0208:</FONT> "<FONT COLOR="#600000">mov oT0, v4                       // テクスチャー座標のコピー          </FONT>"
<FONT COLOR="#40F628">0209:</FONT> };
<FONT COLOR="#40F628">0210:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0211:</FONT> 
<FONT COLOR="#40F628">0212:</FONT> 
<FONT COLOR="#40F628">0213:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0214:</FONT> SMeshContainer::SMeshContainer():
<FONT COLOR="#40F628">0215:</FONT>     pMesh(NULL),
<FONT COLOR="#40F628">0216:</FONT>     rgMaterials(NULL),
<FONT COLOR="#40F628">0217:</FONT>     pTextures(NULL),
<FONT COLOR="#40F628">0218:</FONT>     cpattr(0),
<FONT COLOR="#40F628">0219:</FONT>     iAttrSplit(0),
<FONT COLOR="#40F628">0220:</FONT>     cMaterials(0),
<FONT COLOR="#40F628">0221:</FONT>     pmcNext(NULL),
<FONT COLOR="#40F628">0222:</FONT>     szName(NULL),
<FONT COLOR="#40F628">0223:</FONT>     m_pSkinMesh(NULL),
<FONT COLOR="#40F628">0224:</FONT>     m_pAttrTable(NULL),
<FONT COLOR="#40F628">0225:</FONT>     m_pBoneMatrix(NULL),
<FONT COLOR="#40F628">0226:</FONT>     m_pBoneNamesBuf(NULL),
<FONT COLOR="#40F628">0227:</FONT>     m_pBoneOffsetBuf(NULL),
<FONT COLOR="#40F628">0228:</FONT>     m_pBoneOffsetMat(NULL),
<FONT COLOR="#40F628">0229:</FONT>     m_rgiAdjacency(NULL),
<FONT COLOR="#40F628">0230:</FONT>     m_numBoneComb(0),
<FONT COLOR="#40F628">0231:</FONT>     m_maxFaceInfl(0),
<FONT COLOR="#40F628">0232:</FONT>     m_pBoneCombinationBuf(NULL),
<FONT COLOR="#40F628">0233:</FONT>     m_Method(NONE),
<FONT COLOR="#40F628">0234:</FONT>     m_paletteSize(0),
<FONT COLOR="#40F628">0235:</FONT>     m_bUseSW(FALSE)
<FONT COLOR="#40F628">0236:</FONT> {
<FONT COLOR="#40F628">0237:</FONT> }
<FONT COLOR="#40F628">0238:</FONT> <FONT COLOR="#008000">// ----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0239:</FONT> SMeshContainer::~SMeshContainer()
<FONT COLOR="#40F628">0240:</FONT> {
<FONT COLOR="#40F628">0241:</FONT>     DELETES(rgMaterials);
<FONT COLOR="#40F628">0242:</FONT> 
<FONT COLOR="#40F628">0243:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pTextures) {
<FONT COLOR="#40F628">0244:</FONT>         <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; cMaterials; ++i) {
<FONT COLOR="#40F628">0245:</FONT>             RELEASE(pTextures[i]);
<FONT COLOR="#40F628">0246:</FONT>         }
<FONT COLOR="#40F628">0247:</FONT>     }
<FONT COLOR="#40F628">0248:</FONT>     DELETES(pTextures);
<FONT COLOR="#40F628">0249:</FONT> 
<FONT COLOR="#40F628">0250:</FONT>     RELEASE(pMesh);
<FONT COLOR="#40F628">0251:</FONT>     RELEASE(m_pSkinMesh);
<FONT COLOR="#40F628">0252:</FONT>     RELEASE(m_pBoneNamesBuf);
<FONT COLOR="#40F628">0253:</FONT>     RELEASE(m_pBoneOffsetBuf);
<FONT COLOR="#40F628">0254:</FONT>     RELEASE(m_pBoneCombinationBuf);
<FONT COLOR="#40F628">0255:</FONT> 
<FONT COLOR="#40F628">0256:</FONT>     DELETES(m_pBoneMatrix);
<FONT COLOR="#40F628">0257:</FONT>     DELETES(m_pAttrTable);
<FONT COLOR="#40F628">0258:</FONT>     DELETES(szName);
<FONT COLOR="#40F628">0259:</FONT>     DELETES(m_rgiAdjacency);
<FONT COLOR="#40F628">0260:</FONT>     <FONT COLOR="#0000FF">delete</FONT> pmcNext;
<FONT COLOR="#40F628">0261:</FONT> }
<FONT COLOR="#40F628">0262:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0263:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0264:</FONT> <FONT COLOR="#008000">// メッシュのアニメーション管理</FONT>
<FONT COLOR="#40F628">0265:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0266:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0267:</FONT> 
<FONT COLOR="#40F628">0268:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0269:</FONT> SFrame::SFrame():
<FONT COLOR="#40F628">0270:</FONT>     pmcMesh(NULL),
<FONT COLOR="#40F628">0271:</FONT>     m_pPositionKeys(NULL),
<FONT COLOR="#40F628">0272:</FONT>     m_cPositionKeys(0),
<FONT COLOR="#40F628">0273:</FONT>     m_pScaleKeys(NULL),
<FONT COLOR="#40F628">0274:</FONT>     m_cScaleKeys(0),
<FONT COLOR="#40F628">0275:</FONT>     m_pRotateKeys(NULL),
<FONT COLOR="#40F628">0276:</FONT>     m_cRotateKeys(0),
<FONT COLOR="#40F628">0277:</FONT>     m_pMatrixKeys(NULL),
<FONT COLOR="#40F628">0278:</FONT>     m_cMatrixKeys(0),
<FONT COLOR="#40F628">0279:</FONT>     pframeAnimNext(NULL),
<FONT COLOR="#40F628">0280:</FONT>     pframeToAnimate(NULL),
<FONT COLOR="#40F628">0281:</FONT>     pframeSibling(NULL),
<FONT COLOR="#40F628">0282:</FONT>     pframeFirstChild(NULL),
<FONT COLOR="#40F628">0283:</FONT>     bAnimationFrame(<FONT COLOR="#0000FF">false</FONT>),
<FONT COLOR="#40F628">0284:</FONT>     szName(NULL)
<FONT COLOR="#40F628">0285:</FONT> {
<FONT COLOR="#40F628">0286:</FONT>     D3DXMatrixIdentity(&amp;matRot);
<FONT COLOR="#40F628">0287:</FONT>     D3DXMatrixIdentity(&amp;matRotOrig);
<FONT COLOR="#40F628">0288:</FONT>     D3DXMatrixIdentity(&amp;matTrans);
<FONT COLOR="#40F628">0289:</FONT> }
<FONT COLOR="#40F628">0290:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0291:</FONT> SFrame::~SFrame()
<FONT COLOR="#40F628">0292:</FONT> {
<FONT COLOR="#40F628">0293:</FONT>     DELETES(szName);
<FONT COLOR="#40F628">0294:</FONT>     <FONT COLOR="#0000FF">delete</FONT> pmcMesh;        
<FONT COLOR="#40F628">0295:</FONT>     <FONT COLOR="#0000FF">delete</FONT> pframeFirstChild;
<FONT COLOR="#40F628">0296:</FONT>     <FONT COLOR="#0000FF">delete</FONT> pframeSibling;
<FONT COLOR="#40F628">0297:</FONT> 
<FONT COLOR="#40F628">0298:</FONT>     DELETES(m_pPositionKeys);
<FONT COLOR="#40F628">0299:</FONT>     DELETES(m_pRotateKeys);
<FONT COLOR="#40F628">0300:</FONT>     DELETES(m_pScaleKeys);
<FONT COLOR="#40F628">0301:</FONT>     DELETES(m_pMatrixKeys);
<FONT COLOR="#40F628">0302:</FONT> }
<FONT COLOR="#40F628">0303:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0304:</FONT> <FONT COLOR="#008000">// 時間の設定</FONT>
<FONT COLOR="#40F628">0305:</FONT> <FONT COLOR="#0000FF">void</FONT> SFrame::SetTime(<FONT COLOR="#0000FF">float</FONT> fGlobalTime)
<FONT COLOR="#40F628">0306:</FONT> {
<FONT COLOR="#40F628">0307:</FONT>     UINT iKey;
<FONT COLOR="#40F628">0308:</FONT>     UINT dwp2;
<FONT COLOR="#40F628">0309:</FONT>     UINT dwp3;
<FONT COLOR="#40F628">0310:</FONT>     D3DXMATRIXA16 matResult;
<FONT COLOR="#40F628">0311:</FONT>     D3DXMATRIXA16 matTemp;
<FONT COLOR="#40F628">0312:</FONT>     <FONT COLOR="#0000FF">float</FONT> fTime1;
<FONT COLOR="#40F628">0313:</FONT>     <FONT COLOR="#0000FF">float</FONT> fTime2;
<FONT COLOR="#40F628">0314:</FONT>     <FONT COLOR="#0000FF">float</FONT> fLerpValue;
<FONT COLOR="#40F628">0315:</FONT>     D3DXVECTOR3 vScale;
<FONT COLOR="#40F628">0316:</FONT>     D3DXVECTOR3 vPos;
<FONT COLOR="#40F628">0317:</FONT>     D3DXQUATERNION quat;
<FONT COLOR="#40F628">0318:</FONT>     BOOL bAnimate = <FONT COLOR="#0000FF">false</FONT>;
<FONT COLOR="#40F628">0319:</FONT>     <FONT COLOR="#0000FF">float</FONT> fTime;
<FONT COLOR="#40F628">0320:</FONT> 
<FONT COLOR="#40F628">0321:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_pMatrixKeys ) {
<FONT COLOR="#40F628">0322:</FONT>         <FONT COLOR="#008000">// 行列としてアニメが登録されていた場合</FONT>
<FONT COLOR="#40F628">0323:</FONT>         
<FONT COLOR="#40F628">0324:</FONT>         <FONT COLOR="#008000">// 時間にあったキーフレームを検索する</FONT>
<FONT COLOR="#40F628">0325:</FONT>         fTime = (<FONT COLOR="#0000FF">float</FONT>)fmod(fGlobalTime, m_pMatrixKeys[m_cMatrixKeys-1].dwTime);
<FONT COLOR="#40F628">0326:</FONT>         <FONT COLOR="#0000FF">for</FONT> (iKey = 0 ;iKey &lt; m_cMatrixKeys ; iKey++) {
<FONT COLOR="#40F628">0327:</FONT>             <FONT COLOR="#0000FF">if</FONT> ((<FONT COLOR="#0000FF">float</FONT>)m_pMatrixKeys[iKey].dwTime &gt; fTime) {
<FONT COLOR="#40F628">0328:</FONT>                 dwp3 = iKey;
<FONT COLOR="#40F628">0329:</FONT>                 dwp2= (0&lt;iKey)?(iKey - 1):iKey;
<FONT COLOR="#40F628">0330:</FONT>                 <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">0331:</FONT>             }
<FONT COLOR="#40F628">0332:</FONT>         }
<FONT COLOR="#40F628">0333:</FONT>         fTime1 = (<FONT COLOR="#0000FF">float</FONT>)m_pMatrixKeys[dwp2].dwTime;
<FONT COLOR="#40F628">0334:</FONT>         fTime2 = (<FONT COLOR="#0000FF">float</FONT>)m_pMatrixKeys[dwp3].dwTime;
<FONT COLOR="#40F628">0335:</FONT>         <FONT COLOR="#008000">// 時間の前後のキーフレームで近い方を選択する</FONT>
<FONT COLOR="#40F628">0336:</FONT>         fLerpValue = ((fTime2 - fTime1) !=0)?( (fTime - fTime1)  / (fTime2 - fTime1)):0;
<FONT COLOR="#40F628">0337:</FONT>         iKey = (0.5&lt;fLerpValue)?dwp3:dwp2;
<FONT COLOR="#40F628">0338:</FONT>         pframeToAnimate-&gt;matRot = m_pMatrixKeys[iKey].mat;
<FONT COLOR="#40F628">0339:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">0340:</FONT>         D3DXMatrixIdentity(&amp;matResult);
<FONT COLOR="#40F628">0341:</FONT>         <FONT COLOR="#008000">// スケールのアニメが登録されていた場合</FONT>
<FONT COLOR="#40F628">0342:</FONT>         <FONT COLOR="#0000FF">if</FONT> (m_pScaleKeys) {
<FONT COLOR="#40F628">0343:</FONT>             dwp2 = dwp3 = 0;
<FONT COLOR="#40F628">0344:</FONT> 
<FONT COLOR="#40F628">0345:</FONT>             <FONT COLOR="#008000">// 時間にあったキーフレームを検索する</FONT>
<FONT COLOR="#40F628">0346:</FONT>             fTime = (<FONT COLOR="#0000FF">float</FONT>)fmod(fGlobalTime, m_pScaleKeys[m_cScaleKeys-1].dwTime);
<FONT COLOR="#40F628">0347:</FONT>             <FONT COLOR="#0000FF">for</FONT> (iKey = 0 ;iKey &lt; m_cScaleKeys ; iKey++) {
<FONT COLOR="#40F628">0348:</FONT>                 <FONT COLOR="#0000FF">if</FONT> ((<FONT COLOR="#0000FF">float</FONT>)m_pScaleKeys[iKey].dwTime &gt; fTime) {
<FONT COLOR="#40F628">0349:</FONT>                     dwp3 = iKey;
<FONT COLOR="#40F628">0350:</FONT>                     dwp2= (0&lt;iKey)?(iKey - 1):iKey;
<FONT COLOR="#40F628">0351:</FONT>                     <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">0352:</FONT>                 }
<FONT COLOR="#40F628">0353:</FONT>             }
<FONT COLOR="#40F628">0354:</FONT>             fTime1 = (<FONT COLOR="#0000FF">float</FONT>)m_pScaleKeys[dwp2].dwTime;
<FONT COLOR="#40F628">0355:</FONT>             fTime2 = (<FONT COLOR="#0000FF">float</FONT>)m_pScaleKeys[dwp3].dwTime;
<FONT COLOR="#40F628">0356:</FONT> 
<FONT COLOR="#40F628">0357:</FONT>             <FONT COLOR="#008000">// 線形補間して合成</FONT>
<FONT COLOR="#40F628">0358:</FONT>             fLerpValue = ((fTime2 - fTime1) !=0)?( (fTime - fTime1)  / (fTime2 - fTime1)):0;
<FONT COLOR="#40F628">0359:</FONT>             D3DXVec3Lerp(&amp;vScale,
<FONT COLOR="#40F628">0360:</FONT>                     &amp;m_pScaleKeys[dwp2].vScale,
<FONT COLOR="#40F628">0361:</FONT>                     &amp;m_pScaleKeys[dwp3].vScale,
<FONT COLOR="#40F628">0362:</FONT>                     fLerpValue);
<FONT COLOR="#40F628">0363:</FONT>             D3DXMatrixScaling(&amp;matTemp, vScale.x, vScale.y, vScale.z);
<FONT COLOR="#40F628">0364:</FONT>             
<FONT COLOR="#40F628">0365:</FONT>             <FONT COLOR="#008000">// 掛けた結果を保存する</FONT>
<FONT COLOR="#40F628">0366:</FONT>             D3DXMatrixMultiply(&amp;matResult, &amp;matResult, &amp;matTemp);
<FONT COLOR="#40F628">0367:</FONT> 
<FONT COLOR="#40F628">0368:</FONT>             bAnimate = <FONT COLOR="#0000FF">true</FONT>;
<FONT COLOR="#40F628">0369:</FONT>         }
<FONT COLOR="#40F628">0370:</FONT> 
<FONT COLOR="#40F628">0371:</FONT>         <FONT COLOR="#008000">// 回転のアニメが登録されていた場合</FONT>
<FONT COLOR="#40F628">0372:</FONT>         <FONT COLOR="#0000FF">if</FONT> (m_pRotateKeys ) {
<FONT COLOR="#40F628">0373:</FONT>             <FONT COLOR="#0000FF">int</FONT> i1 = 0;
<FONT COLOR="#40F628">0374:</FONT>             <FONT COLOR="#0000FF">int</FONT> i2 = 0;
<FONT COLOR="#40F628">0375:</FONT> 
<FONT COLOR="#40F628">0376:</FONT>             <FONT COLOR="#008000">// 時間にあったキーフレームを検索する</FONT>
<FONT COLOR="#40F628">0377:</FONT>             fTime = (<FONT COLOR="#0000FF">float</FONT>)fmod(fGlobalTime, m_pRotateKeys[m_cRotateKeys-1].dwTime);
<FONT COLOR="#40F628">0378:</FONT>             <FONT COLOR="#0000FF">for</FONT> (iKey = 0 ;iKey &lt; m_cRotateKeys ; iKey++){
<FONT COLOR="#40F628">0379:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (fTime &lt; (<FONT COLOR="#0000FF">float</FONT>)m_pRotateKeys[iKey].dwTime){
<FONT COLOR="#40F628">0380:</FONT>                     i1 = (iKey &gt; 0) ? iKey - 1 : 0;
<FONT COLOR="#40F628">0381:</FONT>                     i2 = iKey;
<FONT COLOR="#40F628">0382:</FONT>                     <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">0383:</FONT>                 }
<FONT COLOR="#40F628">0384:</FONT>             }
<FONT COLOR="#40F628">0385:</FONT> 
<FONT COLOR="#40F628">0386:</FONT>             fTime1 = (<FONT COLOR="#0000FF">float</FONT>)m_pRotateKeys[i1].dwTime;
<FONT COLOR="#40F628">0387:</FONT>             fTime2 = (<FONT COLOR="#0000FF">float</FONT>)m_pRotateKeys[i2].dwTime;
<FONT COLOR="#40F628">0388:</FONT>             fLerpValue = ((fTime2 - fTime1) !=0)?( (fTime - fTime1)  / (fTime2 - fTime1)):0;
<FONT COLOR="#40F628">0389:</FONT> 
<FONT COLOR="#40F628">0390:</FONT>             <FONT COLOR="#008000">// 球状平方補間して合成</FONT>
<FONT COLOR="#40F628">0391:</FONT>             <FONT COLOR="#0000FF">int</FONT> i0 = i1 - 1;
<FONT COLOR="#40F628">0392:</FONT>             <FONT COLOR="#0000FF">int</FONT> i3 = i2 + 1;
<FONT COLOR="#40F628">0393:</FONT> 
<FONT COLOR="#40F628">0394:</FONT>             <FONT COLOR="#0000FF">if</FONT>(i0 &lt; 0)  i0 += m_cRotateKeys;
<FONT COLOR="#40F628">0395:</FONT>             <FONT COLOR="#0000FF">if</FONT>(i3 &gt;= (INT) m_cRotateKeys)   i3 -= m_cRotateKeys;
<FONT COLOR="#40F628">0396:</FONT> 
<FONT COLOR="#40F628">0397:</FONT>             D3DXQUATERNION qA, qB, qC;
<FONT COLOR="#40F628">0398:</FONT>             D3DXQuaternionSquadSetup(&amp;qA, &amp;qB, &amp;qC, 
<FONT COLOR="#40F628">0399:</FONT>                 &amp;m_pRotateKeys[i0].quatRotate, &amp;m_pRotateKeys[i1].quatRotate, 
<FONT COLOR="#40F628">0400:</FONT>                 &amp;m_pRotateKeys[i2].quatRotate, &amp;m_pRotateKeys[i3].quatRotate);
<FONT COLOR="#40F628">0401:</FONT> 
<FONT COLOR="#40F628">0402:</FONT>             D3DXQuaternionSquad(&amp;quat, &amp;m_pRotateKeys[i1].quatRotate, &amp;qA, &amp;qB, &amp;qC, fLerpValue);
<FONT COLOR="#40F628">0403:</FONT> 
<FONT COLOR="#40F628">0404:</FONT>             quat.w = -quat.w;
<FONT COLOR="#40F628">0405:</FONT>             D3DXMatrixRotationQuaternion(&amp;matTemp, &amp;quat);
<FONT COLOR="#40F628">0406:</FONT>             <FONT COLOR="#008000">// 掛けた結果を保存する</FONT>
<FONT COLOR="#40F628">0407:</FONT>             D3DXMatrixMultiply(&amp;matResult, &amp;matResult, &amp;matTemp);
<FONT COLOR="#40F628">0408:</FONT> 
<FONT COLOR="#40F628">0409:</FONT>             bAnimate = <FONT COLOR="#0000FF">true</FONT>;
<FONT COLOR="#40F628">0410:</FONT>         }
<FONT COLOR="#40F628">0411:</FONT> 
<FONT COLOR="#40F628">0412:</FONT>         <FONT COLOR="#008000">// 平行移動のアニメが登録されていた場合</FONT>
<FONT COLOR="#40F628">0413:</FONT>         <FONT COLOR="#0000FF">if</FONT> (m_pPositionKeys) {
<FONT COLOR="#40F628">0414:</FONT>             dwp2=dwp3=0;
<FONT COLOR="#40F628">0415:</FONT>             <FONT COLOR="#008000">// 時間にあったキーフレームを検索する</FONT>
<FONT COLOR="#40F628">0416:</FONT>             fTime = (<FONT COLOR="#0000FF">float</FONT>)fmod(fGlobalTime, m_pPositionKeys[m_cPositionKeys-1].dwTime);
<FONT COLOR="#40F628">0417:</FONT>             <FONT COLOR="#0000FF">for</FONT> (iKey = 0 ;iKey &lt; m_cPositionKeys ; iKey++) {
<FONT COLOR="#40F628">0418:</FONT>                 <FONT COLOR="#0000FF">if</FONT> ((<FONT COLOR="#0000FF">float</FONT>)m_pPositionKeys[iKey].dwTime &gt; fTime) {
<FONT COLOR="#40F628">0419:</FONT>                     dwp3 = iKey;
<FONT COLOR="#40F628">0420:</FONT>                     dwp2= (0&lt;iKey)?(iKey - 1):iKey;
<FONT COLOR="#40F628">0421:</FONT>                     <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">0422:</FONT>                 }
<FONT COLOR="#40F628">0423:</FONT>             }
<FONT COLOR="#40F628">0424:</FONT>             
<FONT COLOR="#40F628">0425:</FONT>             <FONT COLOR="#008000">// 線形補間して合成</FONT>
<FONT COLOR="#40F628">0426:</FONT>             fTime1 = (<FONT COLOR="#0000FF">float</FONT>)m_pPositionKeys[dwp2].dwTime;
<FONT COLOR="#40F628">0427:</FONT>             fTime2 = (<FONT COLOR="#0000FF">float</FONT>)m_pPositionKeys[dwp3].dwTime;
<FONT COLOR="#40F628">0428:</FONT>             fLerpValue = ((fTime2 - fTime1) !=0)?( (fTime - fTime1)  / (fTime2 - fTime1)):0;
<FONT COLOR="#40F628">0429:</FONT>             D3DXVec3Lerp((D3DXVECTOR3*)&amp;vPos,
<FONT COLOR="#40F628">0430:</FONT>                     &amp;m_pPositionKeys[dwp2].vPos,
<FONT COLOR="#40F628">0431:</FONT>                     &amp;m_pPositionKeys[dwp3].vPos,
<FONT COLOR="#40F628">0432:</FONT>                     fLerpValue);
<FONT COLOR="#40F628">0433:</FONT>             D3DXMatrixTranslation(&amp;matTemp, vPos.x, vPos.y, vPos.z);
<FONT COLOR="#40F628">0434:</FONT>             
<FONT COLOR="#40F628">0435:</FONT>             <FONT COLOR="#008000">// 掛けた結果を保存する</FONT>
<FONT COLOR="#40F628">0436:</FONT>             D3DXMatrixMultiply(&amp;matResult, &amp;matResult, &amp;matTemp);
<FONT COLOR="#40F628">0437:</FONT>             bAnimate = <FONT COLOR="#0000FF">true</FONT>;
<FONT COLOR="#40F628">0438:</FONT>         } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">0439:</FONT>             <FONT COLOR="#008000">// 平行移動の場合はアニメが無ければディフォルトの位置を指定する</FONT>
<FONT COLOR="#40F628">0440:</FONT>             D3DXMatrixTranslation(&amp;matTemp
<FONT COLOR="#40F628">0441:</FONT>                             , pframeToAnimate-&gt;matRotOrig._41
<FONT COLOR="#40F628">0442:</FONT>                             , pframeToAnimate-&gt;matRotOrig._42
<FONT COLOR="#40F628">0443:</FONT>                             , pframeToAnimate-&gt;matRotOrig._43);
<FONT COLOR="#40F628">0444:</FONT>             D3DXMatrixMultiply(&amp;matResult, &amp;matResult, &amp;matTemp);
<FONT COLOR="#40F628">0445:</FONT>         }
<FONT COLOR="#40F628">0446:</FONT> 
<FONT COLOR="#40F628">0447:</FONT>         <FONT COLOR="#0000FF">if</FONT> (bAnimate) pframeToAnimate-&gt;matRot = matResult;
<FONT COLOR="#40F628">0448:</FONT>     }
<FONT COLOR="#40F628">0449:</FONT> }
<FONT COLOR="#40F628">0450:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0451:</FONT> <FONT COLOR="#008000">// 自分の子兄弟でszFrameの名前をもったやつがいるか調べる</FONT>
<FONT COLOR="#40F628">0452:</FONT> SFrame *SFrame::FindFrame(<FONT COLOR="#0000FF">char</FONT> *szFrame)
<FONT COLOR="#40F628">0453:</FONT> {
<FONT COLOR="#40F628">0454:</FONT>     SFrame *pframe;
<FONT COLOR="#40F628">0455:</FONT> 
<FONT COLOR="#40F628">0456:</FONT>     <FONT COLOR="#008000">// 名前が同じなら名乗り出る</FONT>
<FONT COLOR="#40F628">0457:</FONT>     <FONT COLOR="#0000FF">if</FONT> ((szName != NULL) &amp;&amp; (strcmp(szName, szFrame) == 0)) <FONT COLOR="#0000FF">return</FONT> <FONT COLOR="#0000FF">this</FONT>;
<FONT COLOR="#40F628">0458:</FONT> 
<FONT COLOR="#40F628">0459:</FONT>     <FONT COLOR="#008000">// 後は、子供を伝った後、先頭の子供の兄弟から次々に検索する</FONT>
<FONT COLOR="#40F628">0460:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pframeFirstChild != NULL) {
<FONT COLOR="#40F628">0461:</FONT>         pframe = pframeFirstChild-&gt;FindFrame(szFrame);
<FONT COLOR="#40F628">0462:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pframe != NULL) <FONT COLOR="#0000FF">return</FONT> pframe;
<FONT COLOR="#40F628">0463:</FONT>     }
<FONT COLOR="#40F628">0464:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pframeSibling != NULL) {
<FONT COLOR="#40F628">0465:</FONT>         pframe = pframeSibling-&gt;FindFrame(szFrame);
<FONT COLOR="#40F628">0466:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pframe != NULL) <FONT COLOR="#0000FF">return</FONT> pframe;
<FONT COLOR="#40F628">0467:</FONT>     }
<FONT COLOR="#40F628">0468:</FONT> 
<FONT COLOR="#40F628">0469:</FONT>     <FONT COLOR="#0000FF">return</FONT> NULL;
<FONT COLOR="#40F628">0470:</FONT> }
<FONT COLOR="#40F628">0471:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0472:</FONT> <FONT COLOR="#008000">// 行列を最初の（重心中心の）行列に初期化する</FONT>
<FONT COLOR="#40F628">0473:</FONT> <FONT COLOR="#0000FF">void</FONT> SFrame::ResetMatrix()
<FONT COLOR="#40F628">0474:</FONT> {
<FONT COLOR="#40F628">0475:</FONT>     matRot = matRotOrig;
<FONT COLOR="#40F628">0476:</FONT>     D3DXMatrixIdentity(&amp;matTrans);
<FONT COLOR="#40F628">0477:</FONT>     
<FONT COLOR="#40F628">0478:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pframeFirstChild != NULL) pframeFirstChild-&gt;ResetMatrix();
<FONT COLOR="#40F628">0479:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pframeSibling    != NULL) pframeSibling-&gt;ResetMatrix();
<FONT COLOR="#40F628">0480:</FONT> }
<FONT COLOR="#40F628">0481:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0482:</FONT> <FONT COLOR="#008000">// フレームを追加する</FONT>
<FONT COLOR="#40F628">0483:</FONT> <FONT COLOR="#0000FF">void</FONT> SFrame::AddFrame(SFrame *pframe)
<FONT COLOR="#40F628">0484:</FONT> {
<FONT COLOR="#40F628">0485:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pframeFirstChild == NULL) {
<FONT COLOR="#40F628">0486:</FONT>         pframeFirstChild = pframe;
<FONT COLOR="#40F628">0487:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">0488:</FONT>         pframe-&gt;pframeSibling = pframeFirstChild-&gt;pframeSibling;
<FONT COLOR="#40F628">0489:</FONT>         pframeFirstChild-&gt;pframeSibling = pframe;
<FONT COLOR="#40F628">0490:</FONT>     }
<FONT COLOR="#40F628">0491:</FONT> <FONT COLOR="#008000">// root                  root                   root</FONT>
<FONT COLOR="#40F628">0492:</FONT> <FONT COLOR="#008000">//  |                     |                      |</FONT>
<FONT COLOR="#40F628">0493:</FONT> <FONT COLOR="#008000">// child① - Sibling     child① - Sibling②    child① - Sibling③ - Sibling②</FONT>
<FONT COLOR="#40F628">0494:</FONT> <FONT COLOR="#008000">//  の順で詰まっていく</FONT>
<FONT COLOR="#40F628">0495:</FONT> }
<FONT COLOR="#40F628">0496:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0497:</FONT> <FONT COLOR="#008000">// 先頭に新しいメッシュを追加する</FONT>
<FONT COLOR="#40F628">0498:</FONT> <FONT COLOR="#0000FF">void</FONT> SFrame::AddMesh(SMeshContainer *pmc)
<FONT COLOR="#40F628">0499:</FONT> {
<FONT COLOR="#40F628">0500:</FONT>     pmc-&gt;pmcNext = pmcMesh;
<FONT COLOR="#40F628">0501:</FONT>     pmcMesh = pmc;
<FONT COLOR="#40F628">0502:</FONT> }
<FONT COLOR="#40F628">0503:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0504:</FONT> <FONT COLOR="#008000">// 重心を求める</FONT>
<FONT COLOR="#40F628">0505:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0506:</FONT> HRESULT SFrame::CalculateSum( D3DXMATRIX *pmatCur, D3DXVECTOR3 *pvCenter, UINT *pcVertices)
<FONT COLOR="#40F628">0507:</FONT> {
<FONT COLOR="#40F628">0508:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">0509:</FONT>     PBYTE pbPoints = NULL;
<FONT COLOR="#40F628">0510:</FONT>     UINT cVerticesLocal = 0;
<FONT COLOR="#40F628">0511:</FONT>     D3DXVECTOR3 vTransformedCur;
<FONT COLOR="#40F628">0512:</FONT>     UINT iPoint;
<FONT COLOR="#40F628">0513:</FONT>     SMeshContainer *pmcCur;
<FONT COLOR="#40F628">0514:</FONT>     SFrame *pCur;
<FONT COLOR="#40F628">0515:</FONT>     UINT cVertices;
<FONT COLOR="#40F628">0516:</FONT>     D3DXMATRIXA16 matLocal;
<FONT COLOR="#40F628">0517:</FONT>     
<FONT COLOR="#40F628">0518:</FONT>     D3DXMatrixMultiply(&amp;matLocal, &amp;<FONT COLOR="#0000FF">this</FONT>-&gt;matRot, pmatCur);
<FONT COLOR="#40F628">0519:</FONT>     
<FONT COLOR="#40F628">0520:</FONT>     <FONT COLOR="#0000FF">for</FONT>(pmcCur = <FONT COLOR="#0000FF">this</FONT>-&gt;pmcMesh ; pmcCur ; pmcCur = pmcCur-&gt;pmcNext ){
<FONT COLOR="#40F628">0521:</FONT>         DWORD fvfsize = D3DXGetFVFVertexSize(pmcCur-&gt;pMesh-&gt;GetFVF());
<FONT COLOR="#40F628">0522:</FONT>         
<FONT COLOR="#40F628">0523:</FONT>         cVertices = pmcCur-&gt;pMesh-&gt;GetNumVertices();
<FONT COLOR="#40F628">0524:</FONT>         
<FONT COLOR="#40F628">0525:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pmcCur-&gt;pMesh-&gt;LockVertexBuffer(0, &amp;pbPoints))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0526:</FONT>         
<FONT COLOR="#40F628">0527:</FONT>         PBYTE pbCur = pbPoints;
<FONT COLOR="#40F628">0528:</FONT>         <FONT COLOR="#0000FF">for</FONT>( iPoint=0 ; iPoint &lt; cVertices; iPoint++, pbCur += fvfsize) {
<FONT COLOR="#40F628">0529:</FONT>             D3DXVECTOR3 *pvCur = (D3DXVECTOR3*)pbCur;
<FONT COLOR="#40F628">0530:</FONT>             
<FONT COLOR="#40F628">0531:</FONT>             <FONT COLOR="#0000FF">if</FONT> ((pvCur-&gt;x != 0.0) || (pvCur-&gt;y != 0.0) || (pvCur-&gt;z != 0.0)) {
<FONT COLOR="#40F628">0532:</FONT>                 cVerticesLocal++;
<FONT COLOR="#40F628">0533:</FONT>                 
<FONT COLOR="#40F628">0534:</FONT>                 D3DXVec3TransformCoord(&amp;vTransformedCur, pvCur, &amp;matLocal);
<FONT COLOR="#40F628">0535:</FONT>                 
<FONT COLOR="#40F628">0536:</FONT>                 pvCenter-&gt;x += vTransformedCur.x;
<FONT COLOR="#40F628">0537:</FONT>                 pvCenter-&gt;y += vTransformedCur.y;
<FONT COLOR="#40F628">0538:</FONT>                 pvCenter-&gt;z += vTransformedCur.z;
<FONT COLOR="#40F628">0539:</FONT>             }
<FONT COLOR="#40F628">0540:</FONT>         }
<FONT COLOR="#40F628">0541:</FONT>         pmcCur-&gt;pMesh-&gt;UnlockVertexBuffer();
<FONT COLOR="#40F628">0542:</FONT>         pbPoints = NULL;
<FONT COLOR="#40F628">0543:</FONT>     }
<FONT COLOR="#40F628">0544:</FONT>     
<FONT COLOR="#40F628">0545:</FONT>     *pcVertices += cVerticesLocal;
<FONT COLOR="#40F628">0546:</FONT>     
<FONT COLOR="#40F628">0547:</FONT>     <FONT COLOR="#0000FF">for</FONT>(pCur = <FONT COLOR="#0000FF">this</FONT>-&gt;pframeFirstChild ; pCur ; pCur = pCur-&gt;pframeSibling){
<FONT COLOR="#40F628">0548:</FONT>         hr = pCur-&gt;CalculateSum( &amp;matLocal, pvCenter, pcVertices);
<FONT COLOR="#40F628">0549:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0550:</FONT>     }
<FONT COLOR="#40F628">0551:</FONT>     
<FONT COLOR="#40F628">0552:</FONT> e_Exit:
<FONT COLOR="#40F628">0553:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pbPoints != NULL) pmcCur-&gt;pMesh-&gt;UnlockVertexBuffer();
<FONT COLOR="#40F628">0554:</FONT>     
<FONT COLOR="#40F628">0555:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">0556:</FONT> }
<FONT COLOR="#40F628">0557:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0558:</FONT> <FONT COLOR="#008000">// 半径の計算</FONT>
<FONT COLOR="#40F628">0559:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0560:</FONT> HRESULT SFrame::CalculateRadius(D3DXMATRIX *pmatCur, D3DXVECTOR3 *pvCenter, <FONT COLOR="#0000FF">float</FONT> *pfRadiusSq)
<FONT COLOR="#40F628">0561:</FONT> {
<FONT COLOR="#40F628">0562:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">0563:</FONT>     PBYTE pbPoints = NULL;
<FONT COLOR="#40F628">0564:</FONT>     PBYTE pbCur;
<FONT COLOR="#40F628">0565:</FONT>     D3DXVECTOR3 *pvCur;
<FONT COLOR="#40F628">0566:</FONT>     D3DXVECTOR3 vDist;;
<FONT COLOR="#40F628">0567:</FONT>     UINT iPoint;
<FONT COLOR="#40F628">0568:</FONT>     UINT cVertices;
<FONT COLOR="#40F628">0569:</FONT>     SMeshContainer *pmcCur;
<FONT COLOR="#40F628">0570:</FONT>     SFrame *pCur;
<FONT COLOR="#40F628">0571:</FONT>     <FONT COLOR="#0000FF">float</FONT> fRadiusLocalSq;
<FONT COLOR="#40F628">0572:</FONT>     <FONT COLOR="#0000FF">float</FONT> fDistSq;
<FONT COLOR="#40F628">0573:</FONT>     D3DXMATRIXA16 matLocal;
<FONT COLOR="#40F628">0574:</FONT>     
<FONT COLOR="#40F628">0575:</FONT>     D3DXMatrixMultiply(&amp;matLocal, &amp;<FONT COLOR="#0000FF">this</FONT>-&gt;matRot, pmatCur);
<FONT COLOR="#40F628">0576:</FONT>     
<FONT COLOR="#40F628">0577:</FONT>     pmcCur = <FONT COLOR="#0000FF">this</FONT>-&gt;pmcMesh;
<FONT COLOR="#40F628">0578:</FONT>     fRadiusLocalSq = *pfRadiusSq;
<FONT COLOR="#40F628">0579:</FONT>     <FONT COLOR="#0000FF">while</FONT> (pmcCur != NULL) {
<FONT COLOR="#40F628">0580:</FONT>         DWORD fvfsize = D3DXGetFVFVertexSize(pmcCur-&gt;pMesh-&gt;GetFVF());
<FONT COLOR="#40F628">0581:</FONT>         
<FONT COLOR="#40F628">0582:</FONT>         cVertices = pmcCur-&gt;pMesh-&gt;GetNumVertices();
<FONT COLOR="#40F628">0583:</FONT>         
<FONT COLOR="#40F628">0584:</FONT>         hr = pmcCur-&gt;pMesh-&gt;LockVertexBuffer(0, &amp;pbPoints);
<FONT COLOR="#40F628">0585:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0586:</FONT>         
<FONT COLOR="#40F628">0587:</FONT>         <FONT COLOR="#0000FF">for</FONT>( iPoint=0, pbCur = pbPoints; iPoint &lt; cVertices; iPoint++, pbCur += fvfsize ) {
<FONT COLOR="#40F628">0588:</FONT>             pvCur = (D3DXVECTOR3*)pbCur;
<FONT COLOR="#40F628">0589:</FONT>             
<FONT COLOR="#40F628">0590:</FONT>             <FONT COLOR="#0000FF">if</FONT> ((pvCur-&gt;x == 0.0) &amp;&amp; (pvCur-&gt;y == 0.0) &amp;&amp; (pvCur-&gt;z == 0.0)) <FONT COLOR="#0000FF">continue</FONT>;
<FONT COLOR="#40F628">0591:</FONT>             
<FONT COLOR="#40F628">0592:</FONT>             D3DXVec3TransformCoord(&amp;vDist, pvCur, &amp;matLocal);
<FONT COLOR="#40F628">0593:</FONT>             
<FONT COLOR="#40F628">0594:</FONT>             vDist -= *pvCenter;
<FONT COLOR="#40F628">0595:</FONT>             
<FONT COLOR="#40F628">0596:</FONT>             fDistSq = D3DXVec3LengthSq(&amp;vDist);
<FONT COLOR="#40F628">0597:</FONT>             
<FONT COLOR="#40F628">0598:</FONT>             <FONT COLOR="#0000FF">if</FONT>( fDistSq &gt; fRadiusLocalSq ) fRadiusLocalSq = fDistSq;
<FONT COLOR="#40F628">0599:</FONT>         }
<FONT COLOR="#40F628">0600:</FONT>         
<FONT COLOR="#40F628">0601:</FONT>         
<FONT COLOR="#40F628">0602:</FONT>         pmcCur-&gt;pMesh-&gt;UnlockVertexBuffer();
<FONT COLOR="#40F628">0603:</FONT>         pbPoints = NULL;
<FONT COLOR="#40F628">0604:</FONT>         
<FONT COLOR="#40F628">0605:</FONT>         pmcCur = pmcCur-&gt;pmcNext;
<FONT COLOR="#40F628">0606:</FONT>     }
<FONT COLOR="#40F628">0607:</FONT>     
<FONT COLOR="#40F628">0608:</FONT>     *pfRadiusSq = fRadiusLocalSq;
<FONT COLOR="#40F628">0609:</FONT>     
<FONT COLOR="#40F628">0610:</FONT>     pCur = <FONT COLOR="#0000FF">this</FONT>-&gt;pframeFirstChild;
<FONT COLOR="#40F628">0611:</FONT>     <FONT COLOR="#0000FF">while</FONT> (pCur != NULL) {
<FONT COLOR="#40F628">0612:</FONT>         hr = pCur-&gt;CalculateRadius( &amp;matLocal, pvCenter, pfRadiusSq);
<FONT COLOR="#40F628">0613:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0614:</FONT>         
<FONT COLOR="#40F628">0615:</FONT>         pCur = pCur-&gt;pframeSibling;
<FONT COLOR="#40F628">0616:</FONT>     }
<FONT COLOR="#40F628">0617:</FONT>     
<FONT COLOR="#40F628">0618:</FONT> e_Exit:
<FONT COLOR="#40F628">0619:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pbPoints != NULL) pmcCur-&gt;pMesh-&gt;UnlockVertexBuffer();
<FONT COLOR="#40F628">0620:</FONT>     
<FONT COLOR="#40F628">0621:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">0622:</FONT> }
<FONT COLOR="#40F628">0623:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0624:</FONT> <FONT COLOR="#008000">// バウンディング球の計算</FONT>
<FONT COLOR="#40F628">0625:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0626:</FONT> HRESULT SDrawElement::CalculateBoundingSphere()
<FONT COLOR="#40F628">0627:</FONT> {
<FONT COLOR="#40F628">0628:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">0629:</FONT>     D3DXVECTOR3 vCenter(0,0,0);
<FONT COLOR="#40F628">0630:</FONT>     UINT cVertices = 0;
<FONT COLOR="#40F628">0631:</FONT>     <FONT COLOR="#0000FF">float</FONT> fRadiusSq = 0;
<FONT COLOR="#40F628">0632:</FONT>     D3DXMATRIXA16 matCur;
<FONT COLOR="#40F628">0633:</FONT>     
<FONT COLOR="#40F628">0634:</FONT>     D3DXMatrixIdentity(&amp;matCur);
<FONT COLOR="#40F628">0635:</FONT>     hr = <FONT COLOR="#0000FF">this</FONT>-&gt;pframeRoot-&gt;CalculateSum(&amp;matCur, &amp;vCenter, &amp;cVertices);
<FONT COLOR="#40F628">0636:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0637:</FONT>     
<FONT COLOR="#40F628">0638:</FONT>     <FONT COLOR="#0000FF">if</FONT> (cVertices &gt; 0) {
<FONT COLOR="#40F628">0639:</FONT>         vCenter /= (<FONT COLOR="#0000FF">float</FONT>)cVertices;
<FONT COLOR="#40F628">0640:</FONT>         
<FONT COLOR="#40F628">0641:</FONT>         D3DXMatrixIdentity(&amp;matCur);
<FONT COLOR="#40F628">0642:</FONT>         hr = <FONT COLOR="#0000FF">this</FONT>-&gt;pframeRoot-&gt;CalculateRadius(&amp;matCur, &amp;vCenter, &amp;fRadiusSq);
<FONT COLOR="#40F628">0643:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0644:</FONT>     }
<FONT COLOR="#40F628">0645:</FONT>     
<FONT COLOR="#40F628">0646:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;fRadius = (<FONT COLOR="#0000FF">float</FONT>)sqrt((<FONT COLOR="#0000FF">double</FONT>)fRadiusSq);;
<FONT COLOR="#40F628">0647:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;vCenter = vCenter;
<FONT COLOR="#40F628">0648:</FONT> e_Exit:
<FONT COLOR="#40F628">0649:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">0650:</FONT> }
<FONT COLOR="#40F628">0651:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0652:</FONT> SDrawElement::SDrawElement():
<FONT COLOR="#40F628">0653:</FONT>     vCenter(0.0,0.0,0.0),
<FONT COLOR="#40F628">0654:</FONT>     fRadius(1.0),
<FONT COLOR="#40F628">0655:</FONT>     szName(NULL),
<FONT COLOR="#40F628">0656:</FONT>     pframeRoot(NULL),
<FONT COLOR="#40F628">0657:</FONT>     pframeAnimHead(NULL)
<FONT COLOR="#40F628">0658:</FONT> {
<FONT COLOR="#40F628">0659:</FONT> }
<FONT COLOR="#40F628">0660:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0661:</FONT> SDrawElement::~SDrawElement()
<FONT COLOR="#40F628">0662:</FONT> {
<FONT COLOR="#40F628">0663:</FONT>     <FONT COLOR="#0000FF">delete</FONT> pframeRoot;
<FONT COLOR="#40F628">0664:</FONT>     <FONT COLOR="#0000FF">delete</FONT> [] szName;
<FONT COLOR="#40F628">0665:</FONT> }
<FONT COLOR="#40F628">0666:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0667:</FONT> <FONT COLOR="#008000">// 先頭にアニメーションフレームを追加する</FONT>
<FONT COLOR="#40F628">0668:</FONT> <FONT COLOR="#0000FF">void</FONT> SDrawElement::AddAnimationFrame(SFrame *pframeAnim)
<FONT COLOR="#40F628">0669:</FONT> {
<FONT COLOR="#40F628">0670:</FONT>     pframeAnim-&gt;pframeAnimNext = pframeAnimHead;
<FONT COLOR="#40F628">0671:</FONT>     pframeAnimHead = pframeAnim;
<FONT COLOR="#40F628">0672:</FONT> }
<FONT COLOR="#40F628">0673:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0674:</FONT> <FONT COLOR="#008000">// 名前からフレームを検索する</FONT>
<FONT COLOR="#40F628">0675:</FONT> SFrame *SDrawElement::FindFrame(<FONT COLOR="#0000FF">char</FONT> *szName)
<FONT COLOR="#40F628">0676:</FONT> {
<FONT COLOR="#40F628">0677:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pframeRoot == NULL) <FONT COLOR="#0000FF">return</FONT> NULL;
<FONT COLOR="#40F628">0678:</FONT>     <FONT COLOR="#0000FF">return</FONT> pframeRoot-&gt;FindFrame(szName);
<FONT COLOR="#40F628">0679:</FONT> }
<FONT COLOR="#40F628">0680:</FONT> 
<FONT COLOR="#40F628">0681:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0682:</FONT> <FONT COLOR="#008000">// コンストラクタ</FONT>
<FONT COLOR="#40F628">0683:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0684:</FONT> CSkinModel::CSkinModel()
<FONT COLOR="#40F628">0685:</FONT> {
<FONT COLOR="#40F628">0686:</FONT>     m_szPath[0] = '<FONT COLOR="#600000">\0</FONT>';
<FONT COLOR="#40F628">0687:</FONT>     m_pD3DDev = NULL;
<FONT COLOR="#40F628">0688:</FONT>     m_1st_time = 0;
<FONT COLOR="#40F628">0689:</FONT>     m_pdeMesh = NULL;
<FONT COLOR="#40F628">0690:</FONT> 
<FONT COLOR="#40F628">0691:</FONT>     m_dwFVF = D3DFVF_XYZ | D3DFVF_DIFFUSE | D3DFVF_NORMAL | D3DFVF_TEX1;
<FONT COLOR="#40F628">0692:</FONT> 
<FONT COLOR="#40F628">0693:</FONT>     m_method = D3DINDEXEDVS;
<FONT COLOR="#40F628">0694:</FONT> 
<FONT COLOR="#40F628">0695:</FONT>     m_pBoneMatrices = NULL;
<FONT COLOR="#40F628">0696:</FONT>     m_maxBones = 0;
<FONT COLOR="#40F628">0697:</FONT> }
<FONT COLOR="#40F628">0698:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0699:</FONT> <FONT COLOR="#008000">// 読み込んだファイルを解読する</FONT>
<FONT COLOR="#40F628">0700:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0701:</FONT> HRESULT CSkinModel::_LoadMeshHierarchy(LPDIRECT3DDEVICE8 pD3DDev)
<FONT COLOR="#40F628">0702:</FONT> {
<FONT COLOR="#40F628">0703:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">0704:</FONT>     <FONT COLOR="#0000FF">const</FONT> TCHAR* pszFile = m_szPath;
<FONT COLOR="#40F628">0705:</FONT>     SDrawElement *pdeMesh = NULL;
<FONT COLOR="#40F628">0706:</FONT>     LPDIRECTXFILE           pxofapi    = NULL;  <FONT COLOR="#008000">// DirectXFile オブジェクト</FONT>
<FONT COLOR="#40F628">0707:</FONT>     LPDIRECTXFILEENUMOBJECT pxofenum   = NULL;  <FONT COLOR="#008000">// DirectXFile 列挙オブジェクト</FONT>
<FONT COLOR="#40F628">0708:</FONT>     LPDIRECTXFILEDATA       pxofobjCur = NULL;  <FONT COLOR="#008000">// DirectXFile データ オブジェクト</FONT>
<FONT COLOR="#40F628">0709:</FONT>     DWORD dwOptions = 0;
<FONT COLOR="#40F628">0710:</FONT>     <FONT COLOR="#0000FF">int</FONT> cchFileName;
<FONT COLOR="#40F628">0711:</FONT> 
<FONT COLOR="#40F628">0712:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pszFile == NULL) <FONT COLOR="#0000FF">return</FONT> E_INVALIDARG;<FONT COLOR="#008000">// ありえないけど、一応･･･</FONT>
<FONT COLOR="#40F628">0713:</FONT>     
<FONT COLOR="#40F628">0714:</FONT>     pdeMesh = <FONT COLOR="#0000FF">new</FONT> SDrawElement();
<FONT COLOR="#40F628">0715:</FONT>     <FONT COLOR="#0000FF">delete</FONT> pdeMesh-&gt;pframeRoot;
<FONT COLOR="#40F628">0716:</FONT>     pdeMesh-&gt;pframeAnimHead = NULL;
<FONT COLOR="#40F628">0717:</FONT>     
<FONT COLOR="#40F628">0718:</FONT>     pdeMesh-&gt;pframeRoot = <FONT COLOR="#0000FF">new</FONT> SFrame();
<FONT COLOR="#40F628">0719:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pdeMesh-&gt;pframeRoot == NULL) {<FONT COLOR="#008000">// メモリ不足</FONT>
<FONT COLOR="#40F628">0720:</FONT>         hr = E_OUTOFMEMORY;
<FONT COLOR="#40F628">0721:</FONT>         <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0722:</FONT>     }
<FONT COLOR="#40F628">0723:</FONT>     
<FONT COLOR="#40F628">0724:</FONT>     cchFileName = strlen(m_szPath);
<FONT COLOR="#40F628">0725:</FONT>     <FONT COLOR="#0000FF">if</FONT> (cchFileName &lt; 2) {<FONT COLOR="#008000">// 有効なファイル名でないなら失敗扱い</FONT>
<FONT COLOR="#40F628">0726:</FONT>         hr = E_FAIL;
<FONT COLOR="#40F628">0727:</FONT>         <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0728:</FONT>     }
<FONT COLOR="#40F628">0729:</FONT>     
<FONT COLOR="#40F628">0730:</FONT>     <FONT COLOR="#008000">// ------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0731:</FONT>     <FONT COLOR="#008000">// XFile の実際の読み込み</FONT>
<FONT COLOR="#40F628">0732:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = DirectXFileCreate(&amp;pxofapi))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0733:</FONT>     
<FONT COLOR="#40F628">0734:</FONT>     <FONT COLOR="#008000">// カスタム テンプレートを登録する</FONT>
<FONT COLOR="#40F628">0735:</FONT>     hr = pxofapi-&gt;RegisterTemplates((LPVOID)D3DRM_XTEMPLATES,  D3DRM_XTEMPLATE_BYTES);
<FONT COLOR="#40F628">0736:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0737:</FONT>     
<FONT COLOR="#40F628">0738:</FONT>     <FONT COLOR="#008000">// 列挙オブジェクトを生成する</FONT>
<FONT COLOR="#40F628">0739:</FONT>     <FONT COLOR="#008000">// 列挙オブジェクトは、グローバル ユニーク識別子 (GUID) または名前でデータ オブジェクトを取得するのに使う</FONT>
<FONT COLOR="#40F628">0740:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofapi-&gt;CreateEnumObject(
<FONT COLOR="#40F628">0741:</FONT>           (LPVOID)m_szPath      <FONT COLOR="#008000">// DXFILELOAD_FROMFILE のときはファイル名</FONT>
<FONT COLOR="#40F628">0742:</FONT>         , DXFILELOAD_FROMFILE   <FONT COLOR="#008000">// 「ファイル」からデータを読み取る</FONT>
<FONT COLOR="#40F628">0743:</FONT>         , &amp;pxofenum             <FONT COLOR="#008000">// 作成された列挙オブジェクト</FONT>
<FONT COLOR="#40F628">0744:</FONT>         ))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0745:</FONT>     
<FONT COLOR="#40F628">0746:</FONT>     
<FONT COLOR="#40F628">0747:</FONT>     <FONT COLOR="#008000">// ------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0748:</FONT>     <FONT COLOR="#008000">// データを読み込んで、フレームにがんがん登録していく</FONT>
<FONT COLOR="#40F628">0749:</FONT>     <FONT COLOR="#0000FF">while</FONT> (SUCCEEDED(pxofenum-&gt;GetNextDataObject(&amp;pxofobjCur))) {
<FONT COLOR="#40F628">0750:</FONT>         hr = pdeMesh-&gt;pframeRoot-&gt;LoadFrames(pxofobjCur, pdeMesh, dwOptions, *<FONT COLOR="#0000FF">this</FONT>);
<FONT COLOR="#40F628">0751:</FONT>         RELEASE(pxofobjCur);
<FONT COLOR="#40F628">0752:</FONT>         
<FONT COLOR="#40F628">0753:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0754:</FONT>     }
<FONT COLOR="#40F628">0755:</FONT>     
<FONT COLOR="#40F628">0756:</FONT>     <FONT COLOR="#008000">// ------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0757:</FONT>     <FONT COLOR="#008000">// 骨構造の行列を構成する</FONT>
<FONT COLOR="#40F628">0758:</FONT>     hr = pdeMesh-&gt;pframeRoot-&gt;FindBones(pdeMesh);
<FONT COLOR="#40F628">0759:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0760:</FONT>     
<FONT COLOR="#40F628">0761:</FONT>     <FONT COLOR="#008000">// ------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0762:</FONT>     <FONT COLOR="#008000">// ファイル名を保存しておく</FONT>
<FONT COLOR="#40F628">0763:</FONT>     <FONT COLOR="#0000FF">delete</FONT> []pdeMesh-&gt;szName;
<FONT COLOR="#40F628">0764:</FONT>     pdeMesh-&gt;szName = <FONT COLOR="#0000FF">new</FONT> <FONT COLOR="#0000FF">char</FONT>[cchFileName+1];
<FONT COLOR="#40F628">0765:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pdeMesh-&gt;szName == NULL) {
<FONT COLOR="#40F628">0766:</FONT>         hr = E_OUTOFMEMORY;<FONT COLOR="#008000">// メモリ不足</FONT>
<FONT COLOR="#40F628">0767:</FONT>         <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0768:</FONT>     }
<FONT COLOR="#40F628">0769:</FONT>     memcpy(pdeMesh-&gt;szName, m_szPath, cchFileName+1);
<FONT COLOR="#40F628">0770:</FONT> 
<FONT COLOR="#40F628">0771:</FONT>     <FONT COLOR="#008000">// ------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0772:</FONT>     <FONT COLOR="#008000">// 現在登録されているモデルを削除し。読み込んだモデルを選択オブジェクトにする</FONT>
<FONT COLOR="#40F628">0773:</FONT>     _DeleteSelectedMesh();
<FONT COLOR="#40F628">0774:</FONT>     m_pdeMesh = pdeMesh;
<FONT COLOR="#40F628">0775:</FONT>     
<FONT COLOR="#40F628">0776:</FONT>     <FONT COLOR="#008000">// ------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0777:</FONT>     <FONT COLOR="#008000">// ときどき使うのでバウンディング球を作成しておく</FONT>
<FONT COLOR="#40F628">0778:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pdeMesh-&gt;CalculateBoundingSphere())) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0779:</FONT>     
<FONT COLOR="#40F628">0780:</FONT>     <FONT COLOR="#008000">// 射影行列を設定しておく</FONT>
<FONT COLOR="#40F628">0781:</FONT>     _SetProjectionMatrix();
<FONT COLOR="#40F628">0782:</FONT>     
<FONT COLOR="#40F628">0783:</FONT>     <FONT COLOR="#008000">// 現在の時間とループするフレーム数を設定する</FONT>
<FONT COLOR="#40F628">0784:</FONT>     m_pdeMesh-&gt;fCurTime = 0.0f;
<FONT COLOR="#40F628">0785:</FONT>     
<FONT COLOR="#40F628">0786:</FONT>     <FONT COLOR="#008000">// アニメをしないときの（全体移動の）行列を保存しておく</FONT>
<FONT COLOR="#40F628">0787:</FONT>     D3DXMatrixTranslation(&amp;m_pdeMesh-&gt;pframeRoot-&gt;matRot,
<FONT COLOR="#40F628">0788:</FONT>                             -pdeMesh-&gt;vCenter.x,
<FONT COLOR="#40F628">0789:</FONT>                             -pdeMesh-&gt;vCenter.y,
<FONT COLOR="#40F628">0790:</FONT>                             -pdeMesh-&gt;vCenter.z);
<FONT COLOR="#40F628">0791:</FONT>     m_pdeMesh-&gt;pframeRoot-&gt;matRotOrig = m_pdeMesh-&gt;pframeRoot-&gt;matRot;
<FONT COLOR="#40F628">0792:</FONT>     
<FONT COLOR="#40F628">0793:</FONT> e_Exit:
<FONT COLOR="#40F628">0794:</FONT>     <FONT COLOR="#008000">// もう使わないものを開放</FONT>
<FONT COLOR="#40F628">0795:</FONT>     RELEASE(pxofobjCur);
<FONT COLOR="#40F628">0796:</FONT>     RELEASE(pxofenum);
<FONT COLOR="#40F628">0797:</FONT>     RELEASE(pxofapi);
<FONT COLOR="#40F628">0798:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">delete</FONT> pdeMesh;
<FONT COLOR="#40F628">0799:</FONT>     
<FONT COLOR="#40F628">0800:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">0801:</FONT> }
<FONT COLOR="#40F628">0802:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0803:</FONT> <FONT COLOR="#008000">// 骨の構造の解読</FONT>
<FONT COLOR="#40F628">0804:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0805:</FONT> HRESULT SFrame::FindBones(SDrawElement *pde)
<FONT COLOR="#40F628">0806:</FONT> {
<FONT COLOR="#40F628">0807:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">0808:</FONT>     
<FONT COLOR="#40F628">0809:</FONT>     <FONT COLOR="#0000FF">for</FONT>(SMeshContainer *pMc=<FONT COLOR="#0000FF">this</FONT>-&gt;pmcMesh ; pMc ; pMc=pMc-&gt;pmcNext ){
<FONT COLOR="#40F628">0810:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pMc-&gt;m_pSkinMesh) {
<FONT COLOR="#40F628">0811:</FONT>             <FONT COLOR="#0000FF">char</FONT>** pBoneName = <FONT COLOR="#0000FF">static_cast</FONT>&lt;<FONT COLOR="#0000FF">char</FONT>**&gt;(pMc-&gt;m_pBoneNamesBuf-&gt;GetBufferPointer());
<FONT COLOR="#40F628">0812:</FONT>             <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; pMc-&gt;m_pSkinMesh-&gt;GetNumBones(); ++i) {
<FONT COLOR="#40F628">0813:</FONT>                 <FONT COLOR="#008000">// 骨のフレームの行列を骨の行列に設定する</FONT>
<FONT COLOR="#40F628">0814:</FONT>                 pMc-&gt;m_pBoneMatrix[i] = &amp;(pde-&gt;FindFrame(pBoneName[i])-&gt;matCombined);
<FONT COLOR="#40F628">0815:</FONT>             }
<FONT COLOR="#40F628">0816:</FONT>         }
<FONT COLOR="#40F628">0817:</FONT>     }
<FONT COLOR="#40F628">0818:</FONT>     
<FONT COLOR="#40F628">0819:</FONT>     <FONT COLOR="#008000">// 子供や子供兄弟も作成する</FONT>
<FONT COLOR="#40F628">0820:</FONT>     <FONT COLOR="#0000FF">for</FONT>(SFrame *pChild=<FONT COLOR="#0000FF">this</FONT>-&gt;pframeFirstChild ; pChild ; pChild = pChild-&gt;pframeSibling ){
<FONT COLOR="#40F628">0821:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pChild-&gt;FindBones(pde))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">0822:</FONT>     }
<FONT COLOR="#40F628">0823:</FONT>     
<FONT COLOR="#40F628">0824:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">0825:</FONT> }
<FONT COLOR="#40F628">0826:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0827:</FONT> <FONT COLOR="#008000">// フレームの読み込み</FONT>
<FONT COLOR="#40F628">0828:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0829:</FONT> HRESULT SFrame::LoadFrames(LPDIRECTXFILEDATA pxofobjCur, SDrawElement *pde,
<FONT COLOR="#40F628">0830:</FONT>                       DWORD options, CSkinModel &amp;model)
<FONT COLOR="#40F628">0831:</FONT> {
<FONT COLOR="#40F628">0832:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">0833:</FONT>     LPDIRECTXFILEDATA pxofobjChild = NULL;
<FONT COLOR="#40F628">0834:</FONT>     LPDIRECTXFILEOBJECT pxofChild = NULL;
<FONT COLOR="#40F628">0835:</FONT>     <FONT COLOR="#0000FF">const</FONT> GUID *type;
<FONT COLOR="#40F628">0836:</FONT>     DWORD cbSize;
<FONT COLOR="#40F628">0837:</FONT>     D3DXMATRIX *pmatNew;
<FONT COLOR="#40F628">0838:</FONT>     DWORD cchName;
<FONT COLOR="#40F628">0839:</FONT>     
<FONT COLOR="#40F628">0840:</FONT>     <FONT COLOR="#008000">// タイプを調べて、種類に応じたロードを行う</FONT>
<FONT COLOR="#40F628">0841:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjCur-&gt;GetType(&amp;type))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0842:</FONT>     
<FONT COLOR="#40F628">0843:</FONT>     <FONT COLOR="#0000FF">if</FONT>(TID_D3DRMMesh==*type){
<FONT COLOR="#40F628">0844:</FONT>         <FONT COLOR="#008000">// ★D3D RM の頃からの伝統ある（？）メッシュファイル</FONT>
<FONT COLOR="#40F628">0845:</FONT>         hr = <FONT COLOR="#0000FF">this</FONT>-&gt;_LoadMesh(pxofobjCur, options, model);
<FONT COLOR="#40F628">0846:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr))<FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0847:</FONT>     }<FONT COLOR="#0000FF">else</FONT>
<FONT COLOR="#40F628">0848:</FONT>     <FONT COLOR="#0000FF">if</FONT>(TID_D3DRMFrameTransformMatrix==*type){
<FONT COLOR="#40F628">0849:</FONT>         <FONT COLOR="#008000">// ★姿勢行列</FONT>
<FONT COLOR="#40F628">0850:</FONT>         hr = pxofobjCur-&gt;GetData(NULL, &amp;cbSize, (PVOID*)&amp;pmatNew);
<FONT COLOR="#40F628">0851:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0852:</FONT>         <FONT COLOR="#008000">// フレームを呼び出した（親の）フレームの行列を設定する</FONT>
<FONT COLOR="#40F628">0853:</FONT>         <FONT COLOR="#0000FF">this</FONT>-&gt;matRot = *pmatNew;
<FONT COLOR="#40F628">0854:</FONT>         <FONT COLOR="#0000FF">this</FONT>-&gt;matRotOrig = *pmatNew;
<FONT COLOR="#40F628">0855:</FONT>     }<FONT COLOR="#0000FF">else</FONT>
<FONT COLOR="#40F628">0856:</FONT>     <FONT COLOR="#0000FF">if</FONT>(TID_D3DRMAnimationSet==*type){
<FONT COLOR="#40F628">0857:</FONT>         <FONT COLOR="#008000">// ★アニメーションの集合</FONT>
<FONT COLOR="#40F628">0858:</FONT>         <FONT COLOR="#0000FF">this</FONT>-&gt;_LoadAnimationSet(pxofobjCur, pde, options, model);
<FONT COLOR="#40F628">0859:</FONT>     }<FONT COLOR="#0000FF">else</FONT>
<FONT COLOR="#40F628">0860:</FONT>     <FONT COLOR="#0000FF">if</FONT>(TID_D3DRMAnimation==*type){
<FONT COLOR="#40F628">0861:</FONT>         <FONT COLOR="#008000">// ★アニメーション</FONT>
<FONT COLOR="#40F628">0862:</FONT>         <FONT COLOR="#0000FF">this</FONT>-&gt;_LoadAnimation(pxofobjCur, pde, options, model);
<FONT COLOR="#40F628">0863:</FONT>     }<FONT COLOR="#0000FF">else</FONT>
<FONT COLOR="#40F628">0864:</FONT>     <FONT COLOR="#0000FF">if</FONT>(TID_D3DRMFrame==*type){
<FONT COLOR="#40F628">0865:</FONT>         <FONT COLOR="#008000">// ★さらに新規フレーム</FONT>
<FONT COLOR="#40F628">0866:</FONT>         <FONT COLOR="#008000">// メモリ確保</FONT>
<FONT COLOR="#40F628">0867:</FONT>         SFrame *pframeCur;
<FONT COLOR="#40F628">0868:</FONT>         <FONT COLOR="#0000FF">if</FONT> (NULL == (pframeCur = <FONT COLOR="#0000FF">new</FONT> SFrame())) {
<FONT COLOR="#40F628">0869:</FONT>             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0870:</FONT>         }
<FONT COLOR="#40F628">0871:</FONT>         <FONT COLOR="#008000">// 名前があれば名前を読み込む</FONT>
<FONT COLOR="#40F628">0872:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjCur-&gt;GetName(NULL, &amp;cchName)))   <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0873:</FONT>         <FONT COLOR="#0000FF">if</FONT> (cchName &gt; 0) {
<FONT COLOR="#40F628">0874:</FONT>             <FONT COLOR="#0000FF">if</FONT> (NULL == (pframeCur-&gt;szName = <FONT COLOR="#0000FF">new</FONT> <FONT COLOR="#0000FF">char</FONT>[cchName])) {
<FONT COLOR="#40F628">0875:</FONT>                 hr = E_OUTOFMEMORY;
<FONT COLOR="#40F628">0876:</FONT>                 <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0877:</FONT>             }
<FONT COLOR="#40F628">0878:</FONT>             <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjCur-&gt;GetName(pframeCur-&gt;szName, &amp;cchName))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0879:</FONT>         }
<FONT COLOR="#40F628">0880:</FONT>         <FONT COLOR="#008000">// 新規フレームの追加</FONT>
<FONT COLOR="#40F628">0881:</FONT>         <FONT COLOR="#0000FF">this</FONT>-&gt;AddFrame(pframeCur);
<FONT COLOR="#40F628">0882:</FONT>         
<FONT COLOR="#40F628">0883:</FONT>         <FONT COLOR="#008000">// 子供のデータをがんがん読み込む</FONT>
<FONT COLOR="#40F628">0884:</FONT>         <FONT COLOR="#0000FF">while</FONT> (SUCCEEDED(pxofobjCur-&gt;GetNextObject(&amp;pxofChild))) {
<FONT COLOR="#40F628">0885:</FONT>             hr = pxofChild-&gt;QueryInterface(IID_IDirectXFileData,(LPVOID *)&amp;pxofobjChild);
<FONT COLOR="#40F628">0886:</FONT>             <FONT COLOR="#0000FF">if</FONT> (SUCCEEDED(hr)) {<FONT COLOR="#008000">// 子供に FileData を要求して、FileData があったら再起的に読み込む</FONT>
<FONT COLOR="#40F628">0887:</FONT>                 hr = pframeCur-&gt;LoadFrames(pxofobjChild, pde, options, model);
<FONT COLOR="#40F628">0888:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0889:</FONT>                 RELEASE(pxofobjChild);
<FONT COLOR="#40F628">0890:</FONT>             }
<FONT COLOR="#40F628">0891:</FONT>             RELEASE(pxofChild);
<FONT COLOR="#40F628">0892:</FONT>         }
<FONT COLOR="#40F628">0893:</FONT>     }
<FONT COLOR="#40F628">0894:</FONT>     
<FONT COLOR="#40F628">0895:</FONT> e_Exit:
<FONT COLOR="#40F628">0896:</FONT>     RELEASE(pxofobjChild);
<FONT COLOR="#40F628">0897:</FONT>     RELEASE(pxofChild);
<FONT COLOR="#40F628">0898:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">0899:</FONT> }
<FONT COLOR="#40F628">0900:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0901:</FONT> <FONT COLOR="#008000">// モデルの読み込み</FONT>
<FONT COLOR="#40F628">0902:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">0903:</FONT> HRESULT SFrame::_LoadMesh(LPDIRECTXFILEDATA pxofobjCur, DWORD options, CSkinModel &amp;model)
<FONT COLOR="#40F628">0904:</FONT> {
<FONT COLOR="#40F628">0905:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">0906:</FONT>     SMeshContainer *pmcMesh = NULL;
<FONT COLOR="#40F628">0907:</FONT>     LPD3DXBUFFER pbufMaterials = NULL;
<FONT COLOR="#40F628">0908:</FONT>     LPD3DXBUFFER pbufAdjacency = NULL;
<FONT COLOR="#40F628">0909:</FONT>     DWORD cchName;
<FONT COLOR="#40F628">0910:</FONT>     UINT cFaces;
<FONT COLOR="#40F628">0911:</FONT>     LPDWORD pAdjacencyIn;
<FONT COLOR="#40F628">0912:</FONT>     
<FONT COLOR="#40F628">0913:</FONT>     <FONT COLOR="#008000">// メモリの確保</FONT>
<FONT COLOR="#40F628">0914:</FONT>     <FONT COLOR="#0000FF">if</FONT> (NULL == (pmcMesh = <FONT COLOR="#0000FF">new</FONT> SMeshContainer())) {
<FONT COLOR="#40F628">0915:</FONT>         hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0916:</FONT>     }
<FONT COLOR="#40F628">0917:</FONT>     
<FONT COLOR="#40F628">0918:</FONT>     <FONT COLOR="#008000">// 名前を調べる</FONT>
<FONT COLOR="#40F628">0919:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjCur-&gt;GetName(NULL, &amp;cchName)))   <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0920:</FONT>     <FONT COLOR="#0000FF">if</FONT> (cchName &gt; 0) {
<FONT COLOR="#40F628">0921:</FONT>         <FONT COLOR="#0000FF">if</FONT> (NULL == (pmcMesh-&gt;szName=<FONT COLOR="#0000FF">new</FONT> <FONT COLOR="#0000FF">char</FONT>[cchName])) {
<FONT COLOR="#40F628">0922:</FONT>             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0923:</FONT>         }
<FONT COLOR="#40F628">0924:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr=pxofobjCur-&gt;GetName(pmcMesh-&gt;szName, &amp;cchName)))  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0925:</FONT>     }
<FONT COLOR="#40F628">0926:</FONT>     <FONT COLOR="#008000">// XFile を読み込む</FONT>
<FONT COLOR="#40F628">0927:</FONT>     hr = D3DXLoadSkinMeshFromXof(pxofobjCur, options, model.GetDevice(), &amp;pbufAdjacency, &amp;pbufMaterials, &amp;pmcMesh-&gt;cMaterials, 
<FONT COLOR="#40F628">0928:</FONT>         &amp;pmcMesh-&gt;m_pBoneNamesBuf, &amp;pmcMesh-&gt;m_pBoneOffsetBuf, &amp;pmcMesh-&gt;m_pSkinMesh);
<FONT COLOR="#40F628">0929:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) {
<FONT COLOR="#40F628">0930:</FONT>         <FONT COLOR="#0000FF">if</FONT> (hr == D3DXERR_LOADEDMESHASNODATA) hr = S_OK;
<FONT COLOR="#40F628">0931:</FONT>         <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0932:</FONT>     }
<FONT COLOR="#40F628">0933:</FONT>     
<FONT COLOR="#40F628">0934:</FONT>     <FONT COLOR="#008000">// 各ポリゴンに関する隣接面の情報をコピーする</FONT>
<FONT COLOR="#40F628">0935:</FONT>     cFaces = pmcMesh-&gt;m_pSkinMesh-&gt;GetNumFaces();
<FONT COLOR="#40F628">0936:</FONT>     pAdjacencyIn = <FONT COLOR="#0000FF">static_cast</FONT>&lt;LPDWORD&gt;(pbufAdjacency-&gt;GetBufferPointer());
<FONT COLOR="#40F628">0937:</FONT>     <FONT COLOR="#0000FF">if</FONT> (NULL == (pmcMesh-&gt;m_rgiAdjacency=<FONT COLOR="#0000FF">new</FONT> DWORD[cFaces * 3])) {
<FONT COLOR="#40F628">0938:</FONT>         hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0939:</FONT>     }
<FONT COLOR="#40F628">0940:</FONT>     memcpy(pmcMesh-&gt;m_rgiAdjacency, pAdjacencyIn, cFaces * 3 * <FONT COLOR="#0000FF">sizeof</FONT>(DWORD));
<FONT COLOR="#40F628">0941:</FONT> 
<FONT COLOR="#40F628">0942:</FONT>     <FONT COLOR="#008000">// スキンのデータを処理する</FONT>
<FONT COLOR="#40F628">0943:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_pSkinMesh-&gt;GetNumBones()) {
<FONT COLOR="#40F628">0944:</FONT>         <FONT COLOR="#008000">// 骨の数の計算</FONT>
<FONT COLOR="#40F628">0945:</FONT>         model.SetMaxBorns(max(pmcMesh-&gt;m_pSkinMesh-&gt;GetNumBones(), model.GetMaxBorns()));
<FONT COLOR="#40F628">0946:</FONT>         <FONT COLOR="#008000">// 骨で使う行列分のメモリの確保</FONT>
<FONT COLOR="#40F628">0947:</FONT>         pmcMesh-&gt;m_pBoneMatrix = <FONT COLOR="#0000FF">new</FONT> D3DXMATRIX*[pmcMesh-&gt;m_pSkinMesh-&gt;GetNumBones()];
<FONT COLOR="#40F628">0948:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_pBoneMatrix == NULL) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0949:</FONT>         pmcMesh-&gt;m_pBoneOffsetMat = <FONT COLOR="#0000FF">reinterpret_cast</FONT>&lt;D3DXMATRIX*&gt;(pmcMesh-&gt;m_pBoneOffsetBuf-&gt;GetBufferPointer());
<FONT COLOR="#40F628">0950:</FONT>         <FONT COLOR="#008000">// 実際に表示で使うための（取り扱いやすい）メッシュを構成する</FONT>
<FONT COLOR="#40F628">0951:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = model.GenerateMesh(pmcMesh))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0952:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">0953:</FONT>         pmcMesh-&gt;m_pSkinMesh-&gt;GetOriginalMesh(&amp;(pmcMesh-&gt;pMesh));
<FONT COLOR="#40F628">0954:</FONT>         pmcMesh-&gt;m_pSkinMesh-&gt;Release();        <FONT COLOR="#008000">// もう使わないので開放</FONT>
<FONT COLOR="#40F628">0955:</FONT>         pmcMesh-&gt;m_pSkinMesh = NULL;            <FONT COLOR="#008000">// 骨がないのでスキンメッシュではない</FONT>
<FONT COLOR="#40F628">0956:</FONT>         pmcMesh-&gt;cpattr = pmcMesh-&gt;cMaterials;  <FONT COLOR="#008000">// 質感を引っ張る</FONT>
<FONT COLOR="#40F628">0957:</FONT>     }
<FONT COLOR="#40F628">0958:</FONT>     
<FONT COLOR="#40F628">0959:</FONT>     <FONT COLOR="#0000FF">if</FONT> ((pbufMaterials == NULL) || (pmcMesh-&gt;cMaterials == 0)) {
<FONT COLOR="#40F628">0960:</FONT>         <FONT COLOR="#008000">// 質感情報なければ適当なものを作成</FONT>
<FONT COLOR="#40F628">0961:</FONT>         pmcMesh-&gt;rgMaterials = <FONT COLOR="#0000FF">new</FONT> D3DMATERIAL8[1];
<FONT COLOR="#40F628">0962:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;rgMaterials == NULL) {
<FONT COLOR="#40F628">0963:</FONT>             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0964:</FONT>         }
<FONT COLOR="#40F628">0965:</FONT>         memset(pmcMesh-&gt;rgMaterials, 0, <FONT COLOR="#0000FF">sizeof</FONT>(D3DMATERIAL8));
<FONT COLOR="#40F628">0966:</FONT>         pmcMesh-&gt;rgMaterials[0].Diffuse.r = 0.5f;
<FONT COLOR="#40F628">0967:</FONT>         pmcMesh-&gt;rgMaterials[0].Diffuse.g = 0.5f;
<FONT COLOR="#40F628">0968:</FONT>         pmcMesh-&gt;rgMaterials[0].Diffuse.b = 0.5f;
<FONT COLOR="#40F628">0969:</FONT>         pmcMesh-&gt;rgMaterials[0].Specular = pmcMesh-&gt;rgMaterials[0].Diffuse;
<FONT COLOR="#40F628">0970:</FONT>         <FONT COLOR="#008000">// ダミーテクスチャー</FONT>
<FONT COLOR="#40F628">0971:</FONT>         pmcMesh-&gt;pTextures = <FONT COLOR="#0000FF">new</FONT> LPDIRECT3DTEXTURE8[1];
<FONT COLOR="#40F628">0972:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;pTextures == NULL) {
<FONT COLOR="#40F628">0973:</FONT>             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0974:</FONT>         }
<FONT COLOR="#40F628">0975:</FONT>         pmcMesh-&gt;pTextures[0] = NULL;
<FONT COLOR="#40F628">0976:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">0977:</FONT>         <FONT COLOR="#008000">// 質感情報あれば読み込む</FONT>
<FONT COLOR="#40F628">0978:</FONT>         pmcMesh-&gt;rgMaterials = <FONT COLOR="#0000FF">new</FONT> D3DMATERIAL8[pmcMesh-&gt;cMaterials];
<FONT COLOR="#40F628">0979:</FONT>         pmcMesh-&gt;pTextures = <FONT COLOR="#0000FF">new</FONT> LPDIRECT3DTEXTURE8[pmcMesh-&gt;cMaterials];
<FONT COLOR="#40F628">0980:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;rgMaterials == NULL || pmcMesh-&gt;pTextures == NULL) {
<FONT COLOR="#40F628">0981:</FONT>             hr = E_OUTOFMEMORY;
<FONT COLOR="#40F628">0982:</FONT>             <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">0983:</FONT>         }
<FONT COLOR="#40F628">0984:</FONT>         
<FONT COLOR="#40F628">0985:</FONT>         LPD3DXMATERIAL pMaterials = (LPD3DXMATERIAL)pbufMaterials-&gt;GetBufferPointer();
<FONT COLOR="#40F628">0986:</FONT>         
<FONT COLOR="#40F628">0987:</FONT>         <FONT COLOR="#0000FF">for</FONT> (UINT i = 0; i &lt; pmcMesh-&gt;cMaterials; i++) {
<FONT COLOR="#40F628">0988:</FONT>             pmcMesh-&gt;rgMaterials[i] = pMaterials[i].MatD3D;
<FONT COLOR="#40F628">0989:</FONT>             <FONT COLOR="#008000">// テクスチャーがあればロード</FONT>
<FONT COLOR="#40F628">0990:</FONT>             pmcMesh-&gt;pTextures[i] = NULL;
<FONT COLOR="#40F628">0991:</FONT>             <FONT COLOR="#0000FF">if</FONT> (pMaterials[i].pTextureFilename != NULL) {
<FONT COLOR="#40F628">0992:</FONT>                 hr = D3DXCreateTextureFromFile(model.GetDevice(), pMaterials[i].pTextureFilename, &amp;(pmcMesh-&gt;pTextures[i]));
<FONT COLOR="#40F628">0993:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) pmcMesh-&gt;pTextures[i] = NULL;
<FONT COLOR="#40F628">0994:</FONT>             }
<FONT COLOR="#40F628">0995:</FONT>         }
<FONT COLOR="#40F628">0996:</FONT>     }
<FONT COLOR="#40F628">0997:</FONT>     
<FONT COLOR="#40F628">0998:</FONT>     <FONT COLOR="#008000">// 親のフレームにメッシュを登録する</FONT>
<FONT COLOR="#40F628">0999:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;AddMesh(pmcMesh);
<FONT COLOR="#40F628">1000:</FONT>     pmcMesh = NULL;
<FONT COLOR="#40F628">1001:</FONT>     
<FONT COLOR="#40F628">1002:</FONT> e_Exit:
<FONT COLOR="#40F628">1003:</FONT>     <FONT COLOR="#0000FF">delete</FONT> pmcMesh;
<FONT COLOR="#40F628">1004:</FONT>     
<FONT COLOR="#40F628">1005:</FONT>     RELEASE(pbufAdjacency);
<FONT COLOR="#40F628">1006:</FONT>     RELEASE(pbufMaterials);
<FONT COLOR="#40F628">1007:</FONT> 
<FONT COLOR="#40F628">1008:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1009:</FONT> }
<FONT COLOR="#40F628">1010:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1011:</FONT> <FONT COLOR="#008000">// アニメーションの集合のロード</FONT>
<FONT COLOR="#40F628">1012:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1013:</FONT> HRESULT SFrame::_LoadAnimationSet(LPDIRECTXFILEDATA pxofobjCur, SDrawElement *pde,
<FONT COLOR="#40F628">1014:</FONT>                         DWORD options, CSkinModel &amp;model)
<FONT COLOR="#40F628">1015:</FONT> {
<FONT COLOR="#40F628">1016:</FONT>     SFrame *pframeCur;
<FONT COLOR="#40F628">1017:</FONT>     <FONT COLOR="#0000FF">const</FONT> GUID *type;
<FONT COLOR="#40F628">1018:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1019:</FONT>     LPDIRECTXFILEDATA pxofobjChild = NULL;
<FONT COLOR="#40F628">1020:</FONT>     LPDIRECTXFILEOBJECT pxofChild = NULL;
<FONT COLOR="#40F628">1021:</FONT>     DWORD cchName;
<FONT COLOR="#40F628">1022:</FONT>     
<FONT COLOR="#40F628">1023:</FONT>     <FONT COLOR="#008000">// 新規にフレームを追加</FONT>
<FONT COLOR="#40F628">1024:</FONT>     <FONT COLOR="#0000FF">if</FONT> (NULL == (pframeCur=<FONT COLOR="#0000FF">new</FONT> SFrame())) {
<FONT COLOR="#40F628">1025:</FONT>         hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1026:</FONT>     }
<FONT COLOR="#40F628">1027:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;AddFrame(pframeCur);
<FONT COLOR="#40F628">1028:</FONT> 
<FONT COLOR="#40F628">1029:</FONT>     pframeCur-&gt;bAnimationFrame = <FONT COLOR="#0000FF">true</FONT>;  <FONT COLOR="#008000">// アニメーションのフレームであることを宣言</FONT>
<FONT COLOR="#40F628">1030:</FONT>     
<FONT COLOR="#40F628">1031:</FONT>     <FONT COLOR="#008000">// 名前を読み込む</FONT>
<FONT COLOR="#40F628">1032:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjCur-&gt;GetName(NULL, &amp;cchName))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1033:</FONT>     <FONT COLOR="#0000FF">if</FONT> (cchName &gt; 0) {
<FONT COLOR="#40F628">1034:</FONT>         <FONT COLOR="#0000FF">if</FONT> (NULL == (pframeCur-&gt;szName = <FONT COLOR="#0000FF">new</FONT> <FONT COLOR="#0000FF">char</FONT>[cchName])) {
<FONT COLOR="#40F628">1035:</FONT>             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1036:</FONT>         }
<FONT COLOR="#40F628">1037:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjCur-&gt;GetName(pframeCur-&gt;szName, &amp;cchName))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1038:</FONT>     }
<FONT COLOR="#40F628">1039:</FONT>     
<FONT COLOR="#40F628">1040:</FONT>     <FONT COLOR="#008000">// 読める限りのデータを読んで、アニメーションのデータをロードする</FONT>
<FONT COLOR="#40F628">1041:</FONT>     <FONT COLOR="#0000FF">while</FONT> (SUCCEEDED(pxofobjCur-&gt;GetNextObject(&amp;pxofChild))) {
<FONT COLOR="#40F628">1042:</FONT>         hr = pxofChild-&gt;QueryInterface(IID_IDirectXFileData,(LPVOID *)&amp;pxofobjChild);
<FONT COLOR="#40F628">1043:</FONT>         <FONT COLOR="#0000FF">if</FONT> (SUCCEEDED(hr)) {
<FONT COLOR="#40F628">1044:</FONT>             <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjChild-&gt;GetType(&amp;type))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1045:</FONT>             
<FONT COLOR="#40F628">1046:</FONT>             <FONT COLOR="#0000FF">if</FONT>( TID_D3DRMAnimation == *type ) {<FONT COLOR="#008000">// アニメのデータだけ</FONT>
<FONT COLOR="#40F628">1047:</FONT>                 hr = pframeCur-&gt;_LoadAnimation(pxofobjChild, pde, options, model);
<FONT COLOR="#40F628">1048:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1049:</FONT>             }
<FONT COLOR="#40F628">1050:</FONT>             RELEASE(pxofobjChild);
<FONT COLOR="#40F628">1051:</FONT>         }
<FONT COLOR="#40F628">1052:</FONT>         RELEASE(pxofChild);
<FONT COLOR="#40F628">1053:</FONT>     }
<FONT COLOR="#40F628">1054:</FONT>     
<FONT COLOR="#40F628">1055:</FONT> e_Exit:
<FONT COLOR="#40F628">1056:</FONT>     RELEASE(pxofobjChild);
<FONT COLOR="#40F628">1057:</FONT>     RELEASE(pxofChild);
<FONT COLOR="#40F628">1058:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1059:</FONT> }
<FONT COLOR="#40F628">1060:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1061:</FONT> <FONT COLOR="#008000">// アニメのロード</FONT>
<FONT COLOR="#40F628">1062:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1063:</FONT> HRESULT SFrame::_LoadAnimation(LPDIRECTXFILEDATA pxofobjCur, SDrawElement *pde,
<FONT COLOR="#40F628">1064:</FONT>                      DWORD options, CSkinModel &amp;model)
<FONT COLOR="#40F628">1065:</FONT> {
<FONT COLOR="#40F628">1066:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1067:</FONT>     SRotateKeyXFile   *pFileRotateKey;
<FONT COLOR="#40F628">1068:</FONT>     SScaleKeyXFile    *pFileScaleKey;
<FONT COLOR="#40F628">1069:</FONT>     SPositionKeyXFile *pFilePosKey;
<FONT COLOR="#40F628">1070:</FONT>     SMatrixKeyXFile   *pFileMatrixKey;
<FONT COLOR="#40F628">1071:</FONT>     SFrame *pframeCur;
<FONT COLOR="#40F628">1072:</FONT>     LPDIRECTXFILEDATA pxofobjChild = NULL;
<FONT COLOR="#40F628">1073:</FONT>     LPDIRECTXFILEOBJECT pxofChild = NULL;
<FONT COLOR="#40F628">1074:</FONT>     LPDIRECTXFILEDATAREFERENCE pxofobjChildRef = NULL;
<FONT COLOR="#40F628">1075:</FONT>     <FONT COLOR="#0000FF">const</FONT> GUID *type;
<FONT COLOR="#40F628">1076:</FONT>     DWORD dwSize;
<FONT COLOR="#40F628">1077:</FONT>     PBYTE pData;
<FONT COLOR="#40F628">1078:</FONT>     DWORD dwKeyType;
<FONT COLOR="#40F628">1079:</FONT>     DWORD cKeys;
<FONT COLOR="#40F628">1080:</FONT>     DWORD iKey;
<FONT COLOR="#40F628">1081:</FONT>     DWORD cchName;
<FONT COLOR="#40F628">1082:</FONT>     <FONT COLOR="#0000FF">char</FONT> *szFrameName;
<FONT COLOR="#40F628">1083:</FONT>     
<FONT COLOR="#40F628">1084:</FONT>     <FONT COLOR="#008000">// 新規にフレームを追加</FONT>
<FONT COLOR="#40F628">1085:</FONT>     <FONT COLOR="#0000FF">if</FONT> (NULL == (pframeCur = <FONT COLOR="#0000FF">new</FONT> SFrame())) {
<FONT COLOR="#40F628">1086:</FONT>         hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1087:</FONT>     }
<FONT COLOR="#40F628">1088:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;AddFrame(pframeCur);
<FONT COLOR="#40F628">1089:</FONT>     pde-&gt;AddAnimationFrame(pframeCur);  <FONT COLOR="#008000">// SDrawElement にアニメを追加</FONT>
<FONT COLOR="#40F628">1090:</FONT>     
<FONT COLOR="#40F628">1091:</FONT>     pframeCur-&gt;bAnimationFrame = <FONT COLOR="#0000FF">true</FONT>;  <FONT COLOR="#008000">// アニメーションのフレームであることを宣言</FONT>
<FONT COLOR="#40F628">1092:</FONT>     
<FONT COLOR="#40F628">1093:</FONT>     <FONT COLOR="#008000">// 読める限りのデータを読んで、アニメーションのデータをロードする</FONT>
<FONT COLOR="#40F628">1094:</FONT>     <FONT COLOR="#0000FF">while</FONT> (SUCCEEDED(pxofobjCur-&gt;GetNextObject(&amp;pxofChild))) {
<FONT COLOR="#40F628">1095:</FONT>         <FONT COLOR="#008000">// 参照をしらべる</FONT>
<FONT COLOR="#40F628">1096:</FONT>         hr = pxofChild-&gt;QueryInterface(IID_IDirectXFileDataReference,(LPVOID *)&amp;pxofobjChildRef);
<FONT COLOR="#40F628">1097:</FONT>         <FONT COLOR="#0000FF">if</FONT> (SUCCEEDED(hr)) {
<FONT COLOR="#40F628">1098:</FONT>             hr = pxofobjChildRef-&gt;Resolve(&amp;pxofobjChild);
<FONT COLOR="#40F628">1099:</FONT>             <FONT COLOR="#0000FF">if</FONT> (SUCCEEDED(hr)) {
<FONT COLOR="#40F628">1100:</FONT>                 <FONT COLOR="#008000">// タイプを調べて、フレームの情報だけを抜き出す</FONT>
<FONT COLOR="#40F628">1101:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjChild-&gt;GetType(&amp;type))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1102:</FONT>                 
<FONT COLOR="#40F628">1103:</FONT>                 <FONT COLOR="#0000FF">if</FONT>( TID_D3DRMFrame == *type ) {
<FONT COLOR="#40F628">1104:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (pframeCur-&gt;pframeToAnimate != NULL) {<FONT COLOR="#008000">// あるのか？</FONT>
<FONT COLOR="#40F628">1105:</FONT>                         hr = E_INVALIDARG;  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1106:</FONT>                     }
<FONT COLOR="#40F628">1107:</FONT>                     
<FONT COLOR="#40F628">1108:</FONT>                     <FONT COLOR="#008000">// 名前を読み込む</FONT>
<FONT COLOR="#40F628">1109:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjChild-&gt;GetName(NULL, &amp;cchName))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1110:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (cchName == 0) {
<FONT COLOR="#40F628">1111:</FONT>                         hr = E_INVALIDARG;  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1112:</FONT>                     }
<FONT COLOR="#40F628">1113:</FONT>                     szFrameName = (<FONT COLOR="#0000FF">char</FONT>*)_alloca(cchName);
<FONT COLOR="#40F628">1114:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (szFrameName == NULL) {
<FONT COLOR="#40F628">1115:</FONT>                         hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1116:</FONT>                     }
<FONT COLOR="#40F628">1117:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjChild-&gt;GetName(szFrameName, &amp;cchName))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1118:</FONT>                     
<FONT COLOR="#40F628">1119:</FONT>                     <FONT COLOR="#008000">// 名前からフレームを検索する</FONT>
<FONT COLOR="#40F628">1120:</FONT>                     pframeCur-&gt;pframeToAnimate = pde-&gt;FindFrame(szFrameName);
<FONT COLOR="#40F628">1121:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (pframeCur-&gt;pframeToAnimate == NULL) {
<FONT COLOR="#40F628">1122:</FONT>                         hr = E_INVALIDARG; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1123:</FONT>                     }
<FONT COLOR="#40F628">1124:</FONT>                 }
<FONT COLOR="#40F628">1125:</FONT>                 RELEASE(pxofobjChild);
<FONT COLOR="#40F628">1126:</FONT>             }
<FONT COLOR="#40F628">1127:</FONT>             RELEASE(pxofobjChildRef);
<FONT COLOR="#40F628">1128:</FONT>         } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">1129:</FONT>             <FONT COLOR="#008000">// 参照がなければデータを調べる</FONT>
<FONT COLOR="#40F628">1130:</FONT>             hr = pxofChild-&gt;QueryInterface(IID_IDirectXFileData,(LPVOID *)&amp;pxofobjChild);
<FONT COLOR="#40F628">1131:</FONT>             <FONT COLOR="#0000FF">if</FONT> (SUCCEEDED(hr))
<FONT COLOR="#40F628">1132:</FONT>             {
<FONT COLOR="#40F628">1133:</FONT>                 <FONT COLOR="#008000">// タイプを調べて、種類に応じた処理を行う</FONT>
<FONT COLOR="#40F628">1134:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjChild-&gt;GetType(&amp;type))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1135:</FONT>                 
<FONT COLOR="#40F628">1136:</FONT>                 <FONT COLOR="#0000FF">if</FONT> ( TID_D3DRMFrame == *type ) {<FONT COLOR="#008000">// フレーム</FONT>
<FONT COLOR="#40F628">1137:</FONT>                     hr = pframeCur-&gt;LoadFrames(pxofobjChild, pde, options, model);
<FONT COLOR="#40F628">1138:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1139:</FONT>                 } <FONT COLOR="#0000FF">else</FONT> <FONT COLOR="#0000FF">if</FONT> ( TID_D3DRMAnimationOptions == *type ) {
<FONT COLOR="#40F628">1140:</FONT>                     <FONT COLOR="#008000">// オプション（処理なし）</FONT>
<FONT COLOR="#40F628">1141:</FONT>                 } <FONT COLOR="#0000FF">else</FONT> <FONT COLOR="#0000FF">if</FONT> ( TID_D3DRMAnimationKey == *type ) {
<FONT COLOR="#40F628">1142:</FONT>                     <FONT COLOR="#008000">// アニメーションのキーフレームデータ</FONT>
<FONT COLOR="#40F628">1143:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pxofobjChild-&gt;GetData( NULL, &amp;dwSize, (PVOID*)&amp;pData ))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1144:</FONT>                     
<FONT COLOR="#40F628">1145:</FONT>                     dwKeyType = ((DWORD*)pData)[0];
<FONT COLOR="#40F628">1146:</FONT>                     cKeys = ((DWORD*)pData)[1];
<FONT COLOR="#40F628">1147:</FONT>                     
<FONT COLOR="#40F628">1148:</FONT>                     <FONT COLOR="#0000FF">switch</FONT>(dwKeyType){
<FONT COLOR="#40F628">1149:</FONT>                     <FONT COLOR="#0000FF">case</FONT> 0:<FONT COLOR="#008000">// 回転</FONT>
<FONT COLOR="#40F628">1150:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (pframeCur-&gt;m_pRotateKeys != NULL) {
<FONT COLOR="#40F628">1151:</FONT>                             hr = E_INVALIDARG;  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1152:</FONT>                         }
<FONT COLOR="#40F628">1153:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (NULL==(pframeCur-&gt;m_pRotateKeys = <FONT COLOR="#0000FF">new</FONT> SRotateKey[cKeys])) {
<FONT COLOR="#40F628">1154:</FONT>                             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1155:</FONT>                         }
<FONT COLOR="#40F628">1156:</FONT>                         pframeCur-&gt;m_cRotateKeys = cKeys;
<FONT COLOR="#40F628">1157:</FONT>                         pFileRotateKey =  (SRotateKeyXFile*)(pData + (<FONT COLOR="#0000FF">sizeof</FONT>(DWORD) * 2));
<FONT COLOR="#40F628">1158:</FONT>                         <FONT COLOR="#0000FF">for</FONT> (iKey = 0;iKey &lt; cKeys; iKey++) {
<FONT COLOR="#40F628">1159:</FONT>                             pframeCur-&gt;m_pRotateKeys[iKey].dwTime = pFileRotateKey-&gt;dwTime;
<FONT COLOR="#40F628">1160:</FONT>                             pframeCur-&gt;m_pRotateKeys[iKey].quatRotate.x = pFileRotateKey-&gt;x;
<FONT COLOR="#40F628">1161:</FONT>                             pframeCur-&gt;m_pRotateKeys[iKey].quatRotate.y = pFileRotateKey-&gt;y;
<FONT COLOR="#40F628">1162:</FONT>                             pframeCur-&gt;m_pRotateKeys[iKey].quatRotate.z = pFileRotateKey-&gt;z;
<FONT COLOR="#40F628">1163:</FONT>                             pframeCur-&gt;m_pRotateKeys[iKey].quatRotate.w = pFileRotateKey-&gt;w;
<FONT COLOR="#40F628">1164:</FONT>                             pFileRotateKey++;
<FONT COLOR="#40F628">1165:</FONT>                         }
<FONT COLOR="#40F628">1166:</FONT>                         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1167:</FONT>                     <FONT COLOR="#0000FF">case</FONT> 1:<FONT COLOR="#008000">// 拡大縮小</FONT>
<FONT COLOR="#40F628">1168:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (pframeCur-&gt;m_pScaleKeys != NULL) {
<FONT COLOR="#40F628">1169:</FONT>                             hr = E_INVALIDARG;  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1170:</FONT>                         }
<FONT COLOR="#40F628">1171:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (NULL==(pframeCur-&gt;m_pScaleKeys = <FONT COLOR="#0000FF">new</FONT> SScaleKey[cKeys])) {
<FONT COLOR="#40F628">1172:</FONT>                             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1173:</FONT>                         }
<FONT COLOR="#40F628">1174:</FONT>                         pframeCur-&gt;m_cScaleKeys = cKeys;
<FONT COLOR="#40F628">1175:</FONT>                         pFileScaleKey =  (SScaleKeyXFile*)(pData + (<FONT COLOR="#0000FF">sizeof</FONT>(DWORD) * 2));
<FONT COLOR="#40F628">1176:</FONT>                         <FONT COLOR="#0000FF">for</FONT> (iKey = 0;iKey &lt; cKeys; iKey++) {
<FONT COLOR="#40F628">1177:</FONT>                             pframeCur-&gt;m_pScaleKeys[iKey].dwTime = pFileScaleKey-&gt;dwTime;
<FONT COLOR="#40F628">1178:</FONT>                             pframeCur-&gt;m_pScaleKeys[iKey].vScale = pFileScaleKey-&gt;vScale;
<FONT COLOR="#40F628">1179:</FONT>                             pFileScaleKey++;
<FONT COLOR="#40F628">1180:</FONT>                         }
<FONT COLOR="#40F628">1181:</FONT>                         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1182:</FONT>                     <FONT COLOR="#0000FF">case</FONT> 2:<FONT COLOR="#008000">// 平行移動</FONT>
<FONT COLOR="#40F628">1183:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (pframeCur-&gt;m_pPositionKeys != NULL) {
<FONT COLOR="#40F628">1184:</FONT>                             hr = E_INVALIDARG;  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1185:</FONT>                         }
<FONT COLOR="#40F628">1186:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (NULL==(pframeCur-&gt;m_pPositionKeys = <FONT COLOR="#0000FF">new</FONT> SPositionKey[cKeys])) {
<FONT COLOR="#40F628">1187:</FONT>                             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1188:</FONT>                         }
<FONT COLOR="#40F628">1189:</FONT>                         pframeCur-&gt;m_cPositionKeys = cKeys;
<FONT COLOR="#40F628">1190:</FONT>                         pFilePosKey =  (SPositionKeyXFile*)(pData + (<FONT COLOR="#0000FF">sizeof</FONT>(DWORD) * 2));
<FONT COLOR="#40F628">1191:</FONT>                         <FONT COLOR="#0000FF">for</FONT> (iKey = 0;iKey &lt; cKeys; iKey++) {
<FONT COLOR="#40F628">1192:</FONT>                             pframeCur-&gt;m_pPositionKeys[iKey].dwTime = pFilePosKey-&gt;dwTime;
<FONT COLOR="#40F628">1193:</FONT>                             pframeCur-&gt;m_pPositionKeys[iKey].vPos = pFilePosKey-&gt;vPos;
<FONT COLOR="#40F628">1194:</FONT>                             pFilePosKey++;
<FONT COLOR="#40F628">1195:</FONT>                         }
<FONT COLOR="#40F628">1196:</FONT>                         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1197:</FONT>                     <FONT COLOR="#0000FF">case</FONT> 4:<FONT COLOR="#008000">// 行列そのもの</FONT>
<FONT COLOR="#40F628">1198:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (pframeCur-&gt;m_pMatrixKeys != NULL) {
<FONT COLOR="#40F628">1199:</FONT>                             hr = E_INVALIDARG;  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1200:</FONT>                         }
<FONT COLOR="#40F628">1201:</FONT>                         <FONT COLOR="#0000FF">if</FONT> (NULL==(pframeCur-&gt;m_pMatrixKeys = <FONT COLOR="#0000FF">new</FONT> SMatrixKey[cKeys])) {
<FONT COLOR="#40F628">1202:</FONT>                             hr = E_OUTOFMEMORY; <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1203:</FONT>                         }
<FONT COLOR="#40F628">1204:</FONT>                         pframeCur-&gt;m_cMatrixKeys = cKeys;
<FONT COLOR="#40F628">1205:</FONT>                         pFileMatrixKey =  (SMatrixKeyXFile*)(pData + (<FONT COLOR="#0000FF">sizeof</FONT>(DWORD) * 2));
<FONT COLOR="#40F628">1206:</FONT>                         <FONT COLOR="#0000FF">for</FONT> (iKey = 0;iKey &lt; cKeys; iKey++) {
<FONT COLOR="#40F628">1207:</FONT>                             pframeCur-&gt;m_pMatrixKeys[iKey].dwTime = pFileMatrixKey-&gt;dwTime;
<FONT COLOR="#40F628">1208:</FONT>                             pframeCur-&gt;m_pMatrixKeys[iKey].mat = pFileMatrixKey-&gt;mat;
<FONT COLOR="#40F628">1209:</FONT>                             pFileMatrixKey++;
<FONT COLOR="#40F628">1210:</FONT>                         }
<FONT COLOR="#40F628">1211:</FONT>                         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1212:</FONT>                     <FONT COLOR="#0000FF">default</FONT>:
<FONT COLOR="#40F628">1213:</FONT>                         hr = E_INVALIDARG;  <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1214:</FONT>                         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1215:</FONT>                     }
<FONT COLOR="#40F628">1216:</FONT>                 }
<FONT COLOR="#40F628">1217:</FONT>                 RELEASE(pxofobjChild);
<FONT COLOR="#40F628">1218:</FONT>             }
<FONT COLOR="#40F628">1219:</FONT>         }
<FONT COLOR="#40F628">1220:</FONT>         RELEASE(pxofChild);
<FONT COLOR="#40F628">1221:</FONT>     }
<FONT COLOR="#40F628">1222:</FONT>     
<FONT COLOR="#40F628">1223:</FONT> e_Exit:
<FONT COLOR="#40F628">1224:</FONT>     RELEASE(pxofobjChild);
<FONT COLOR="#40F628">1225:</FONT>     RELEASE(pxofChild);
<FONT COLOR="#40F628">1226:</FONT>     RELEASE(pxofobjChildRef);
<FONT COLOR="#40F628">1227:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1228:</FONT> }
<FONT COLOR="#40F628">1229:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1230:</FONT> <FONT COLOR="#008000">// メッシュの生成(D3DNONINDEXED)</FONT>
<FONT COLOR="#40F628">1231:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1232:</FONT> HRESULT CSkinModel::_GenerateMeshNonIndexed(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1233:</FONT> {
<FONT COLOR="#40F628">1234:</FONT>     LPD3DXBONECOMBINATION   rgBoneCombinations;
<FONT COLOR="#40F628">1235:</FONT> 
<FONT COLOR="#40F628">1236:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1237:</FONT>     hr = pmcMesh-&gt;m_pSkinMesh-&gt;ConvertToBlendedMesh
<FONT COLOR="#40F628">1238:</FONT>                                (
<FONT COLOR="#40F628">1239:</FONT>                                    D3DXMESH_MANAGED|D3DXMESHOPT_VERTEXCACHE, 
<FONT COLOR="#40F628">1240:</FONT>                                    pmcMesh-&gt;m_rgiAdjacency, 
<FONT COLOR="#40F628">1241:</FONT>                                    NULL, 
<FONT COLOR="#40F628">1242:</FONT>                                    &amp;pmcMesh-&gt;cpattr, 
<FONT COLOR="#40F628">1243:</FONT>                                    &amp;pmcMesh-&gt;m_pBoneCombinationBuf, 
<FONT COLOR="#40F628">1244:</FONT>                                    NULL,
<FONT COLOR="#40F628">1245:</FONT>                                    NULL,
<FONT COLOR="#40F628">1246:</FONT>                                    &amp;pmcMesh-&gt;pMesh
<FONT COLOR="#40F628">1247:</FONT>                                );
<FONT COLOR="#40F628">1248:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1249:</FONT> 
<FONT COLOR="#40F628">1250:</FONT>     <FONT COLOR="#008000">// calculate the max face influence count</FONT>
<FONT COLOR="#40F628">1251:</FONT> 
<FONT COLOR="#40F628">1252:</FONT>     <FONT COLOR="#0000FF">if</FONT> ((pmcMesh-&gt;pMesh-&gt;GetFVF() &amp; D3DFVF_POSITION_MASK) != D3DFVF_XYZ) {
<FONT COLOR="#40F628">1253:</FONT>         pmcMesh-&gt;m_maxFaceInfl = 1 + ((pmcMesh-&gt;pMesh-&gt;GetFVF() &amp; D3DFVF_POSITION_MASK) - D3DFVF_XYZRHW) / 2;
<FONT COLOR="#40F628">1254:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">1255:</FONT>         pmcMesh-&gt;m_maxFaceInfl = 1;
<FONT COLOR="#40F628">1256:</FONT>     }
<FONT COLOR="#40F628">1257:</FONT> 
<FONT COLOR="#40F628">1258:</FONT>     <FONT COLOR="#008000">/* If the device can only do 2 matrix blends, ConvertToBlendedMesh cannot approximate all meshes to it
<FONT COLOR="#40F628">1259:</FONT>        Thus we split the mesh in two parts: The part that uses at most 2 matrices and the rest. The first is
<FONT COLOR="#40F628">1260:</FONT>        drawn using the device's HW vertex processing and the rest is drawn using SW vertex processing. */</FONT>
<FONT COLOR="#40F628">1261:</FONT>     <FONT COLOR="#0000FF">if</FONT> (<FONT COLOR="#0000FF">this</FONT>-&gt;GetCaps()-&gt;MaxVertexBlendMatrices &lt;= 2) {
<FONT COLOR="#40F628">1262:</FONT>         <FONT COLOR="#008000">// calculate the index of the attribute table to split on</FONT>
<FONT COLOR="#40F628">1263:</FONT>         rgBoneCombinations  = <FONT COLOR="#0000FF">reinterpret_cast</FONT>&lt;LPD3DXBONECOMBINATION&gt;(pmcMesh-&gt;m_pBoneCombinationBuf-&gt;GetBufferPointer());
<FONT COLOR="#40F628">1264:</FONT> 
<FONT COLOR="#40F628">1265:</FONT>         <FONT COLOR="#0000FF">for</FONT> (pmcMesh-&gt;iAttrSplit = 0; pmcMesh-&gt;iAttrSplit &lt; pmcMesh-&gt;cpattr; pmcMesh-&gt;iAttrSplit++) {
<FONT COLOR="#40F628">1266:</FONT>             DWORD   cInfl   = 0;
<FONT COLOR="#40F628">1267:</FONT>             <FONT COLOR="#0000FF">for</FONT> (DWORD iInfl = 0; iInfl &lt; pmcMesh-&gt;m_maxFaceInfl; iInfl++) {
<FONT COLOR="#40F628">1268:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (rgBoneCombinations[pmcMesh-&gt;iAttrSplit].BoneId[iInfl] != UINT_MAX) {
<FONT COLOR="#40F628">1269:</FONT>                     ++cInfl;
<FONT COLOR="#40F628">1270:</FONT>                 }
<FONT COLOR="#40F628">1271:</FONT>             }
<FONT COLOR="#40F628">1272:</FONT>             <FONT COLOR="#0000FF">if</FONT> (<FONT COLOR="#0000FF">this</FONT>-&gt;GetCaps()-&gt;MaxVertexBlendMatrices &lt; cInfl) <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1273:</FONT>         }
<FONT COLOR="#40F628">1274:</FONT> 
<FONT COLOR="#40F628">1275:</FONT>         <FONT COLOR="#008000">// if there is both HW and SW, add the Software Processing flag</FONT>
<FONT COLOR="#40F628">1276:</FONT>         <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;iAttrSplit &lt; pmcMesh-&gt;cpattr) {
<FONT COLOR="#40F628">1277:</FONT>             LPD3DXMESH pMeshTmp;
<FONT COLOR="#40F628">1278:</FONT> 
<FONT COLOR="#40F628">1279:</FONT>             hr = pmcMesh-&gt;pMesh-&gt;CloneMeshFVF(D3DXMESH_SOFTWAREPROCESSING|pmcMesh-&gt;pMesh-&gt;GetOptions(), 
<FONT COLOR="#40F628">1280:</FONT>                                                 pmcMesh-&gt;pMesh-&gt;GetFVF(),
<FONT COLOR="#40F628">1281:</FONT>                                                 <FONT COLOR="#0000FF">this</FONT>-&gt;GetDevice(), &amp;pMeshTmp);
<FONT COLOR="#40F628">1282:</FONT>             <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1283:</FONT>             
<FONT COLOR="#40F628">1284:</FONT>             pmcMesh-&gt;pMesh-&gt;Release();
<FONT COLOR="#40F628">1285:</FONT>             pmcMesh-&gt;pMesh = pMeshTmp;
<FONT COLOR="#40F628">1286:</FONT>             pMeshTmp = NULL;
<FONT COLOR="#40F628">1287:</FONT>         }
<FONT COLOR="#40F628">1288:</FONT>     }<FONT COLOR="#0000FF">else</FONT>{
<FONT COLOR="#40F628">1289:</FONT>         pmcMesh-&gt;iAttrSplit = pmcMesh-&gt;cpattr;
<FONT COLOR="#40F628">1290:</FONT>     }
<FONT COLOR="#40F628">1291:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1292:</FONT> }
<FONT COLOR="#40F628">1293:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1294:</FONT> <FONT COLOR="#008000">// メッシュの生成(D3DINDEXEDVS)</FONT>
<FONT COLOR="#40F628">1295:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1296:</FONT> HRESULT CSkinModel::_GenerateMeshIndexedVs(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1297:</FONT> {
<FONT COLOR="#40F628">1298:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1299:</FONT>     <FONT COLOR="#008000">// 行列パレットの数を設定する（最大28）</FONT>
<FONT COLOR="#40F628">1300:</FONT>     pmcMesh-&gt;m_paletteSize = min(28, pmcMesh-&gt;m_pSkinMesh-&gt;GetNumBones());
<FONT COLOR="#40F628">1301:</FONT> 
<FONT COLOR="#40F628">1302:</FONT>     <FONT COLOR="#008000">// アドレス レジスタが使えないならソフトウェアT&amp;L</FONT>
<FONT COLOR="#40F628">1303:</FONT>     DWORD flags = D3DXMESHOPT_VERTEXCACHE;
<FONT COLOR="#40F628">1304:</FONT>     <FONT COLOR="#0000FF">if</FONT> (D3DVS_VERSION(1, 1) &lt;= <FONT COLOR="#0000FF">this</FONT>-&gt;GetCaps()-&gt;VertexShaderVersion ) {
<FONT COLOR="#40F628">1305:</FONT>         pmcMesh-&gt;m_bUseSW = <FONT COLOR="#0000FF">false</FONT>;
<FONT COLOR="#40F628">1306:</FONT>         flags |= D3DXMESH_MANAGED;
<FONT COLOR="#40F628">1307:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">1308:</FONT>         pmcMesh-&gt;m_bUseSW = <FONT COLOR="#0000FF">true</FONT>;
<FONT COLOR="#40F628">1309:</FONT>         flags |= D3DXMESH_SYSTEMMEM;
<FONT COLOR="#40F628">1310:</FONT>     }
<FONT COLOR="#40F628">1311:</FONT>     
<FONT COLOR="#40F628">1312:</FONT>     <FONT COLOR="#008000">// インデックス付きのブレンドされたメッシュへ変換する</FONT>
<FONT COLOR="#40F628">1313:</FONT>     hr = pmcMesh-&gt;m_pSkinMesh-&gt;ConvertToIndexedBlendedMesh(flags, pmcMesh-&gt;m_rgiAdjacency, pmcMesh-&gt;m_paletteSize, NULL,
<FONT COLOR="#40F628">1314:</FONT>         &amp;pmcMesh-&gt;cpattr, &amp;pmcMesh-&gt;m_pBoneCombinationBuf, NULL, NULL, &amp;pmcMesh-&gt;pMesh);
<FONT COLOR="#40F628">1315:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1316:</FONT>     
<FONT COLOR="#40F628">1317:</FONT>     <FONT COLOR="#008000">// 最大の混合する数を調べる</FONT>
<FONT COLOR="#40F628">1318:</FONT>     <FONT COLOR="#0000FF">if</FONT> ((pmcMesh-&gt;pMesh-&gt;GetFVF() &amp; D3DFVF_POSITION_MASK) != D3DFVF_XYZ) {
<FONT COLOR="#40F628">1319:</FONT>         pmcMesh-&gt;m_maxFaceInfl = ((pmcMesh-&gt;pMesh-&gt;GetFVF() &amp; D3DFVF_POSITION_MASK) - D3DFVF_XYZRHW) / 2;
<FONT COLOR="#40F628">1320:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">1321:</FONT>         pmcMesh-&gt;m_maxFaceInfl = 1;
<FONT COLOR="#40F628">1322:</FONT>     }
<FONT COLOR="#40F628">1323:</FONT> 
<FONT COLOR="#40F628">1324:</FONT>     <FONT COLOR="#008000">// FVF を変更して、それにあったメッシュを作成する</FONT>
<FONT COLOR="#40F628">1325:</FONT>     DWORD newFVF = (pmcMesh-&gt;pMesh-&gt;GetFVF() &amp; D3DFVF_POSITION_MASK) | D3DFVF_NORMAL | D3DFVF_TEX1 | D3DFVF_LASTBETA_UBYTE4;
<FONT COLOR="#40F628">1326:</FONT>     <FONT COLOR="#0000FF">if</FONT> (newFVF != pmcMesh-&gt;pMesh-&gt;GetFVF()) {
<FONT COLOR="#40F628">1327:</FONT>         LPD3DXMESH pMesh;
<FONT COLOR="#40F628">1328:</FONT>         hr = pmcMesh-&gt;pMesh-&gt;CloneMeshFVF(pmcMesh-&gt;pMesh-&gt;GetOptions(), newFVF, <FONT COLOR="#0000FF">this</FONT>-&gt;GetDevice(), &amp;pMesh);
<FONT COLOR="#40F628">1329:</FONT>         <FONT COLOR="#0000FF">if</FONT> (!FAILED(hr)) {
<FONT COLOR="#40F628">1330:</FONT>             pmcMesh-&gt;pMesh-&gt;Release();
<FONT COLOR="#40F628">1331:</FONT>             pmcMesh-&gt;pMesh = pMesh;
<FONT COLOR="#40F628">1332:</FONT>             pMesh = NULL;
<FONT COLOR="#40F628">1333:</FONT>         }
<FONT COLOR="#40F628">1334:</FONT>     }
<FONT COLOR="#40F628">1335:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1336:</FONT> }
<FONT COLOR="#40F628">1337:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1338:</FONT> <FONT COLOR="#008000">// メッシュの生成(D3DINDEXED)</FONT>
<FONT COLOR="#40F628">1339:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1340:</FONT> HRESULT CSkinModel::_GenerateMeshIndexed(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1341:</FONT> {
<FONT COLOR="#40F628">1342:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1343:</FONT>     DWORD maxFaceInfl;
<FONT COLOR="#40F628">1344:</FONT>     DWORD flags = D3DXMESHOPT_VERTEXCACHE;
<FONT COLOR="#40F628">1345:</FONT> 
<FONT COLOR="#40F628">1346:</FONT>     hr = pmcMesh-&gt;m_pSkinMesh-&gt;GetMaxFaceInfluences(&amp;maxFaceInfl);
<FONT COLOR="#40F628">1347:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1348:</FONT> 
<FONT COLOR="#40F628">1349:</FONT>     <FONT COLOR="#008000">// 12 entry palette guarantees that any triangle (4 independent influences per vertex of a tri)</FONT>
<FONT COLOR="#40F628">1350:</FONT>     <FONT COLOR="#008000">// can be handled</FONT>
<FONT COLOR="#40F628">1351:</FONT>     maxFaceInfl = min(maxFaceInfl, 12);
<FONT COLOR="#40F628">1352:</FONT> 
<FONT COLOR="#40F628">1353:</FONT>     <FONT COLOR="#0000FF">if</FONT> (<FONT COLOR="#0000FF">this</FONT>-&gt;GetCaps()-&gt;MaxVertexBlendMatrixIndex + 1 &lt; maxFaceInfl) {
<FONT COLOR="#40F628">1354:</FONT>         <FONT COLOR="#008000">// HW does not support indexed vertex blending. Use SW instead</FONT>
<FONT COLOR="#40F628">1355:</FONT>         pmcMesh-&gt;m_paletteSize = min(256, pmcMesh-&gt;m_pSkinMesh-&gt;GetNumBones());
<FONT COLOR="#40F628">1356:</FONT>         pmcMesh-&gt;m_bUseSW = <FONT COLOR="#0000FF">true</FONT>;
<FONT COLOR="#40F628">1357:</FONT>         flags |= D3DXMESH_SYSTEMMEM;
<FONT COLOR="#40F628">1358:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">1359:</FONT>         pmcMesh-&gt;m_paletteSize = min(<FONT COLOR="#0000FF">this</FONT>-&gt;GetCaps()-&gt;MaxVertexBlendMatrixIndex + 1, pmcMesh-&gt;m_pSkinMesh-&gt;GetNumBones());
<FONT COLOR="#40F628">1360:</FONT>         pmcMesh-&gt;m_bUseSW = <FONT COLOR="#0000FF">false</FONT>;
<FONT COLOR="#40F628">1361:</FONT>         flags |= D3DXMESH_MANAGED;
<FONT COLOR="#40F628">1362:</FONT>     }
<FONT COLOR="#40F628">1363:</FONT> 
<FONT COLOR="#40F628">1364:</FONT>     hr = pmcMesh-&gt;m_pSkinMesh-&gt;ConvertToIndexedBlendedMesh(flags, pmcMesh-&gt;m_rgiAdjacency, pmcMesh-&gt;m_paletteSize, NULL,
<FONT COLOR="#40F628">1365:</FONT>         &amp;pmcMesh-&gt;cpattr, &amp;pmcMesh-&gt;m_pBoneCombinationBuf, NULL, NULL, &amp;pmcMesh-&gt;pMesh);
<FONT COLOR="#40F628">1366:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1367:</FONT> 
<FONT COLOR="#40F628">1368:</FONT>     <FONT COLOR="#008000">// Here we are talking of max vertex influence which we determine from </FONT>
<FONT COLOR="#40F628">1369:</FONT>     <FONT COLOR="#008000">// the FVF of the returned mesh</FONT>
<FONT COLOR="#40F628">1370:</FONT>     <FONT COLOR="#0000FF">if</FONT> ((pmcMesh-&gt;pMesh-&gt;GetFVF() &amp; D3DFVF_POSITION_MASK) != D3DFVF_XYZ) {
<FONT COLOR="#40F628">1371:</FONT>         pmcMesh-&gt;m_maxFaceInfl = ((pmcMesh-&gt;pMesh-&gt;GetFVF() &amp; D3DFVF_POSITION_MASK) - D3DFVF_XYZRHW) / 2;
<FONT COLOR="#40F628">1372:</FONT>     } <FONT COLOR="#0000FF">else</FONT> {
<FONT COLOR="#40F628">1373:</FONT>         pmcMesh-&gt;m_maxFaceInfl = 1;
<FONT COLOR="#40F628">1374:</FONT>     }
<FONT COLOR="#40F628">1375:</FONT> 
<FONT COLOR="#40F628">1376:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1377:</FONT> }
<FONT COLOR="#40F628">1378:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1379:</FONT> <FONT COLOR="#008000">// メッシュの生成(SOFTWARE)</FONT>
<FONT COLOR="#40F628">1380:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1381:</FONT> HRESULT CSkinModel::_GenerateMeshSoftware(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1382:</FONT> {
<FONT COLOR="#40F628">1383:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1384:</FONT>     hr = pmcMesh-&gt;m_pSkinMesh-&gt;GenerateSkinnedMesh (
<FONT COLOR="#40F628">1385:</FONT>            D3DXMESH_WRITEONLY,      <FONT COLOR="#008000">// メッシュの作成オプション</FONT>
<FONT COLOR="#40F628">1386:</FONT>            0.0f,                    <FONT COLOR="#008000">// 最小ウェイト固定値</FONT>
<FONT COLOR="#40F628">1387:</FONT>            pmcMesh-&gt;m_rgiAdjacency, <FONT COLOR="#008000">// ソース メッシュに含まれる各面の 3 つの隣接面の配列へのポインタ</FONT>
<FONT COLOR="#40F628">1388:</FONT>            NULL,                    <FONT COLOR="#008000">// 最適化されたメッシュの面隣接性配列に使用する転送先バッファへのポインタ</FONT>
<FONT COLOR="#40F628">1389:</FONT>            NULL,                    <FONT COLOR="#008000">// face remap array</FONT>
<FONT COLOR="#40F628">1390:</FONT>            NULL,                    <FONT COLOR="#008000">// vertex remap buffer</FONT>
<FONT COLOR="#40F628">1391:</FONT>            &amp;pmcMesh-&gt;pMesh          <FONT COLOR="#008000">// 生成されたメッシュ</FONT>
<FONT COLOR="#40F628">1392:</FONT>        );
<FONT COLOR="#40F628">1393:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1394:</FONT>     
<FONT COLOR="#40F628">1395:</FONT>     <FONT COLOR="#008000">// アトリビュートを読み込む</FONT>
<FONT COLOR="#40F628">1396:</FONT>     hr = pmcMesh-&gt;pMesh-&gt;GetAttributeTable(NULL, &amp;pmcMesh-&gt;cpattr);
<FONT COLOR="#40F628">1397:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1398:</FONT> 
<FONT COLOR="#40F628">1399:</FONT>     <FONT COLOR="#0000FF">delete</FONT>[] pmcMesh-&gt;m_pAttrTable;
<FONT COLOR="#40F628">1400:</FONT>     pmcMesh-&gt;m_pAttrTable  = <FONT COLOR="#0000FF">new</FONT> D3DXATTRIBUTERANGE[pmcMesh-&gt;cpattr];
<FONT COLOR="#40F628">1401:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_pAttrTable == NULL) {<FONT COLOR="#008000">// 格納するメモリが足りない</FONT>
<FONT COLOR="#40F628">1402:</FONT>         hr = E_OUTOFMEMORY;
<FONT COLOR="#40F628">1403:</FONT>         <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1404:</FONT>     }
<FONT COLOR="#40F628">1405:</FONT>     hr = pmcMesh-&gt;pMesh-&gt;GetAttributeTable(pmcMesh-&gt;m_pAttrTable, NULL);
<FONT COLOR="#40F628">1406:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1407:</FONT> 
<FONT COLOR="#40F628">1408:</FONT>     <FONT COLOR="#008000">// スキン メッシュの任意の 1 面に影響を与える、影響の数の最大値を読み込む</FONT>
<FONT COLOR="#40F628">1409:</FONT>     hr = pmcMesh-&gt;m_pSkinMesh-&gt;GetMaxFaceInfluences(&amp;pmcMesh-&gt;m_maxFaceInfl);
<FONT COLOR="#40F628">1410:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1411:</FONT> 
<FONT COLOR="#40F628">1412:</FONT>     <FONT COLOR="#008000">// 行列用の配列を用意する</FONT>
<FONT COLOR="#40F628">1413:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;m_pBoneMatrices  = <FONT COLOR="#0000FF">new</FONT> D3DXMATRIXA16[<FONT COLOR="#0000FF">this</FONT>-&gt;GetMaxBorns()];
<FONT COLOR="#40F628">1414:</FONT>     <FONT COLOR="#0000FF">if</FONT> (<FONT COLOR="#0000FF">this</FONT>-&gt;m_pBoneMatrices == NULL) {
<FONT COLOR="#40F628">1415:</FONT>         hr = E_OUTOFMEMORY;
<FONT COLOR="#40F628">1416:</FONT>         <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1417:</FONT>     }
<FONT COLOR="#40F628">1418:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1419:</FONT> }
<FONT COLOR="#40F628">1420:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1421:</FONT> <FONT COLOR="#008000">// メッシュの生成</FONT>
<FONT COLOR="#40F628">1422:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1423:</FONT> HRESULT CSkinModel::GenerateMesh(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1424:</FONT> {
<FONT COLOR="#40F628">1425:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1426:</FONT>     LPDIRECT3DDEVICE8 pD3DDev = NULL;
<FONT COLOR="#40F628">1427:</FONT>     DWORD cFaces = pmcMesh-&gt;m_pSkinMesh-&gt;GetNumFaces();
<FONT COLOR="#40F628">1428:</FONT> 
<FONT COLOR="#40F628">1429:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr=pmcMesh-&gt;m_pSkinMesh-&gt;GetDevice(&amp;pD3DDev))) <FONT COLOR="#0000FF">goto</FONT> e_Exit;
<FONT COLOR="#40F628">1430:</FONT> 
<FONT COLOR="#40F628">1431:</FONT>     RELEASE(pmcMesh-&gt;pMesh);
<FONT COLOR="#40F628">1432:</FONT>     <FONT COLOR="#0000FF">delete</FONT> [] <FONT COLOR="#0000FF">this</FONT>-&gt;m_pBoneMatrices;
<FONT COLOR="#40F628">1433:</FONT> 
<FONT COLOR="#40F628">1434:</FONT>     pmcMesh-&gt;pMesh    = NULL;
<FONT COLOR="#40F628">1435:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;m_pBoneMatrices    = NULL;
<FONT COLOR="#40F628">1436:</FONT>     
<FONT COLOR="#40F628">1437:</FONT>     <FONT COLOR="#008000">// 方法によって生成するものを変える</FONT>
<FONT COLOR="#40F628">1438:</FONT>     <FONT COLOR="#0000FF">switch</FONT>(<FONT COLOR="#0000FF">this</FONT>-&gt;GetMethod()){
<FONT COLOR="#40F628">1439:</FONT>     <FONT COLOR="#0000FF">case</FONT> D3DNONINDEXED:
<FONT COLOR="#40F628">1440:</FONT>         hr = _GenerateMeshNonIndexed(pmcMesh);
<FONT COLOR="#40F628">1441:</FONT>         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1442:</FONT>     <FONT COLOR="#0000FF">case</FONT> D3DINDEXEDVS:
<FONT COLOR="#40F628">1443:</FONT>         hr = _GenerateMeshIndexedVs(pmcMesh);
<FONT COLOR="#40F628">1444:</FONT>         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1445:</FONT>     <FONT COLOR="#0000FF">case</FONT> D3DINDEXED:
<FONT COLOR="#40F628">1446:</FONT>         hr = _GenerateMeshIndexed(pmcMesh);
<FONT COLOR="#40F628">1447:</FONT>         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1448:</FONT>     <FONT COLOR="#0000FF">case</FONT> SOFTWARE:
<FONT COLOR="#40F628">1449:</FONT>         hr = _GenerateMeshSoftware(pmcMesh);
<FONT COLOR="#40F628">1450:</FONT>         <FONT COLOR="#0000FF">break</FONT>;
<FONT COLOR="#40F628">1451:</FONT>     }
<FONT COLOR="#40F628">1452:</FONT>     <FONT COLOR="#0000FF">if</FONT>(SUCCEEDED(hr)) pmcMesh-&gt;m_Method = <FONT COLOR="#0000FF">this</FONT>-&gt;GetMethod();
<FONT COLOR="#40F628">1453:</FONT> 
<FONT COLOR="#40F628">1454:</FONT> e_Exit:
<FONT COLOR="#40F628">1455:</FONT> 
<FONT COLOR="#40F628">1456:</FONT>     RELEASE(pD3DDev);
<FONT COLOR="#40F628">1457:</FONT>     <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1458:</FONT> }
<FONT COLOR="#40F628">1459:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1460:</FONT> <FONT COLOR="#008000">// 初期化</FONT>
<FONT COLOR="#40F628">1461:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1462:</FONT> HRESULT CSkinModel::Init(DWORD time, LPDIRECT3DDEVICE8 pD3DDev, D3DCAPS8 &amp;caps)
<FONT COLOR="#40F628">1463:</FONT> {
<FONT COLOR="#40F628">1464:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;Set1stTime(time);
<FONT COLOR="#40F628">1465:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;_SetDevice(pD3DDev);
<FONT COLOR="#40F628">1466:</FONT>     
<FONT COLOR="#40F628">1467:</FONT>     <FONT COLOR="#0000FF">if</FONT>(pD3DDev){
<FONT COLOR="#40F628">1468:</FONT>         <FONT COLOR="#008000">// アスペクト比を求めるための D3DSURFACE_DESC の所得</FONT>
<FONT COLOR="#40F628">1469:</FONT>         LPDIRECT3DSURFACE8 pBackBuffer;
<FONT COLOR="#40F628">1470:</FONT>         pD3DDev-&gt;GetBackBuffer( 0, D3DBACKBUFFER_TYPE_MONO, &amp;pBackBuffer );
<FONT COLOR="#40F628">1471:</FONT>         pBackBuffer-&gt;GetDesc( &amp;m_d3dsdBackBuffer );
<FONT COLOR="#40F628">1472:</FONT>         pBackBuffer-&gt;Release();
<FONT COLOR="#40F628">1473:</FONT>         
<FONT COLOR="#40F628">1474:</FONT>         m_d3dCaps = caps;
<FONT COLOR="#40F628">1475:</FONT>     }
<FONT COLOR="#40F628">1476:</FONT>     
<FONT COLOR="#40F628">1477:</FONT>     _CreateVertexShader();
<FONT COLOR="#40F628">1478:</FONT> 
<FONT COLOR="#40F628">1479:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1480:</FONT> }
<FONT COLOR="#40F628">1481:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1482:</FONT> <FONT COLOR="#008000">// 頂点シェーダーの生成</FONT>
<FONT COLOR="#40F628">1483:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1484:</FONT> HRESULT CSkinModel::_CreateVertexShader()
<FONT COLOR="#40F628">1485:</FONT> {
<FONT COLOR="#40F628">1486:</FONT>     LPD3DXBUFFER pCode;
<FONT COLOR="#40F628">1487:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1488:</FONT>     
<FONT COLOR="#40F628">1489:</FONT>     <FONT COLOR="#008000">// インデックススキニングのための頂点シェーダーの生成</FONT>
<FONT COLOR="#40F628">1490:</FONT>     DWORD dwIndexedVertexDecl1[] = {
<FONT COLOR="#40F628">1491:</FONT>         D3DVSD_STREAM( 0 ),
<FONT COLOR="#40F628">1492:</FONT>         D3DVSD_REG( 0, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// Position of first mesh</FONT>
<FONT COLOR="#40F628">1493:</FONT>         D3DVSD_REG( 2, D3DVSDT_D3DCOLOR ),  <FONT COLOR="#008000">// 合成する行列の指定</FONT>
<FONT COLOR="#40F628">1494:</FONT>         D3DVSD_REG( 3, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// 法線</FONT>
<FONT COLOR="#40F628">1495:</FONT>         D3DVSD_REG( 4, D3DVSDT_FLOAT2 ),    <FONT COLOR="#008000">// テクスチャー座標</FONT>
<FONT COLOR="#40F628">1496:</FONT>         D3DVSD_END()
<FONT COLOR="#40F628">1497:</FONT>     };
<FONT COLOR="#40F628">1498:</FONT> 
<FONT COLOR="#40F628">1499:</FONT>     DWORD dwIndexedVertexDecl2[] = {
<FONT COLOR="#40F628">1500:</FONT>         D3DVSD_STREAM( 0 ),
<FONT COLOR="#40F628">1501:</FONT>         D3DVSD_REG( 0, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// Position of first mesh</FONT>
<FONT COLOR="#40F628">1502:</FONT>         D3DVSD_REG( 1, D3DVSDT_FLOAT1 ),    <FONT COLOR="#008000">// 合成の重み</FONT>
<FONT COLOR="#40F628">1503:</FONT>         D3DVSD_REG( 2, D3DVSDT_D3DCOLOR ),  <FONT COLOR="#008000">// 合成する行列の指定</FONT>
<FONT COLOR="#40F628">1504:</FONT>         D3DVSD_REG( 3, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// 法線</FONT>
<FONT COLOR="#40F628">1505:</FONT>         D3DVSD_REG( 4, D3DVSDT_FLOAT2 ),    <FONT COLOR="#008000">// テクスチャー座標</FONT>
<FONT COLOR="#40F628">1506:</FONT>         D3DVSD_END()
<FONT COLOR="#40F628">1507:</FONT>     };
<FONT COLOR="#40F628">1508:</FONT> 
<FONT COLOR="#40F628">1509:</FONT>     DWORD dwIndexedVertexDecl3[] =  {
<FONT COLOR="#40F628">1510:</FONT>         D3DVSD_STREAM( 0 ),
<FONT COLOR="#40F628">1511:</FONT>         D3DVSD_REG( 0, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// Position of first mesh</FONT>
<FONT COLOR="#40F628">1512:</FONT>         D3DVSD_REG( 1, D3DVSDT_FLOAT2 ),    <FONT COLOR="#008000">// 合成の重み</FONT>
<FONT COLOR="#40F628">1513:</FONT>         D3DVSD_REG( 2, D3DVSDT_D3DCOLOR ),  <FONT COLOR="#008000">// 合成する行列の指定</FONT>
<FONT COLOR="#40F628">1514:</FONT>         D3DVSD_REG( 3, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// 法線</FONT>
<FONT COLOR="#40F628">1515:</FONT>         D3DVSD_REG( 4, D3DVSDT_FLOAT2 ),    <FONT COLOR="#008000">// テクスチャー座標</FONT>
<FONT COLOR="#40F628">1516:</FONT>         D3DVSD_END()
<FONT COLOR="#40F628">1517:</FONT>     };
<FONT COLOR="#40F628">1518:</FONT> 
<FONT COLOR="#40F628">1519:</FONT>     DWORD dwIndexedVertexDecl4[] =  {
<FONT COLOR="#40F628">1520:</FONT>         D3DVSD_STREAM( 0 ),
<FONT COLOR="#40F628">1521:</FONT>         D3DVSD_REG( 0, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// Position of first mesh</FONT>
<FONT COLOR="#40F628">1522:</FONT>         D3DVSD_REG( 1, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// 合成の重み</FONT>
<FONT COLOR="#40F628">1523:</FONT>         D3DVSD_REG( 2, D3DVSDT_D3DCOLOR ),  <FONT COLOR="#008000">// 合成する行列の指定</FONT>
<FONT COLOR="#40F628">1524:</FONT>         D3DVSD_REG( 3, D3DVSDT_FLOAT3 ),    <FONT COLOR="#008000">// 法線</FONT>
<FONT COLOR="#40F628">1525:</FONT>         D3DVSD_REG( 4, D3DVSDT_FLOAT2 ),    <FONT COLOR="#008000">// テクスチャー座標</FONT>
<FONT COLOR="#40F628">1526:</FONT>         D3DVSD_END()
<FONT COLOR="#40F628">1527:</FONT>     };
<FONT COLOR="#40F628">1528:</FONT> 
<FONT COLOR="#40F628">1529:</FONT>     DWORD* dwIndexedVertexDecl[] = {
<FONT COLOR="#40F628">1530:</FONT>         dwIndexedVertexDecl1,
<FONT COLOR="#40F628">1531:</FONT>         dwIndexedVertexDecl2,
<FONT COLOR="#40F628">1532:</FONT>         dwIndexedVertexDecl3,
<FONT COLOR="#40F628">1533:</FONT>         dwIndexedVertexDecl4,
<FONT COLOR="#40F628">1534:</FONT>     };
<FONT COLOR="#40F628">1535:</FONT>     
<FONT COLOR="#40F628">1536:</FONT>     <FONT COLOR="#0000FF">char</FONT> *filename[] = {
<FONT COLOR="#40F628">1537:</FONT>         "<FONT COLOR="#600000">skinmesh1.vsh</FONT>",
<FONT COLOR="#40F628">1538:</FONT>         "<FONT COLOR="#600000">skinmesh2.vsh</FONT>",
<FONT COLOR="#40F628">1539:</FONT>         "<FONT COLOR="#600000">skinmesh3.vsh</FONT>",
<FONT COLOR="#40F628">1540:</FONT>         "<FONT COLOR="#600000">skinmesh4.vsh</FONT>",
<FONT COLOR="#40F628">1541:</FONT>     };
<FONT COLOR="#40F628">1542:</FONT> 
<FONT COLOR="#40F628">1543:</FONT>     <FONT COLOR="#0000FF">const</FONT> <FONT COLOR="#0000FF">char</FONT> *shader_program[] = {
<FONT COLOR="#40F628">1544:</FONT>         VertexShader0,
<FONT COLOR="#40F628">1545:</FONT>         VertexShader1,
<FONT COLOR="#40F628">1546:</FONT>         VertexShader2,
<FONT COLOR="#40F628">1547:</FONT>         VertexShader3,
<FONT COLOR="#40F628">1548:</FONT>     };
<FONT COLOR="#40F628">1549:</FONT>     <FONT COLOR="#0000FF">const</FONT> <FONT COLOR="#0000FF">int</FONT> size[] = {
<FONT COLOR="#40F628">1550:</FONT>         <FONT COLOR="#0000FF">sizeof</FONT>(VertexShader0)-1,
<FONT COLOR="#40F628">1551:</FONT>         <FONT COLOR="#0000FF">sizeof</FONT>(VertexShader1)-1,
<FONT COLOR="#40F628">1552:</FONT>         <FONT COLOR="#0000FF">sizeof</FONT>(VertexShader2)-1,
<FONT COLOR="#40F628">1553:</FONT>         <FONT COLOR="#0000FF">sizeof</FONT>(VertexShader3)-1,
<FONT COLOR="#40F628">1554:</FONT>     };
<FONT COLOR="#40F628">1555:</FONT> 
<FONT COLOR="#40F628">1556:</FONT>     <FONT COLOR="#008000">// アドレス レジスタが使えないならソフトウェアT&amp;L</FONT>
<FONT COLOR="#40F628">1557:</FONT>     DWORD bUseSW = (m_d3dCaps.VertexShaderVersion &lt; D3DVS_VERSION(1, 1));
<FONT COLOR="#40F628">1558:</FONT> 
<FONT COLOR="#40F628">1559:</FONT>     <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; 4; ++i)  {
<FONT COLOR="#40F628">1560:</FONT>         <FONT COLOR="#008000">// シェーダープログラムの読み込み</FONT>
<FONT COLOR="#40F628">1561:</FONT>         <FONT COLOR="#0000FF">if</FONT> ( FAILED(hr = D3DXAssembleShader( shader_program[i] , size[i], 0 , NULL , &amp;pCode , NULL)) ) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1562:</FONT> 
<FONT COLOR="#40F628">1563:</FONT>         <FONT COLOR="#008000">// 頂点シェーダーの生成</FONT>
<FONT COLOR="#40F628">1564:</FONT>         <FONT COLOR="#0000FF">if</FONT>( FAILED( hr = m_pD3DDev-&gt;CreateVertexShader( dwIndexedVertexDecl[i], 
<FONT COLOR="#40F628">1565:</FONT>                                              (DWORD*)pCode-&gt;GetBufferPointer(),
<FONT COLOR="#40F628">1566:</FONT>                                              &amp;(m_dwIndexedVertexShader[i]) , bUseSW ? D3DUSAGE_SOFTWAREPROCESSING : 0 ) ) )
<FONT COLOR="#40F628">1567:</FONT>             <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1568:</FONT> 
<FONT COLOR="#40F628">1569:</FONT>         pCode-&gt;Release();
<FONT COLOR="#40F628">1570:</FONT>     }
<FONT COLOR="#40F628">1571:</FONT>     
<FONT COLOR="#40F628">1572:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1573:</FONT> }
<FONT COLOR="#40F628">1574:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1575:</FONT> <FONT COLOR="#008000">// ロード</FONT>
<FONT COLOR="#40F628">1576:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1577:</FONT> HRESULT CSkinModel::Load( <FONT COLOR="#0000FF">const</FONT> TCHAR *filename )
<FONT COLOR="#40F628">1578:</FONT> {
<FONT COLOR="#40F628">1579:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1580:</FONT>     
<FONT COLOR="#40F628">1581:</FONT>     strcpy(m_szPath, filename);
<FONT COLOR="#40F628">1582:</FONT>     
<FONT COLOR="#40F628">1583:</FONT>     <FONT COLOR="#008000">// メッシュのロード</FONT>
<FONT COLOR="#40F628">1584:</FONT>     <FONT COLOR="#0000FF">if</FONT>(FAILED(hr = <FONT COLOR="#0000FF">this</FONT>-&gt;_LoadMeshHierarchy(m_pD3DDev))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1585:</FONT> 
<FONT COLOR="#40F628">1586:</FONT>     <FONT COLOR="#008000">// SetRenderState の設定</FONT>
<FONT COLOR="#40F628">1587:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = RestoreDeviceObjects(m_pD3DDev))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1588:</FONT> 
<FONT COLOR="#40F628">1589:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1590:</FONT> }
<FONT COLOR="#40F628">1591:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1592:</FONT> <FONT COLOR="#008000">// 射影行列の設定</FONT>
<FONT COLOR="#40F628">1593:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1594:</FONT> HRESULT CSkinModel::_SetProjectionMatrix()
<FONT COLOR="#40F628">1595:</FONT> {
<FONT COLOR="#40F628">1596:</FONT>     D3DXMATRIX mat;
<FONT COLOR="#40F628">1597:</FONT> 
<FONT COLOR="#40F628">1598:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_pdeMesh == NULL) <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1599:</FONT> 
<FONT COLOR="#40F628">1600:</FONT>     FLOAT fAspect = m_d3dsdBackBuffer.Width / (FLOAT)m_d3dsdBackBuffer.Height;
<FONT COLOR="#40F628">1601:</FONT>     D3DXMatrixPerspectiveFovRH(&amp;mat, 0.25f*3.141592654f, fAspect, m_pdeMesh-&gt;fRadius / 64, m_pdeMesh-&gt;fRadius * 200);
<FONT COLOR="#40F628">1602:</FONT>     
<FONT COLOR="#40F628">1603:</FONT>     <FONT COLOR="#008000">// ソフトウェアT&amp;Lのために設定する</FONT>
<FONT COLOR="#40F628">1604:</FONT>     HRESULT hr = m_pD3DDev-&gt;SetTransform( D3DTS_PROJECTION, (D3DMATRIX*)&amp;mat );
<FONT COLOR="#40F628">1605:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1606:</FONT>     
<FONT COLOR="#40F628">1607:</FONT>     <FONT COLOR="#008000">// ハードウェアT&amp;Lのために設定する</FONT>
<FONT COLOR="#40F628">1608:</FONT>     D3DXMatrixTranspose(&amp;mat, &amp;mat);
<FONT COLOR="#40F628">1609:</FONT>     <FONT COLOR="#0000FF">return</FONT> m_pD3DDev-&gt;SetVertexShaderConstant(2, &amp;mat, 4);  <FONT COLOR="#008000">// c2～c5</FONT>
<FONT COLOR="#40F628">1610:</FONT> }
<FONT COLOR="#40F628">1611:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1612:</FONT> <FONT COLOR="#008000">// シーンの初期化</FONT>
<FONT COLOR="#40F628">1613:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1614:</FONT> HRESULT CSkinModel::RestoreDeviceObjects(LPDIRECT3DDEVICE8 pD3DDev)
<FONT COLOR="#40F628">1615:</FONT> {
<FONT COLOR="#40F628">1616:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1617:</FONT>     D3DLIGHT8 light;
<FONT COLOR="#40F628">1618:</FONT>     
<FONT COLOR="#40F628">1619:</FONT>     <FONT COLOR="#008000">// レンダリングのための状態の設定</FONT>
<FONT COLOR="#40F628">1620:</FONT>     pD3DDev-&gt;SetRenderState( D3DRS_DITHERENABLE, TRUE );
<FONT COLOR="#40F628">1621:</FONT>     pD3DDev-&gt;SetRenderState( D3DRS_ZENABLE, TRUE );
<FONT COLOR="#40F628">1622:</FONT>     pD3DDev-&gt;SetRenderState( D3DRS_SPECULARENABLE, FALSE );
<FONT COLOR="#40F628">1623:</FONT>     pD3DDev-&gt;SetRenderState( D3DRS_NORMALIZENORMALS, TRUE );
<FONT COLOR="#40F628">1624:</FONT> 
<FONT COLOR="#40F628">1625:</FONT>     pD3DDev-&gt;SetRenderState( D3DRS_CULLMODE, D3DCULL_CW );
<FONT COLOR="#40F628">1626:</FONT>     pD3DDev-&gt;SetRenderState( D3DRS_LIGHTING, TRUE );
<FONT COLOR="#40F628">1627:</FONT>     pD3DDev-&gt;SetTextureStageState( 0, D3DTSS_MAGFILTER, D3DTEXF_LINEAR  );
<FONT COLOR="#40F628">1628:</FONT>     pD3DDev-&gt;SetTextureStageState( 0, D3DTSS_MINFILTER, D3DTEXF_LINEAR  );
<FONT COLOR="#40F628">1629:</FONT> 
<FONT COLOR="#40F628">1630:</FONT>     pD3DDev-&gt;SetRenderState( D3DRS_COLORVERTEX, FALSE );
<FONT COLOR="#40F628">1631:</FONT> 
<FONT COLOR="#40F628">1632:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_pdeMesh != NULL) _SetProjectionMatrix();
<FONT COLOR="#40F628">1633:</FONT> 
<FONT COLOR="#40F628">1634:</FONT>     
<FONT COLOR="#40F628">1635:</FONT>     <FONT COLOR="#008000">// ソフトウェアT&amp;Lのためのライトの設定</FONT>
<FONT COLOR="#40F628">1636:</FONT>     ZeroMemory( &amp;light, <FONT COLOR="#0000FF">sizeof</FONT>(light) );
<FONT COLOR="#40F628">1637:</FONT>     light.Type = D3DLIGHT_DIRECTIONAL;
<FONT COLOR="#40F628">1638:</FONT>     light.Diffuse.r = 1.0;
<FONT COLOR="#40F628">1639:</FONT>     light.Diffuse.g = 1.0;
<FONT COLOR="#40F628">1640:</FONT>     light.Diffuse.b = 1.0;
<FONT COLOR="#40F628">1641:</FONT>     light.Specular.r = 0;
<FONT COLOR="#40F628">1642:</FONT>     light.Specular.g = 0;
<FONT COLOR="#40F628">1643:</FONT>     light.Specular.b = 0;
<FONT COLOR="#40F628">1644:</FONT>     light.Ambient.r = 0.25;
<FONT COLOR="#40F628">1645:</FONT>     light.Ambient.g = 0.25;
<FONT COLOR="#40F628">1646:</FONT>     light.Ambient.b = 0.25;
<FONT COLOR="#40F628">1647:</FONT>     light.Direction = D3DXVECTOR3( 0.0f, 0.0f, -1.0f);
<FONT COLOR="#40F628">1648:</FONT> 
<FONT COLOR="#40F628">1649:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pD3DDev-&gt;SetLight(0, &amp;light ))) <FONT COLOR="#0000FF">return</FONT> E_FAIL;
<FONT COLOR="#40F628">1650:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pD3DDev-&gt;LightEnable(0, TRUE))) <FONT COLOR="#0000FF">return</FONT> E_FAIL;
<FONT COLOR="#40F628">1651:</FONT> 
<FONT COLOR="#40F628">1652:</FONT>     <FONT COLOR="#008000">// 頂点シェーダーのライトの設定</FONT>
<FONT COLOR="#40F628">1653:</FONT>     pD3DDev-&gt;SetVertexShaderConstant(1, &amp;D3DXVECTOR4( 0.0f, 0.0f, 1.0f, 0.0f ), 1);
<FONT COLOR="#40F628">1654:</FONT> 
<FONT COLOR="#40F628">1655:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1656:</FONT> }
<FONT COLOR="#40F628">1657:</FONT> 
<FONT COLOR="#40F628">1658:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1659:</FONT> <FONT COLOR="#008000">// 動かす</FONT>
<FONT COLOR="#40F628">1660:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1661:</FONT> HRESULT CSkinModel::FrameMove(DWORD time)
<FONT COLOR="#40F628">1662:</FONT> {
<FONT COLOR="#40F628">1663:</FONT>     <FONT COLOR="#0000FF">if</FONT>(m_pdeMesh){
<FONT COLOR="#40F628">1664:</FONT>         m_pdeMesh-&gt;fCurTime = 4.8f*(<FONT COLOR="#0000FF">float</FONT>)(time - m_1st_time);<FONT COLOR="#008000">// 時間の設定</FONT>
<FONT COLOR="#40F628">1665:</FONT> 
<FONT COLOR="#40F628">1666:</FONT>         <FONT COLOR="#008000">// 登録された全てのアニメに関して設定</FONT>
<FONT COLOR="#40F628">1667:</FONT>         <FONT COLOR="#0000FF">for</FONT> (SFrame* pFrame = m_pdeMesh-&gt;pframeAnimHead; pFrame ; pFrame=pFrame-&gt;pframeAnimNext) {
<FONT COLOR="#40F628">1668:</FONT>             pFrame-&gt;SetTime(m_pdeMesh-&gt;fCurTime);
<FONT COLOR="#40F628">1669:</FONT>         }
<FONT COLOR="#40F628">1670:</FONT>     }
<FONT COLOR="#40F628">1671:</FONT>     
<FONT COLOR="#40F628">1672:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1673:</FONT> }
<FONT COLOR="#40F628">1674:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1675:</FONT> <FONT COLOR="#008000">// 行列の生成</FONT>
<FONT COLOR="#40F628">1676:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1677:</FONT> HRESULT SFrame::UpdateFrames(D3DXMATRIX &amp;matCur)
<FONT COLOR="#40F628">1678:</FONT> {
<FONT COLOR="#40F628">1679:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1680:</FONT>     <FONT COLOR="#0000FF">this</FONT>-&gt;matCombined = matCur;
<FONT COLOR="#40F628">1681:</FONT>     D3DXMatrixMultiply(&amp;<FONT COLOR="#0000FF">this</FONT>-&gt;matCombined, &amp;<FONT COLOR="#0000FF">this</FONT>-&gt;matRot, &amp;matCur);
<FONT COLOR="#40F628">1682:</FONT>     D3DXMatrixMultiply(&amp;<FONT COLOR="#0000FF">this</FONT>-&gt;matCombined, &amp;<FONT COLOR="#0000FF">this</FONT>-&gt;matCombined, &amp;<FONT COLOR="#0000FF">this</FONT>-&gt;matTrans );
<FONT COLOR="#40F628">1683:</FONT>     
<FONT COLOR="#40F628">1684:</FONT>     <FONT COLOR="#008000">// 自分の行列を親として、子供たちを次々に行列変換する</FONT>
<FONT COLOR="#40F628">1685:</FONT>     <FONT COLOR="#0000FF">for</FONT>( SFrame *p=<FONT COLOR="#0000FF">this</FONT>-&gt;pframeFirstChild ; p!=NULL ; p=p-&gt;pframeSibling ){
<FONT COLOR="#40F628">1686:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = p-&gt;UpdateFrames(<FONT COLOR="#0000FF">this</FONT>-&gt;matCombined))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1687:</FONT>     }
<FONT COLOR="#40F628">1688:</FONT>     
<FONT COLOR="#40F628">1689:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1690:</FONT> }
<FONT COLOR="#40F628">1691:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1692:</FONT> <FONT COLOR="#008000">// スキンモデルでない物の描画</FONT>
<FONT COLOR="#40F628">1693:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1694:</FONT> HRESULT CSkinModel::_DrawMeshContainerNoSkin(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1695:</FONT> {
<FONT COLOR="#40F628">1696:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1697:</FONT> 
<FONT COLOR="#40F628">1698:</FONT>     <FONT COLOR="#0000FF">for</FONT> (UINT it = 0; it &lt; pmcMesh-&gt;cpattr; it++) {
<FONT COLOR="#40F628">1699:</FONT>         m_pD3DDev-&gt;SetMaterial(&amp;(pmcMesh-&gt;rgMaterials[it]));
<FONT COLOR="#40F628">1700:</FONT>         m_pD3DDev-&gt;SetTexture(0, pmcMesh-&gt;pTextures[it]);
<FONT COLOR="#40F628">1701:</FONT>         <FONT COLOR="#0000FF">if</FONT>(FAILED(hr = pmcMesh-&gt;pMesh-&gt;DrawSubset( it ))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1702:</FONT>     }
<FONT COLOR="#40F628">1703:</FONT>     
<FONT COLOR="#40F628">1704:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1705:</FONT> }
<FONT COLOR="#40F628">1706:</FONT> 
<FONT COLOR="#40F628">1707:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1708:</FONT> <FONT COLOR="#008000">// D3DNONINDEXED</FONT>
<FONT COLOR="#40F628">1709:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1710:</FONT> HRESULT CSkinModel::_DrawMeshContainerNonIndexed(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1711:</FONT> {
<FONT COLOR="#40F628">1712:</FONT>     UINT ipattr;
<FONT COLOR="#40F628">1713:</FONT>     LPDIRECT3DDEVICE8   pD3DDev = m_pD3DDev;
<FONT COLOR="#40F628">1714:</FONT>     LPD3DXBONECOMBINATION pBoneComb;
<FONT COLOR="#40F628">1715:</FONT>     DWORD AttribIdPrev;
<FONT COLOR="#40F628">1716:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1717:</FONT> 
<FONT COLOR="#40F628">1718:</FONT>     AttribIdPrev = UNUSED32; 
<FONT COLOR="#40F628">1719:</FONT>     pBoneComb = <FONT COLOR="#0000FF">reinterpret_cast</FONT>&lt;LPD3DXBONECOMBINATION&gt;(pmcMesh-&gt;m_pBoneCombinationBuf-&gt;GetBufferPointer());
<FONT COLOR="#40F628">1720:</FONT>     <FONT COLOR="#008000">// Draw using default vtx processing of the device (typically HW)</FONT>
<FONT COLOR="#40F628">1721:</FONT>     <FONT COLOR="#0000FF">for</FONT> (ipattr = 0; ipattr &lt; pmcMesh-&gt;cpattr; ipattr++) {
<FONT COLOR="#40F628">1722:</FONT>         DWORD numBlend = 0;
<FONT COLOR="#40F628">1723:</FONT>         <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; pmcMesh-&gt;m_maxFaceInfl; ++i) {
<FONT COLOR="#40F628">1724:</FONT>             <FONT COLOR="#0000FF">if</FONT> (pBoneComb[ipattr].BoneId[i] != UINT_MAX) {
<FONT COLOR="#40F628">1725:</FONT>                 numBlend = i;
<FONT COLOR="#40F628">1726:</FONT>             }
<FONT COLOR="#40F628">1727:</FONT>         }
<FONT COLOR="#40F628">1728:</FONT> 
<FONT COLOR="#40F628">1729:</FONT>         <FONT COLOR="#0000FF">if</FONT> (m_d3dCaps.MaxVertexBlendMatrices &gt;= numBlend + 1) {
<FONT COLOR="#40F628">1730:</FONT>             <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; pmcMesh-&gt;m_maxFaceInfl; ++i) {
<FONT COLOR="#40F628">1731:</FONT>                 DWORD matid = pBoneComb[ipattr].BoneId[i];
<FONT COLOR="#40F628">1732:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (matid != UINT_MAX) {
<FONT COLOR="#40F628">1733:</FONT>                     m_pD3DDev-&gt;SetTransform(D3DTS_WORLDMATRIX(i), pmcMesh-&gt;m_pBoneMatrix[matid]);
<FONT COLOR="#40F628">1734:</FONT>                     m_pD3DDev-&gt;MultiplyTransform(D3DTS_WORLDMATRIX(i), &amp;pmcMesh-&gt;m_pBoneOffsetMat[matid]);
<FONT COLOR="#40F628">1735:</FONT>                 }
<FONT COLOR="#40F628">1736:</FONT>             }
<FONT COLOR="#40F628">1737:</FONT> 
<FONT COLOR="#40F628">1738:</FONT>             m_pD3DDev-&gt;SetRenderState(D3DRS_VERTEXBLEND, numBlend);
<FONT COLOR="#40F628">1739:</FONT> 
<FONT COLOR="#40F628">1740:</FONT>             <FONT COLOR="#0000FF">if</FONT> ((AttribIdPrev != pBoneComb[ipattr].AttribId) || (AttribIdPrev == UNUSED32)) {
<FONT COLOR="#40F628">1741:</FONT>                 m_pD3DDev-&gt;SetMaterial(&amp;(pmcMesh-&gt;rgMaterials[pBoneComb[ipattr].AttribId]));
<FONT COLOR="#40F628">1742:</FONT>                 m_pD3DDev-&gt;SetTexture(0, pmcMesh-&gt;pTextures[pBoneComb[ipattr].AttribId]);
<FONT COLOR="#40F628">1743:</FONT>                 AttribIdPrev = pBoneComb[ipattr].AttribId;
<FONT COLOR="#40F628">1744:</FONT>             }
<FONT COLOR="#40F628">1745:</FONT> 
<FONT COLOR="#40F628">1746:</FONT>             hr = pmcMesh-&gt;pMesh-&gt;DrawSubset( ipattr );
<FONT COLOR="#40F628">1747:</FONT>             <FONT COLOR="#0000FF">if</FONT>(FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1748:</FONT>         }
<FONT COLOR="#40F628">1749:</FONT>     }
<FONT COLOR="#40F628">1750:</FONT> 
<FONT COLOR="#40F628">1751:</FONT>     <FONT COLOR="#008000">// If necessary, draw parts that HW could not handle using SW</FONT>
<FONT COLOR="#40F628">1752:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;iAttrSplit &lt; pmcMesh-&gt;cpattr) {
<FONT COLOR="#40F628">1753:</FONT>         AttribIdPrev = UNUSED32; 
<FONT COLOR="#40F628">1754:</FONT>         m_pD3DDev-&gt;SetRenderState(D3DRS_SOFTWAREVERTEXPROCESSING, TRUE);
<FONT COLOR="#40F628">1755:</FONT>         <FONT COLOR="#0000FF">for</FONT> (ipattr = pmcMesh-&gt;iAttrSplit; ipattr &lt; pmcMesh-&gt;cpattr; ipattr++) {
<FONT COLOR="#40F628">1756:</FONT>             DWORD numBlend = 0;
<FONT COLOR="#40F628">1757:</FONT>             <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; pmcMesh-&gt;m_maxFaceInfl; ++i) {
<FONT COLOR="#40F628">1758:</FONT>                 <FONT COLOR="#0000FF">if</FONT> (pBoneComb[ipattr].BoneId[i] != UINT_MAX) {
<FONT COLOR="#40F628">1759:</FONT>                     numBlend = i;
<FONT COLOR="#40F628">1760:</FONT>                 }
<FONT COLOR="#40F628">1761:</FONT>             }
<FONT COLOR="#40F628">1762:</FONT> 
<FONT COLOR="#40F628">1763:</FONT>             <FONT COLOR="#0000FF">if</FONT> (m_d3dCaps.MaxVertexBlendMatrices &lt; numBlend + 1) {
<FONT COLOR="#40F628">1764:</FONT>                 <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; pmcMesh-&gt;m_maxFaceInfl; ++i) {
<FONT COLOR="#40F628">1765:</FONT>                     DWORD matid = pBoneComb[ipattr].BoneId[i];
<FONT COLOR="#40F628">1766:</FONT>                     <FONT COLOR="#0000FF">if</FONT> (matid != UINT_MAX) {
<FONT COLOR="#40F628">1767:</FONT>                         m_pD3DDev-&gt;SetTransform(D3DTS_WORLDMATRIX(i), pmcMesh-&gt;m_pBoneMatrix[matid]);
<FONT COLOR="#40F628">1768:</FONT>                         m_pD3DDev-&gt;MultiplyTransform(D3DTS_WORLDMATRIX(i), &amp;pmcMesh-&gt;m_pBoneOffsetMat[matid]);
<FONT COLOR="#40F628">1769:</FONT>                     }
<FONT COLOR="#40F628">1770:</FONT>                 }
<FONT COLOR="#40F628">1771:</FONT> 
<FONT COLOR="#40F628">1772:</FONT>                 m_pD3DDev-&gt;SetRenderState(D3DRS_VERTEXBLEND, numBlend);
<FONT COLOR="#40F628">1773:</FONT> 
<FONT COLOR="#40F628">1774:</FONT>                 <FONT COLOR="#0000FF">if</FONT> ((AttribIdPrev != pBoneComb[ipattr].AttribId) || (AttribIdPrev == UNUSED32)) {
<FONT COLOR="#40F628">1775:</FONT>                     m_pD3DDev-&gt;SetMaterial(&amp;(pmcMesh-&gt;rgMaterials[pBoneComb[ipattr].AttribId]));
<FONT COLOR="#40F628">1776:</FONT>                     m_pD3DDev-&gt;SetTexture(0, pmcMesh-&gt;pTextures[pBoneComb[ipattr].AttribId]);
<FONT COLOR="#40F628">1777:</FONT>                     AttribIdPrev = pBoneComb[ipattr].AttribId;
<FONT COLOR="#40F628">1778:</FONT>                 }
<FONT COLOR="#40F628">1779:</FONT> 
<FONT COLOR="#40F628">1780:</FONT>                 hr = pmcMesh-&gt;pMesh-&gt;DrawSubset( ipattr );
<FONT COLOR="#40F628">1781:</FONT>                 <FONT COLOR="#0000FF">if</FONT>(FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1782:</FONT>             }
<FONT COLOR="#40F628">1783:</FONT>         }
<FONT COLOR="#40F628">1784:</FONT>         m_pD3DDev-&gt;SetRenderState(D3DRS_SOFTWAREVERTEXPROCESSING, FALSE);
<FONT COLOR="#40F628">1785:</FONT>     }
<FONT COLOR="#40F628">1786:</FONT>     m_pD3DDev-&gt;SetRenderState(D3DRS_VERTEXBLEND, 0);
<FONT COLOR="#40F628">1787:</FONT>     
<FONT COLOR="#40F628">1788:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1789:</FONT> }
<FONT COLOR="#40F628">1790:</FONT> 
<FONT COLOR="#40F628">1791:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1792:</FONT> <FONT COLOR="#008000">// D3DINDEXEDVS</FONT>
<FONT COLOR="#40F628">1793:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1794:</FONT> HRESULT CSkinModel::_DrawMeshContainerIndexedVs(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1795:</FONT> {
<FONT COLOR="#40F628">1796:</FONT>     UINT ipattr;
<FONT COLOR="#40F628">1797:</FONT>     LPDIRECT3DDEVICE8   pD3DDev = m_pD3DDev;
<FONT COLOR="#40F628">1798:</FONT>     LPD3DXBONECOMBINATION pBoneComb;
<FONT COLOR="#40F628">1799:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1800:</FONT> 
<FONT COLOR="#40F628">1801:</FONT>     D3DXVECTOR4 vConst( 1.0f, 0.0f, 0.0f, 765.01f );
<FONT COLOR="#40F628">1802:</FONT>     LPDIRECT3DVERTEXBUFFER8 pVB;
<FONT COLOR="#40F628">1803:</FONT>     LPDIRECT3DINDEXBUFFER8 pIB;
<FONT COLOR="#40F628">1804:</FONT> 
<FONT COLOR="#40F628">1805:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_bUseSW) {<FONT COLOR="#008000">// 描画できない時はソフトウェアT&amp;Lで描画</FONT>
<FONT COLOR="#40F628">1806:</FONT>         m_pD3DDev-&gt;SetRenderState(D3DRS_SOFTWAREVERTEXPROCESSING, TRUE);
<FONT COLOR="#40F628">1807:</FONT>     }
<FONT COLOR="#40F628">1808:</FONT> 
<FONT COLOR="#40F628">1809:</FONT>     <FONT COLOR="#008000">// 頂点、インデックスバッファの設定</FONT>
<FONT COLOR="#40F628">1810:</FONT>     pmcMesh-&gt;pMesh-&gt;GetVertexBuffer(&amp;pVB);
<FONT COLOR="#40F628">1811:</FONT>     pmcMesh-&gt;pMesh-&gt;GetIndexBuffer(&amp;pIB);
<FONT COLOR="#40F628">1812:</FONT>     <FONT COLOR="#0000FF">if</FONT>(FAILED(hr = m_pD3DDev-&gt;SetStreamSource(0, pVB, D3DXGetFVFVertexSize(pmcMesh-&gt;pMesh-&gt;GetFVF()))))<FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1813:</FONT>     <FONT COLOR="#0000FF">if</FONT>(FAILED(hr = m_pD3DDev-&gt;SetIndices(pIB, 0)))<FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1814:</FONT>     pVB-&gt;Release();
<FONT COLOR="#40F628">1815:</FONT>     pIB-&gt;Release();
<FONT COLOR="#40F628">1816:</FONT> 
<FONT COLOR="#40F628">1817:</FONT>     <FONT COLOR="#008000">// 混ぜている行列の個数に応じて、シェーダーを切り替える</FONT>
<FONT COLOR="#40F628">1818:</FONT>     <FONT COLOR="#0000FF">if</FONT>(FAILED(hr = m_pD3DDev-&gt;SetVertexShader(m_dwIndexedVertexShader[pmcMesh-&gt;m_maxFaceInfl - 1])))<FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1819:</FONT> 
<FONT COLOR="#40F628">1820:</FONT>     pBoneComb = <FONT COLOR="#0000FF">reinterpret_cast</FONT>&lt;LPD3DXBONECOMBINATION&gt;(pmcMesh-&gt;m_pBoneCombinationBuf-&gt;GetBufferPointer());
<FONT COLOR="#40F628">1821:</FONT>     <FONT COLOR="#0000FF">for</FONT> (ipattr = 0; ipattr &lt; pmcMesh-&gt;cpattr; ipattr++){
<FONT COLOR="#40F628">1822:</FONT>         <FONT COLOR="#008000">// ビュー行列をかけて、ボーンの行列を設定する</FONT>
<FONT COLOR="#40F628">1823:</FONT>         <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; pmcMesh-&gt;m_paletteSize; ++i){
<FONT COLOR="#40F628">1824:</FONT>             DWORD matid = pBoneComb[ipattr].BoneId[i];
<FONT COLOR="#40F628">1825:</FONT>             <FONT COLOR="#0000FF">if</FONT> (matid != UINT_MAX){
<FONT COLOR="#40F628">1826:</FONT>                 D3DXMATRIXA16 mat;
<FONT COLOR="#40F628">1827:</FONT>                 D3DXMatrixMultiply(&amp;mat, &amp;pmcMesh-&gt;m_pBoneOffsetMat[matid], pmcMesh-&gt;m_pBoneMatrix[matid]);
<FONT COLOR="#40F628">1828:</FONT>                 D3DXMatrixMultiplyTranspose(&amp;mat, &amp;mat, &amp;m_View);
<FONT COLOR="#40F628">1829:</FONT>                 m_pD3DDev-&gt;SetVertexShaderConstant(i*3 + 9, &amp;mat, 3);
<FONT COLOR="#40F628">1830:</FONT>             }
<FONT COLOR="#40F628">1831:</FONT>         }
<FONT COLOR="#40F628">1832:</FONT> 
<FONT COLOR="#40F628">1833:</FONT>         <FONT COLOR="#008000">// 質感の設定</FONT>
<FONT COLOR="#40F628">1834:</FONT>         D3DXCOLOR ambEmm;
<FONT COLOR="#40F628">1835:</FONT>         D3DMATERIAL8 *pMaterial = &amp;pmcMesh-&gt;rgMaterials[pBoneComb[ipattr].AttribId];
<FONT COLOR="#40F628">1836:</FONT>         D3DXColorModulate(&amp;ambEmm, &amp;D3DXCOLOR(pMaterial-&gt;Ambient),&amp;D3DXCOLOR(.25, .25, .25, 1.0));
<FONT COLOR="#40F628">1837:</FONT>         ambEmm += D3DXCOLOR(pMaterial-&gt;Emissive);
<FONT COLOR="#40F628">1838:</FONT>         m_pD3DDev-&gt;SetVertexShaderConstant(8, &amp;(pMaterial-&gt;Diffuse), 1);<FONT COLOR="#008000">// 平行光源</FONT>
<FONT COLOR="#40F628">1839:</FONT>         m_pD3DDev-&gt;SetVertexShaderConstant(7, &amp;ambEmm, 1);              <FONT COLOR="#008000">// 環境光</FONT>
<FONT COLOR="#40F628">1840:</FONT>         vConst.y = pMaterial-&gt;Power;
<FONT COLOR="#40F628">1841:</FONT>         m_pD3DDev-&gt;SetVertexShaderConstant(0, &amp;vConst, 1);<FONT COLOR="#008000">// すぺきゅらー</FONT>
<FONT COLOR="#40F628">1842:</FONT>         <FONT COLOR="#008000">// テクスチャーの設定</FONT>
<FONT COLOR="#40F628">1843:</FONT>         m_pD3DDev-&gt;SetTexture(0, pmcMesh-&gt;pTextures[pBoneComb[ipattr].AttribId]);
<FONT COLOR="#40F628">1844:</FONT>         <FONT COLOR="#008000">// 実際の描画</FONT>
<FONT COLOR="#40F628">1845:</FONT>         hr = m_pD3DDev-&gt;DrawIndexedPrimitive(D3DPT_TRIANGLELIST, 
<FONT COLOR="#40F628">1846:</FONT>                                      pBoneComb[ipattr].VertexStart, pBoneComb[ipattr].VertexCount,
<FONT COLOR="#40F628">1847:</FONT>                                      pBoneComb[ipattr].FaceStart * 3, pBoneComb[ipattr].FaceCount);
<FONT COLOR="#40F628">1848:</FONT>         <FONT COLOR="#0000FF">if</FONT>(FAILED(hr))  <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1849:</FONT>     }
<FONT COLOR="#40F628">1850:</FONT>     
<FONT COLOR="#40F628">1851:</FONT>     <FONT COLOR="#008000">// ソフトウェアT&amp;Lの時を戻す</FONT>
<FONT COLOR="#40F628">1852:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_bUseSW) {
<FONT COLOR="#40F628">1853:</FONT>         m_pD3DDev-&gt;SetRenderState(D3DRS_SOFTWAREVERTEXPROCESSING, FALSE);
<FONT COLOR="#40F628">1854:</FONT>     }
<FONT COLOR="#40F628">1855:</FONT> 
<FONT COLOR="#40F628">1856:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1857:</FONT> }
<FONT COLOR="#40F628">1858:</FONT> 
<FONT COLOR="#40F628">1859:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1860:</FONT> <FONT COLOR="#008000">// D3DINDEXED</FONT>
<FONT COLOR="#40F628">1861:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1862:</FONT> HRESULT CSkinModel::_DrawMeshContainerIndexed(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1863:</FONT> {
<FONT COLOR="#40F628">1864:</FONT>     UINT ipattr;
<FONT COLOR="#40F628">1865:</FONT>     LPDIRECT3DDEVICE8   pD3DDev = m_pD3DDev;
<FONT COLOR="#40F628">1866:</FONT>     LPD3DXBONECOMBINATION pBoneComb;
<FONT COLOR="#40F628">1867:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1868:</FONT>     
<FONT COLOR="#40F628">1869:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_bUseSW) {
<FONT COLOR="#40F628">1870:</FONT>         pD3DDev-&gt;SetRenderState(D3DRS_SOFTWAREVERTEXPROCESSING, TRUE);
<FONT COLOR="#40F628">1871:</FONT>     }
<FONT COLOR="#40F628">1872:</FONT> 
<FONT COLOR="#40F628">1873:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_maxFaceInfl == 1){
<FONT COLOR="#40F628">1874:</FONT>         pD3DDev-&gt;SetRenderState(D3DRS_VERTEXBLEND, D3DVBF_0WEIGHTS);
<FONT COLOR="#40F628">1875:</FONT>     }<FONT COLOR="#0000FF">else</FONT>{
<FONT COLOR="#40F628">1876:</FONT>         pD3DDev-&gt;SetRenderState(D3DRS_VERTEXBLEND, pmcMesh-&gt;m_maxFaceInfl - 1);
<FONT COLOR="#40F628">1877:</FONT>     }
<FONT COLOR="#40F628">1878:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_maxFaceInfl) pD3DDev-&gt;SetRenderState(D3DRS_INDEXEDVERTEXBLENDENABLE, TRUE);
<FONT COLOR="#40F628">1879:</FONT>     pBoneComb = <FONT COLOR="#0000FF">reinterpret_cast</FONT>&lt;LPD3DXBONECOMBINATION&gt;(pmcMesh-&gt;m_pBoneCombinationBuf-&gt;GetBufferPointer());
<FONT COLOR="#40F628">1880:</FONT>     <FONT COLOR="#0000FF">for</FONT> (ipattr = 0; ipattr &lt; pmcMesh-&gt;cpattr; ipattr++) {
<FONT COLOR="#40F628">1881:</FONT>         <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; pmcMesh-&gt;m_paletteSize; ++i) {
<FONT COLOR="#40F628">1882:</FONT>             DWORD matid = pBoneComb[ipattr].BoneId[i];
<FONT COLOR="#40F628">1883:</FONT>             <FONT COLOR="#0000FF">if</FONT> (matid != UINT_MAX) {
<FONT COLOR="#40F628">1884:</FONT>                 pD3DDev-&gt;SetTransform(D3DTS_WORLDMATRIX(i), pmcMesh-&gt;m_pBoneMatrix[matid]);
<FONT COLOR="#40F628">1885:</FONT>                 pD3DDev-&gt;MultiplyTransform(D3DTS_WORLDMATRIX(i), &amp;pmcMesh-&gt;m_pBoneOffsetMat[matid]);
<FONT COLOR="#40F628">1886:</FONT>             }
<FONT COLOR="#40F628">1887:</FONT>         }
<FONT COLOR="#40F628">1888:</FONT>         
<FONT COLOR="#40F628">1889:</FONT>         pD3DDev-&gt;SetMaterial(&amp;(pmcMesh-&gt;rgMaterials[pBoneComb[ipattr].AttribId]));
<FONT COLOR="#40F628">1890:</FONT>         pD3DDev-&gt;SetTexture(0, pmcMesh-&gt;pTextures[pBoneComb[ipattr].AttribId]);
<FONT COLOR="#40F628">1891:</FONT> 
<FONT COLOR="#40F628">1892:</FONT>         <FONT COLOR="#0000FF">if</FONT>(FAILED(hr = pmcMesh-&gt;pMesh-&gt;DrawSubset( ipattr )))<FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1893:</FONT>     }
<FONT COLOR="#40F628">1894:</FONT>     pD3DDev-&gt;SetRenderState(D3DRS_INDEXEDVERTEXBLENDENABLE, FALSE);
<FONT COLOR="#40F628">1895:</FONT>     pD3DDev-&gt;SetRenderState(D3DRS_VERTEXBLEND, 0);
<FONT COLOR="#40F628">1896:</FONT> 
<FONT COLOR="#40F628">1897:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pmcMesh-&gt;m_bUseSW) {
<FONT COLOR="#40F628">1898:</FONT>         pD3DDev-&gt;SetRenderState(D3DRS_SOFTWAREVERTEXPROCESSING, FALSE);
<FONT COLOR="#40F628">1899:</FONT>     }
<FONT COLOR="#40F628">1900:</FONT> 
<FONT COLOR="#40F628">1901:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1902:</FONT> }
<FONT COLOR="#40F628">1903:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1904:</FONT> <FONT COLOR="#008000">// SOFTWARE</FONT>
<FONT COLOR="#40F628">1905:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1906:</FONT> HRESULT CSkinModel::_DrawMeshContainerSoftware(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1907:</FONT> {
<FONT COLOR="#40F628">1908:</FONT>     D3DXMATRIX  Identity;
<FONT COLOR="#40F628">1909:</FONT>     DWORD      cBones  = pmcMesh-&gt;m_pSkinMesh-&gt;GetNumBones();
<FONT COLOR="#40F628">1910:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1911:</FONT> 
<FONT COLOR="#40F628">1912:</FONT>     <FONT COLOR="#008000">// ボーンの行列を設定する</FONT>
<FONT COLOR="#40F628">1913:</FONT>     <FONT COLOR="#0000FF">for</FONT> (DWORD i = 0; i &lt; cBones; ++i){
<FONT COLOR="#40F628">1914:</FONT>         D3DXMatrixMultiply (&amp;m_pBoneMatrices[i],&amp;pmcMesh-&gt;m_pBoneOffsetMat[i], pmcMesh-&gt;m_pBoneMatrix[i]);
<FONT COLOR="#40F628">1915:</FONT>     }
<FONT COLOR="#40F628">1916:</FONT> 
<FONT COLOR="#40F628">1917:</FONT>     <FONT COLOR="#008000">// ワールド座標を設定する</FONT>
<FONT COLOR="#40F628">1918:</FONT>     D3DXMatrixIdentity(&amp;Identity);
<FONT COLOR="#40F628">1919:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = m_pD3DDev-&gt;SetTransform(D3DTS_WORLD, &amp;Identity))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1920:</FONT> 
<FONT COLOR="#40F628">1921:</FONT>     <FONT COLOR="#008000">// スキン構造を作成する</FONT>
<FONT COLOR="#40F628">1922:</FONT>     <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = pmcMesh-&gt;m_pSkinMesh-&gt;UpdateSkinnedMesh(m_pBoneMatrices, NULL, pmcMesh-&gt;pMesh)))<FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1923:</FONT> 
<FONT COLOR="#40F628">1924:</FONT>     <FONT COLOR="#008000">// 属性やテクスチャーを設定して実際に描画</FONT>
<FONT COLOR="#40F628">1925:</FONT>     <FONT COLOR="#0000FF">for</FONT> (<FONT COLOR="#0000FF">unsigned</FONT> <FONT COLOR="#0000FF">long</FONT> ipattr = 0; ipattr &lt; pmcMesh-&gt;cpattr; ipattr++) {
<FONT COLOR="#40F628">1926:</FONT>         <FONT COLOR="#0000FF">int</FONT> id = pmcMesh-&gt;m_pAttrTable[ipattr].AttribId;
<FONT COLOR="#40F628">1927:</FONT>         m_pD3DDev-&gt;SetMaterial(&amp;(pmcMesh-&gt;rgMaterials[id]));
<FONT COLOR="#40F628">1928:</FONT>         m_pD3DDev-&gt;SetTexture(0, pmcMesh-&gt;pTextures[id]);
<FONT COLOR="#40F628">1929:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr=pmcMesh-&gt;pMesh-&gt;DrawSubset(id))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1930:</FONT>     }
<FONT COLOR="#40F628">1931:</FONT>     
<FONT COLOR="#40F628">1932:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1933:</FONT> }
<FONT COLOR="#40F628">1934:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1935:</FONT> <FONT COLOR="#008000">// 各メッシュの描画</FONT>
<FONT COLOR="#40F628">1936:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1937:</FONT> HRESULT CSkinModel::_DrawMeshContainer(SMeshContainer *pmcMesh)
<FONT COLOR="#40F628">1938:</FONT> {
<FONT COLOR="#40F628">1939:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1940:</FONT> 
<FONT COLOR="#40F628">1941:</FONT>     <FONT COLOR="#008000">// スキンじゃないモデル</FONT>
<FONT COLOR="#40F628">1942:</FONT>     <FONT COLOR="#0000FF">if</FONT> (! pmcMesh-&gt;m_pSkinMesh) <FONT COLOR="#0000FF">return</FONT> _DrawMeshContainerNoSkin(pmcMesh);
<FONT COLOR="#40F628">1943:</FONT>     
<FONT COLOR="#40F628">1944:</FONT>     <FONT COLOR="#008000">// 描画方法が切り変わったらメッシュを生成しなおす</FONT>
<FONT COLOR="#40F628">1945:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_method != pmcMesh-&gt;m_Method) <FONT COLOR="#0000FF">this</FONT>-&gt;GenerateMesh(pmcMesh);
<FONT COLOR="#40F628">1946:</FONT>     
<FONT COLOR="#40F628">1947:</FONT>     <FONT COLOR="#008000">// それぞれの手法に応じてそれぞれ描画</FONT>
<FONT COLOR="#40F628">1948:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_method == D3DNONINDEXED) <FONT COLOR="#0000FF">return</FONT> _DrawMeshContainerNonIndexed(pmcMesh);
<FONT COLOR="#40F628">1949:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_method == D3DINDEXEDVS ) <FONT COLOR="#0000FF">return</FONT> _DrawMeshContainerIndexedVs (pmcMesh);
<FONT COLOR="#40F628">1950:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_method == D3DINDEXED   ) <FONT COLOR="#0000FF">return</FONT> _DrawMeshContainerIndexed   (pmcMesh);
<FONT COLOR="#40F628">1951:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_method == SOFTWARE     ) <FONT COLOR="#0000FF">return</FONT> _DrawMeshContainerSoftware  (pmcMesh);
<FONT COLOR="#40F628">1952:</FONT>     
<FONT COLOR="#40F628">1953:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1954:</FONT> }
<FONT COLOR="#40F628">1955:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1956:</FONT> <FONT COLOR="#008000">// メッシュの描画</FONT>
<FONT COLOR="#40F628">1957:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1958:</FONT> HRESULT CSkinModel::_DrawFrames(SFrame *pframe, UINT &amp;cTriangles)
<FONT COLOR="#40F628">1959:</FONT> {
<FONT COLOR="#40F628">1960:</FONT>     HRESULT hr = S_OK;
<FONT COLOR="#40F628">1961:</FONT>     LPDIRECT3DDEVICE8   pD3DDev = m_pD3DDev;
<FONT COLOR="#40F628">1962:</FONT> 
<FONT COLOR="#40F628">1963:</FONT>     <FONT COLOR="#008000">// ワールド行列の生成</FONT>
<FONT COLOR="#40F628">1964:</FONT>     <FONT COLOR="#0000FF">if</FONT> (pframe-&gt;pmcMesh != NULL){
<FONT COLOR="#40F628">1965:</FONT>         hr = pD3DDev-&gt;SetTransform(D3DTS_WORLD, &amp;pframe-&gt;matCombined);
<FONT COLOR="#40F628">1966:</FONT>         <FONT COLOR="#0000FF">if</FONT>(FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1967:</FONT>     }
<FONT COLOR="#40F628">1968:</FONT>     <FONT COLOR="#008000">// 登録されているメッシュを表示</FONT>
<FONT COLOR="#40F628">1969:</FONT>     <FONT COLOR="#0000FF">for</FONT>(SMeshContainer *it=pframe-&gt;pmcMesh ; it ; it=it-&gt;pmcNext){
<FONT COLOR="#40F628">1970:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = _DrawMeshContainer(it)))<FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1971:</FONT>         cTriangles += it-&gt;pMesh-&gt;GetNumFaces();
<FONT COLOR="#40F628">1972:</FONT>     }
<FONT COLOR="#40F628">1973:</FONT>     <FONT COLOR="#008000">// 子供を次々に表示</FONT>
<FONT COLOR="#40F628">1974:</FONT>     <FONT COLOR="#0000FF">for</FONT>(SFrame *pChild=pframe-&gt;pframeFirstChild ; pChild ; pChild=pChild-&gt;pframeSibling){
<FONT COLOR="#40F628">1975:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = _DrawFrames(pChild, cTriangles))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1976:</FONT>     }
<FONT COLOR="#40F628">1977:</FONT> 
<FONT COLOR="#40F628">1978:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">1979:</FONT> }
<FONT COLOR="#40F628">1980:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1981:</FONT> <FONT COLOR="#008000">// 描画</FONT>
<FONT COLOR="#40F628">1982:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">1983:</FONT> HRESULT CSkinModel::Render()
<FONT COLOR="#40F628">1984:</FONT> {
<FONT COLOR="#40F628">1985:</FONT>     UINT cTriangles = 0;
<FONT COLOR="#40F628">1986:</FONT>     HRESULT hr;
<FONT COLOR="#40F628">1987:</FONT> 
<FONT COLOR="#40F628">1988:</FONT>     <FONT COLOR="#0000FF">if</FONT>(m_pdeMesh){
<FONT COLOR="#40F628">1989:</FONT>         <FONT COLOR="#008000">// 視点を設定する</FONT>
<FONT COLOR="#40F628">1990:</FONT>         m_pdeMesh-&gt;pframeRoot-&gt;matRot   = m_Rot;
<FONT COLOR="#40F628">1991:</FONT>         m_pdeMesh-&gt;pframeRoot-&gt;matTrans = m_Trans;
<FONT COLOR="#40F628">1992:</FONT>         
<FONT COLOR="#40F628">1993:</FONT>         <FONT COLOR="#008000">// ソフトウェアT&amp;Lのためにビュー行列を設定</FONT>
<FONT COLOR="#40F628">1994:</FONT>         hr = m_pD3DDev-&gt;SetTransform(D3DTS_VIEW, (D3DMATRIX*)&amp;m_View);
<FONT COLOR="#40F628">1995:</FONT>         <FONT COLOR="#0000FF">if</FONT>(FAILED(hr)) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">1996:</FONT> 
<FONT COLOR="#40F628">1997:</FONT>         D3DXMATRIXA16 mCur;
<FONT COLOR="#40F628">1998:</FONT>         D3DXMatrixIdentity(&amp;mCur);
<FONT COLOR="#40F628">1999:</FONT>         <FONT COLOR="#008000">// 動かす</FONT>
<FONT COLOR="#40F628">2000:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = m_pdeMesh-&gt;pframeRoot-&gt;UpdateFrames(mCur))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">2001:</FONT>         <FONT COLOR="#008000">// 描画する</FONT>
<FONT COLOR="#40F628">2002:</FONT>         <FONT COLOR="#0000FF">if</FONT> (FAILED(hr = _DrawFrames(m_pdeMesh-&gt;pframeRoot, cTriangles))) <FONT COLOR="#0000FF">return</FONT> hr;
<FONT COLOR="#40F628">2003:</FONT>     }
<FONT COLOR="#40F628">2004:</FONT> 
<FONT COLOR="#40F628">2005:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">2006:</FONT> }
<FONT COLOR="#40F628">2007:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2008:</FONT> <FONT COLOR="#008000">// 最後の時やデバイスが変更されたとき等に呼ばれる</FONT>
<FONT COLOR="#40F628">2009:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2010:</FONT> HRESULT CSkinModel::Release()
<FONT COLOR="#40F628">2011:</FONT> {
<FONT COLOR="#40F628">2012:</FONT>     _InvalidateDeviceObjects();
<FONT COLOR="#40F628">2013:</FONT>     _DeleteDeviceObjects();
<FONT COLOR="#40F628">2014:</FONT>     
<FONT COLOR="#40F628">2015:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">2016:</FONT> }
<FONT COLOR="#40F628">2017:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2018:</FONT> <FONT COLOR="#008000">// 最後の時やデバイスが変更されたとき等に呼ばれる</FONT>
<FONT COLOR="#40F628">2019:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2020:</FONT> HRESULT CSkinModel::_InvalidateDeviceObjects()
<FONT COLOR="#40F628">2021:</FONT> {
<FONT COLOR="#40F628">2022:</FONT>     <FONT COLOR="#0000FF">if</FONT>(m_pdeMesh) m_pdeMesh-&gt;pframeRoot-&gt;ReleaseDeviceDependentMeshes();
<FONT COLOR="#40F628">2023:</FONT> 
<FONT COLOR="#40F628">2024:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">2025:</FONT> }
<FONT COLOR="#40F628">2026:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2027:</FONT> <FONT COLOR="#008000">// 最後の時やデバイスが変更されたとき等に呼ばれる</FONT>
<FONT COLOR="#40F628">2028:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2029:</FONT> HRESULT CSkinModel::_DeleteDeviceObjects()
<FONT COLOR="#40F628">2030:</FONT> {
<FONT COLOR="#40F628">2031:</FONT>     <FONT COLOR="#0000FF">if</FONT>(m_pdeMesh) <FONT COLOR="#0000FF">delete</FONT> m_pdeMesh; m_pdeMesh = NULL;
<FONT COLOR="#40F628">2032:</FONT>     
<FONT COLOR="#40F628">2033:</FONT>     <FONT COLOR="#0000FF">delete</FONT> [] m_pBoneMatrices;
<FONT COLOR="#40F628">2034:</FONT> 
<FONT COLOR="#40F628">2035:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">2036:</FONT> }
<FONT COLOR="#40F628">2037:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2038:</FONT> <FONT COLOR="#008000">// メッシュとして確保したメモリを開放する</FONT>
<FONT COLOR="#40F628">2039:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2040:</FONT> <FONT COLOR="#0000FF">void</FONT> SFrame::ReleaseDeviceDependentMeshes()
<FONT COLOR="#40F628">2041:</FONT> {
<FONT COLOR="#40F628">2042:</FONT>     <FONT COLOR="#0000FF">if</FONT> (<FONT COLOR="#0000FF">this</FONT>-&gt;pmcMesh != NULL){
<FONT COLOR="#40F628">2043:</FONT>         <FONT COLOR="#0000FF">for</FONT> (SMeshContainer* pmcCurr = <FONT COLOR="#0000FF">this</FONT>-&gt;pmcMesh; pmcCurr != NULL; pmcCurr = pmcCurr-&gt;pmcNext){
<FONT COLOR="#40F628">2044:</FONT>             <FONT COLOR="#0000FF">if</FONT> (pmcCurr-&gt;m_pSkinMesh != NULL){
<FONT COLOR="#40F628">2045:</FONT>                 RELEASE(pmcCurr-&gt;pMesh);
<FONT COLOR="#40F628">2046:</FONT> 
<FONT COLOR="#40F628">2047:</FONT>                 pmcCurr-&gt;m_Method = NONE;
<FONT COLOR="#40F628">2048:</FONT>             }
<FONT COLOR="#40F628">2049:</FONT>         }
<FONT COLOR="#40F628">2050:</FONT>     }
<FONT COLOR="#40F628">2051:</FONT> 
<FONT COLOR="#40F628">2052:</FONT>     <FONT COLOR="#008000">// 子供や子供兄弟を次々に削除</FONT>
<FONT COLOR="#40F628">2053:</FONT>     <FONT COLOR="#0000FF">if</FONT> (<FONT COLOR="#0000FF">this</FONT>-&gt;pframeFirstChild != NULL)
<FONT COLOR="#40F628">2054:</FONT>         <FONT COLOR="#0000FF">this</FONT>-&gt;pframeFirstChild-&gt;ReleaseDeviceDependentMeshes();
<FONT COLOR="#40F628">2055:</FONT> 
<FONT COLOR="#40F628">2056:</FONT>     <FONT COLOR="#0000FF">if</FONT> (<FONT COLOR="#0000FF">this</FONT>-&gt;pframeSibling != NULL)
<FONT COLOR="#40F628">2057:</FONT>         <FONT COLOR="#0000FF">this</FONT>-&gt;pframeSibling-&gt;ReleaseDeviceDependentMeshes();
<FONT COLOR="#40F628">2058:</FONT> }
<FONT COLOR="#40F628">2059:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2060:</FONT> <FONT COLOR="#008000">// 現在選択されているメッシュの削除</FONT>
<FONT COLOR="#40F628">2061:</FONT> <FONT COLOR="#008000">//-----------------------------------------------------------------------------</FONT>
<FONT COLOR="#40F628">2062:</FONT> HRESULT  CSkinModel::_DeleteSelectedMesh()
<FONT COLOR="#40F628">2063:</FONT> {
<FONT COLOR="#40F628">2064:</FONT>     <FONT COLOR="#0000FF">if</FONT> (m_pdeMesh != NULL) {
<FONT COLOR="#40F628">2065:</FONT>         <FONT COLOR="#0000FF">delete</FONT> m_pdeMesh;
<FONT COLOR="#40F628">2066:</FONT>         m_pdeMesh = NULL;
<FONT COLOR="#40F628">2067:</FONT>     }
<FONT COLOR="#40F628">2068:</FONT> 
<FONT COLOR="#40F628">2069:</FONT>     <FONT COLOR="#0000FF">return</FONT> S_OK;
<FONT COLOR="#40F628">2070:</FONT> }
<FONT COLOR="#40F628">2071:</FONT> </PRE>
</BODY>
</HTML>
